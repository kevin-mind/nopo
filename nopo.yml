name: Nopo Project

os:
  base:
    image: node:22.16.0-slim
  dependencies:
    build-essential: ""
    jq: ""
    curl: ""
  user:
    uid: 1001
    gid: 1001
    home: /home/nopoapp

services:
  dirs:
    - ./apps
    - ./packages
    - ./.github

root_name: root

root:
  commands:
    # Root-level compilation - nopo/scripts and github-actions
    compile:
      commands:
        nopo:
          command: pnpm exec vite build
          dir: ./nopo/scripts
        actions:
          command: pnpm exec tsx scripts/build.ts
          dir: ./.github/actions-ts
        # Build all packages (for npm publishing)
        packages: pnpm run -r --filter "./packages/*" build
    # Build prompts + all GitHub Actions (actions-ts + statemachine)
    setup-github:
      dependencies:
        prompts:
          - compile
      commands:
        actions-ts:
          command: pnpm exec tsx scripts/build.ts
          dir: ./.github/actions-ts
        statemachine:
          command: pnpm exec tsx scripts/build-actions.ts
          dir: ./packages/statemachine
    # Root-level cleaning
    clean:
      commands:
        nopo:
          command: rm -rf node_modules build
          dir: ./nopo/scripts
        actions:
          command: rm -rf */dist
          dir: ./.github/actions-ts
        root: rm -rf .cache .config .bash_history .env .local .pnpm-store .venv/* node_modules && rm -f build-metadata.json || true
    # Root-level checks (eslint, tsc, knip at project root level)
    check:
      commands:
        lint: pnpm exec eslint
        types: pnpm exec tsc --noEmit
        knip: pnpm exec knip
        actions:
          command: pnpm exec tsx scripts/build.ts && git diff --exit-code */dist/
          dir: ./.github/actions-ts
        actionlint: ./scripts/actionlint.sh
        nopo:
          command: pnpm exec tsc --noEmit
          dir: ./nopo/scripts
    # Root-level fixes
    fix:
      commands:
        lint: pnpm exec eslint --fix
        knip: pnpm exec knip --fix
    # Root-level tests
    test:
      commands:
        nopo:
          command: pnpm exec vitest run
          dir: ./nopo/scripts
        actions:
          command: pnpm exec vitest run
          dir: ./.github/actions-ts
    # Publishing via changesets
    publish:
      command: pnpm exec changeset publish
    # Playwright smoke tests
    smoketest:
      command: pnpm exec playwright test
