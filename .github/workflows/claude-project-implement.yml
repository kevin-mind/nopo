name: Claude Project Implement

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  check-ready:
    # Only trigger when 'ready' label is added
    if: github.event.label.name == 'ready'
    runs-on: ubuntu-latest
    outputs:
      should_implement: ${{ steps.check.outputs.should_implement }}
    steps:
      - name: Check if implementation needed
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Check if there's already a PR for this issue
          existing_pr=$(gh pr list --search "Fixes #$ISSUE_NUMBER in:body" --json number --jq '.[0].number' || true)

          if [[ -n "$existing_pr" && "$existing_pr" != "null" ]]; then
            echo "PR #$existing_pr already exists for issue #$ISSUE_NUMBER"
            echo "should_implement=false" >> $GITHUB_OUTPUT
          else
            echo "No existing PR found - proceeding with implementation"
            echo "should_implement=true" >> $GITHUB_OUTPUT
          fi

  implement:
    needs: check-ready
    if: needs.check-ready.outputs.should_implement == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@anthropic.com"

      - name: Add in-progress label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          gh issue edit "$ISSUE_NUMBER" --add-label "in-progress" --remove-label "ready" || true

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Implement issue #${{ github.event.issue.number }}: "${{ github.event.issue.title }}"

            Issue body:
            ${{ github.event.issue.body }}

            CRITICAL INSTRUCTIONS:

            1. CREATE BRANCH:
               - Create branch `feat/issue-${{ github.event.issue.number }}` from `main`
               - If branch already exists, switch to it and pull latest

            2. IMPLEMENT:
               - Follow the guidelines in CLAUDE.md strictly
               - Address all items in the Todo section
               - Keep changes focused and minimal

            3. VERIFY:
               - Run `make check` to validate linting and types
               - Run `make test` to run tests
               - Fix any failures before proceeding

            4. PUSH:
               - Push the branch to origin

            5. CREATE PR:
               - Use `gh pr create` to create a pull request
               - The PR body MUST contain "Fixes #${{ github.event.issue.number }}"
               - Include a detailed description of changes
               - Example PR body format:
                 ```
                 ## Summary
                 <description of changes>

                 ## Changes
                 - Change 1
                 - Change 2

                 Fixes #${{ github.event.issue.number }}
                 ```

            The "Fixes #N" pattern is REQUIRED for automatic issue linking and closure.
          claude_args: "--model claude-3-5-sonnet-latest --max-turns 30"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
