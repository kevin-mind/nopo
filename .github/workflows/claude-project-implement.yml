name: Claude Project Implement

on:
  projects_v2_item:
    types: [edited]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  check-ready:
    runs-on: ubuntu-latest
    outputs:
      should_implement: ${{ steps.decide.outputs.should_implement }}
      issue_number: ${{ steps.status.outputs.issue_number }}
      issue_title: ${{ steps.status.outputs.issue_title }}
      issue_body: ${{ steps.status.outputs.issue_body }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if status field changed
        id: field_check
        run: |
          # Only proceed if a field value changed
          if [[ -z "${{ github.event.changes.field_value }}" ]]; then
            echo "No field value change detected"
            echo "field_changed=false" >> $GITHUB_OUTPUT
          else
            echo "field_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Get project item status
        if: steps.field_check.outputs.field_changed == 'true'
        id: status
        uses: ./.github/actions/project-status
        with:
          action: get
          item_id: ${{ github.event.projects_v2_item.node_id }}
          token: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Determine if implementation needed
        id: decide
        run: |
          if [[ "${{ steps.field_check.outputs.field_changed }}" == "true" && "${{ steps.status.outputs.status }}" == "Ready" ]]; then
            echo "should_implement=true" >> $GITHUB_OUTPUT
          else
            echo "should_implement=false" >> $GITHUB_OUTPUT
          fi

  implement:
    needs: check-ready
    if: needs.check-ready.outputs.should_implement == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@anthropic.com"

      - name: Update project status to In Progress
        uses: ./.github/actions/project-status
        with:
          action: set
          item_id: ${{ github.event.projects_v2_item.node_id }}
          project_id: ${{ github.event.projects_v2_item.project_node_id }}
          target_status: "In Progress"
          token: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Implement issue #${{ needs.check-ready.outputs.issue_number }}: "${{ needs.check-ready.outputs.issue_title }}"

            Issue body:
            ${{ needs.check-ready.outputs.issue_body }}

            CRITICAL INSTRUCTIONS:

            1. CREATE BRANCH:
               - Create branch `feat/issue-${{ needs.check-ready.outputs.issue_number }}` from `main`
               - If branch already exists, switch to it and pull latest

            2. IMPLEMENT:
               - Follow the guidelines in CLAUDE.md strictly
               - Address all items in the Todo section
               - Keep changes focused and minimal

            3. VERIFY:
               - Run `make check` to validate linting and types
               - Run `make test` to run tests
               - Fix any failures before proceeding

            4. PUSH:
               - Push the branch to origin

            5. CREATE PR:
               - Use `gh pr create` to create a pull request
               - The PR body MUST contain "Fixes #${{ needs.check-ready.outputs.issue_number }}"
               - Include a detailed description of changes
               - Example PR body format:
                 ```
                 ## Summary
                 <description of changes>

                 ## Changes
                 - Change 1
                 - Change 2

                 Fixes #${{ needs.check-ready.outputs.issue_number }}
                 ```

            The "Fixes #N" pattern is REQUIRED for automatic issue linking and closure.
          claude_args: "--model claude-3-5-sonnet-latest --max-turns 30"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
