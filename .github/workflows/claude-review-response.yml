name: Claude Review Response

on:
  pull_request_review:
    types: [submitted]

concurrency:
  group: claude-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  respond-to-review:
    runs-on: ubuntu-latest
    # Only run when Claude submits a review on a ready PR (not approvals, not drafts)
    if: |
      github.event.review.user.login == 'claude[bot]' &&
      github.event.pull_request.draft == false &&
      (github.event.review.state == 'changes_requested' || github.event.review.state == 'commented')
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@anthropic.com"

      - name: Create Claude settings
        run: |
          mkdir -p .claude
          cat > .claude/settings.json << 'EOF'
          {
            "permissions": {
              "allow": [
                "Bash(git:*)",
                "Bash(gh:*)",
                "Bash(make:*)",
                "Bash(pnpm:*)",
                "Bash(nopo:*)"
              ]
            }
          }
          EOF

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          prompt: |
            You just submitted a review on PR #${{ github.event.pull_request.number }}.

            Your review state: ${{ github.event.review.state }}
            Your review body: ${{ github.event.review.body }}

            ## Step 1: Get Your Review Comments

            Fetch the comments from your review:
            ```
            gh api /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments
            ```

            Filter for comments from your review (review_id: ${{ github.event.review.id }}).

            ## Step 2: Process Each Comment

            For each comment you made:

            ### If it's a CHANGE REQUEST:
            1. Make the requested change to the code
            2. Commit with a clear message referencing the comment
            3. Reply to the comment with a link to the commit
            4. Example: "Fixed in commit abc123"

            ### If it's a QUESTION:
            - Questions will be answered by the PR author
            - No action needed now - wait for response

            ### If it contains PUSHBACK you're responding to:
            - Evaluate their reasoning
            - If reasonable: Accept and note in comment
            - If not convincing: Provide more compelling arguments

            ## Step 3: Finalize

            After processing all comments, check if you made any commits:

            ### If you made commits (code changes):
            Convert PR to draft and push:
            ```
            gh pr ready ${{ github.event.pull_request.number }} --undo
            git push origin ${{ github.event.pull_request.head.ref }}
            ```
            Converting to draft ensures CI runs before the review loop continues.
            CI-pass will mark it ready and re-request nopo-bot as reviewer when CI is green.

            ### If you made NO commits (only discussion/questions):
            Re-request nopo-bot as reviewer to continue the review loop:
            ```
            gh pr edit ${{ github.event.pull_request.number }} --add-reviewer "nopo-bot"
            ```
            This keeps the PR ready and continues the review loop without CI.

            IMPORTANT:
            - Make atomic commits for each change
            - Reference the comment in each commit message
            - Follow CLAUDE.md guidelines for all code changes
            - Choose the correct path based on whether you made commits
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 30"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
