name: Claude CI State
run-name: >-
  ${{ format('Claude CI State - {0} for {1}', github.event.workflow_run.conclusion, github.event.workflow_run.head_branch) }}

# This lightweight workflow handles CI completion by updating issue state.
# The state update triggers an `issues: edited` event which the main Claude
# workflow handles for iteration continuation.

'on':
  workflow_run:
    workflows:
      - CI
      - Release
    types:
      - completed

permissions:
  contents: read
  issues: write

jobs:
  update-state:
    runs-on: ubuntu-latest
    steps:
      - name: Extract context
        id: context
        env:
          CONCLUSION: ${{ github.event.workflow_run.conclusion }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
          RUN_ID: ${{ github.event.workflow_run.id }}
        run: |
          echo "conclusion=$CONCLUSION" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

          # Skip if not a Claude branch
          if [[ ! "$BRANCH" =~ ^claude/issue/([0-9]+)$ ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "skip_reason=Not a Claude issue branch" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract issue number from branch name
          issue_number="${BASH_REMATCH[1]}"
          echo "issue_number=$issue_number" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Checkout
        if: steps.context.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Update issue state with CI result
        if: steps.context.outputs.skip != 'true'
        uses: ./.github/actions-ts/claude-parse-state
        with:
          github_token: ${{ secrets.PAT_TOKEN }}
          issue_number: ${{ steps.context.outputs.issue_number }}
          action: update
          last_ci_run: ${{ steps.context.outputs.run_id }}
          last_ci_result: ${{ steps.context.outputs.conclusion }}
          iteration_message: "CI ${{ steps.context.outputs.conclusion }} - Run #${{ steps.context.outputs.run_id }}"

      - name: Log result
        if: steps.context.outputs.skip != 'true'
        run: |
          echo "Updated issue #${{ steps.context.outputs.issue_number }} with CI result: ${{ steps.context.outputs.conclusion }}"
          echo "This edit will trigger the iteration workflow"
