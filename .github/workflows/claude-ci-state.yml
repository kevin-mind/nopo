name: Claude CI State
run-name: >-
  ${{ format('Claude CI State - {0} for {1}', github.event.workflow_run.conclusion, github.event.workflow_run.head_branch) }}

# This lightweight workflow handles CI completion by updating Project fields.
# For failures: increments Failures field on parent issue
# For success: clears Failures field on parent issue
# Always appends to parent issue Iteration History (triggers iterate loop)

'on':
  workflow_run:
    workflows:
      - CI
      - Release
    types:
      - completed

permissions:
  contents: read
  issues: write

jobs:
  update-state:
    runs-on: ubuntu-latest
    # Concurrency: share group with Claude workflow to prevent race conditions
    # Extract parent issue from branch name (claude/issue/{parent}/phase-{N} or claude/issue/{N})
    concurrency:
      group: >-
        ${{
          contains(github.event.workflow_run.head_branch, '/phase-')
          && format('claude-work-claude/issue/{0}',
             split(github.event.workflow_run.head_branch, '/')[2])
          || startsWith(github.event.workflow_run.head_branch, 'claude/issue/')
          && format('claude-work-claude/issue/{0}',
             split(github.event.workflow_run.head_branch, '/')[2])
          || 'claude-ci-other'
        }}
      cancel-in-progress: false
    steps:
      - name: Extract context
        id: context
        env:
          CONCLUSION: ${{ github.event.workflow_run.conclusion }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "conclusion=$CONCLUSION" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

          # Check for sub-issue branch pattern: claude/issue/{parent}/phase-{N}
          if [[ "$BRANCH" =~ ^claude/issue/([0-9]+)/phase-([0-9]+)$ ]]; then
            parent_issue="${BASH_REMATCH[1]}"
            phase_number="${BASH_REMATCH[2]}"
            echo "branch_type=sub_issue" >> $GITHUB_OUTPUT
            echo "parent_issue=$parent_issue" >> $GITHUB_OUTPUT
            echo "phase_number=$phase_number" >> $GITHUB_OUTPUT

            # Find sub-issue number from PR body (contains "Fixes #N")
            pr_info=$(gh pr list --repo "$GITHUB_REPOSITORY" --head "$BRANCH" --json number,body --jq '.[0]' 2>/dev/null || echo "{}")
            if [[ -n "$pr_info" && "$pr_info" != "{}" && "$pr_info" != "null" ]]; then
              pr_body=$(echo "$pr_info" | jq -r '.body // ""')
              # Extract sub-issue number from "Fixes #N" pattern
              if [[ "$pr_body" =~ Fixes[[:space:]]*#([0-9]+) ]]; then
                sub_issue="${BASH_REMATCH[1]}"
                echo "issue_number=$sub_issue" >> $GITHUB_OUTPUT
                echo "skip=false" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi

            # Could not find sub-issue number from PR - skip
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "skip_reason=Could not extract sub-issue number from PR body" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for regular issue branch pattern: claude/issue/{N}
          if [[ "$BRANCH" =~ ^claude/issue/([0-9]+)$ ]]; then
            issue_number="${BASH_REMATCH[1]}"
            echo "issue_number=$issue_number" >> $GITHUB_OUTPUT
            echo "branch_type=regular" >> $GITHUB_OUTPUT
            # For regular issues, the issue itself is the "parent" for state updates
            echo "parent_issue=$issue_number" >> $GITHUB_OUTPUT
            echo "phase_number=" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Not a Claude branch
          echo "skip=true" >> $GITHUB_OUTPUT
          echo "skip_reason=Not a Claude issue branch" >> $GITHUB_OUTPUT

      - name: Checkout
        if: steps.context.outputs.skip != 'true'
        uses: actions/checkout@v4

      # On CI failure: increment Failures on parent issue
      - name: Record CI failure
        if: steps.context.outputs.skip != 'true' && steps.context.outputs.conclusion == 'failure'
        uses: ./.github/actions-ts/claude-parse-state
        with:
          github_token: ${{ secrets.NOPO_BOT_PAT }}
          issue_number: ${{ steps.context.outputs.parent_issue }}
          project_number: ${{ vars.PROJECT_NUMBER }}
          action: record_failure

      # On CI success: clear Failures on parent issue
      - name: Clear failures on CI success
        if: steps.context.outputs.skip != 'true' && steps.context.outputs.conclusion == 'success'
        uses: ./.github/actions-ts/claude-parse-state
        with:
          github_token: ${{ secrets.NOPO_BOT_PAT }}
          issue_number: ${{ steps.context.outputs.parent_issue }}
          project_number: ${{ vars.PROJECT_NUMBER }}
          action: clear_failures

      # Append CI result to parent Iteration History (triggers iterate loop)
      - name: Log CI result to parent history
        if: steps.context.outputs.skip != 'true'
        uses: ./.github/actions-ts/claude-parse-state
        with:
          github_token: ${{ secrets.NOPO_BOT_PAT }}
          issue_number: ${{ steps.context.outputs.parent_issue }}
          action: append_history
          phase: ${{ steps.context.outputs.phase_number }}
          message: >-
            CI ${{ steps.context.outputs.conclusion == 'success' && '✅' || '❌' }}
            [Run #${{ steps.context.outputs.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ steps.context.outputs.run_id }})

      - name: Log result
        if: steps.context.outputs.skip != 'true'
        run: |
          echo "Updated parent issue #${{ steps.context.outputs.parent_issue }} with CI result: ${{ steps.context.outputs.conclusion }}"
          if [[ -n "${{ steps.context.outputs.phase_number }}" ]]; then
            echo "Phase: ${{ steps.context.outputs.phase_number }}"
          fi
          echo "This edit will trigger the iteration workflow"
