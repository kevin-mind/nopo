name: Claude CI State
run-name: >-
  ${{ format('Claude CI State - {0} for {1}', github.event.workflow_run.conclusion, github.event.workflow_run.head_branch) }}

# This lightweight workflow handles CI completion by updating Project fields.
# For failures: increments Failures field on parent issue
# For success: clears Failures field on parent issue
# Always appends to parent issue Iteration History (triggers iterate loop)

'on':
  workflow_run:
    workflows:
      - CI
      - Release
    types:
      - completed

permissions:
  contents: read
  issues: write

jobs:
  update-state:
    runs-on: ubuntu-latest
    # Concurrency: use branch name for serialization
    # Note: Can't share exact group with claude.yml because GHA expressions don't have split()
    # But using branch name still prevents concurrent CI state updates on same branch
    concurrency:
      group: >-
        ${{
          startsWith(github.event.workflow_run.head_branch, 'claude/issue/')
          && format('claude-ci-state-{0}', github.event.workflow_run.head_branch)
          || 'claude-ci-other'
        }}
      cancel-in-progress: false
    steps:
      - name: Extract context
        id: context
        env:
          CONCLUSION: ${{ github.event.workflow_run.conclusion }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
          RUN_ID: ${{ github.event.workflow_run.id }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "conclusion=$CONCLUSION" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

          # Check for sub-issue branch pattern: claude/issue/{parent}/phase-{N}
          if [[ "$BRANCH" =~ ^claude/issue/([0-9]+)/phase-([0-9]+)$ ]]; then
            parent_issue="${BASH_REMATCH[1]}"
            phase_number="${BASH_REMATCH[2]}"
            echo "branch_type=sub_issue" >> $GITHUB_OUTPUT
            echo "parent_issue=$parent_issue" >> $GITHUB_OUTPUT
            echo "phase_number=$phase_number" >> $GITHUB_OUTPUT

            # Find sub-issue number from PR body (contains "Fixes #N")
            pr_info=$(gh pr list --repo "$GITHUB_REPOSITORY" --head "$BRANCH" --json number,body --jq '.[0]' 2>/dev/null || echo "{}")
            if [[ -n "$pr_info" && "$pr_info" != "{}" && "$pr_info" != "null" ]]; then
              pr_body=$(echo "$pr_info" | jq -r '.body // ""')
              # Extract sub-issue number from "Fixes #N" pattern
              if [[ "$pr_body" =~ Fixes[[:space:]]*#([0-9]+) ]]; then
                sub_issue="${BASH_REMATCH[1]}"
                echo "issue_number=$sub_issue" >> $GITHUB_OUTPUT
                echo "skip=false" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi

            # Could not find sub-issue number from PR - skip
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "skip_reason=Could not extract sub-issue number from PR body" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for regular issue branch pattern: claude/issue/{N}
          if [[ "$BRANCH" =~ ^claude/issue/([0-9]+)$ ]]; then
            issue_number="${BASH_REMATCH[1]}"
            echo "issue_number=$issue_number" >> $GITHUB_OUTPUT
            echo "branch_type=regular" >> $GITHUB_OUTPUT
            # For regular issues, the issue itself is the "parent" for state updates
            echo "parent_issue=$issue_number" >> $GITHUB_OUTPUT
            echo "phase_number=" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Not a Claude branch
          echo "skip=true" >> $GITHUB_OUTPUT
          echo "skip_reason=Not a Claude issue branch" >> $GITHUB_OUTPUT

      - name: Checkout
        if: steps.context.outputs.skip != 'true'
        uses: actions/checkout@v4

      # On CI failure: increment Failures on parent issue
      - name: Record CI failure
        if: steps.context.outputs.skip != 'true' && steps.context.outputs.conclusion == 'failure'
        uses: ./.github/actions-ts/claude-parse-state
        with:
          github_token: ${{ secrets.NOPO_BOT_PAT }}
          issue_number: ${{ steps.context.outputs.parent_issue }}
          project_number: ${{ vars.PROJECT_NUMBER }}
          action: record_failure

      # On CI success: clear Failures on parent issue
      - name: Clear failures on CI success
        if: steps.context.outputs.skip != 'true' && steps.context.outputs.conclusion == 'success'
        uses: ./.github/actions-ts/claude-parse-state
        with:
          github_token: ${{ secrets.NOPO_BOT_PAT }}
          issue_number: ${{ steps.context.outputs.parent_issue }}
          project_number: ${{ vars.PROJECT_NUMBER }}
          action: clear_failures

      # Update "Running..." row in parent Iteration History with CI result (triggers iterate loop)
      - name: Log CI result to parent history
        if: steps.context.outputs.skip != 'true'
        uses: ./.github/actions-ts/claude-parse-state
        with:
          github_token: ${{ secrets.NOPO_BOT_PAT }}
          issue_number: ${{ steps.context.outputs.parent_issue }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}
          action: update_history
          phase: ${{ steps.context.outputs.phase_number }}
          match_pattern: "⏳"
          message: CI ${{ steps.context.outputs.conclusion == 'success' && '✅' || '❌' }}
          run_link: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ steps.context.outputs.run_id }}

      # For sub-issues: also edit the sub-issue to trigger iterate
      # (Parent edit triggers orchestrate, but we need iterate on the sub-issue for PR ready logic)
      - name: Trigger iterate on sub-issue
        if: |
          steps.context.outputs.skip != 'true' &&
          steps.context.outputs.branch_type == 'sub_issue' &&
          steps.context.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.NOPO_BOT_PAT }}
          SUB_ISSUE: ${{ steps.context.outputs.issue_number }}
          CONCLUSION: ${{ steps.context.outputs.conclusion }}
          RUN_ID: ${{ steps.context.outputs.run_id }}
        run: |
          # Add CI result to sub-issue body to trigger iterate
          # This small edit triggers the issues:edited event on the sub-issue
          current_body=$(gh issue view "$SUB_ISSUE" --json body --jq '.body' --repo "$GITHUB_REPOSITORY")

          # Check if there's already a CI status line and update it, or add one
          ci_line="<!-- CI_STATUS: $CONCLUSION -->"
          if echo "$current_body" | grep -q "<!-- CI_STATUS:"; then
            # Update existing CI status
            new_body=$(echo "$current_body" | sed "s/<!-- CI_STATUS: [a-z]* -->/$ci_line/")
          else
            # Append CI status (use printf for newlines)
            new_body=$(printf '%s\n\n%s' "$current_body" "$ci_line")
          fi

          gh issue edit "$SUB_ISSUE" --body "$new_body" --repo "$GITHUB_REPOSITORY"
          echo "Edited sub-issue #$SUB_ISSUE to trigger iterate workflow"

      - name: Log result
        if: steps.context.outputs.skip != 'true'
        run: |
          echo "Updated parent issue #${{ steps.context.outputs.parent_issue }} with CI result: ${{ steps.context.outputs.conclusion }}"
          if [[ -n "${{ steps.context.outputs.phase_number }}" ]]; then
            echo "Phase: ${{ steps.context.outputs.phase_number }}"
            echo "Also edited sub-issue #${{ steps.context.outputs.issue_number }} to trigger iterate"
          fi
