# This file was auto-generated by github-actions-workflow-ts.
# Do not edit directly. Instead, edit the corresponding .wac.ts file in .github/workflows-ts/
# and run `pnpm run gwf:build` to regenerate this file.
name: Claude CI Loop
'on':
  push:
    branches-ignore:
      - main
  workflow_run:
    workflows:
      - CI
      - Release
    types:
      - completed
  workflow_dispatch:
    inputs:
      pr_number:
        description: PR number to process
        required: true
        type: string
      conclusion:
        description: Simulated workflow conclusion
        required: true
        type: choice
        options:
          - failure
          - success
        default: failure
permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  id-token: write
defaults:
  run:
    shell: bash
jobs:
  push-convert-to-draft:
    if: |-
      github.event_name == 'push' &&
      !startsWith(github.ref_name, 'gh-readonly-queue/')
    runs-on: ubuntu-latest
    concurrency:
      group: claude-review-${{ github.ref_name }}
      cancel-in-progress: true
    steps:
      - id: get_pr
        name: gh pr list
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_BRANCH: ${{ github.ref_name }}
        run: |-
          pr=$(gh pr list --repo "$GITHUB_REPOSITORY" --head "$HEAD_BRANCH"  --json number,isDraft,author,headRefName --jq '.[0]')
          echo "number=$(echo "$pr" | jq -r '.number // empty')" >> $GITHUB_OUTPUT
          echo "is_draft=$(echo "$pr" | jq -r '.isDraft // empty')" >> $GITHUB_OUTPUT
          echo "author=$(echo "$pr" | jq -r '.author.login // empty')" >> $GITHUB_OUTPUT
          echo "head_branch=$(echo "$pr" | jq -r '.headRefName // empty')" >> $GITHUB_OUTPUT
          echo "found=$([[ -n "$pr" && "$pr" != "null" ]] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
      - id: convert_to_draft
        if: steps.get_pr.outputs.found == 'true' && steps.get_pr.outputs.is_draft == 'false'
        name: gh pr ready --undo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.get_pr.outputs.number }}
        run: gh pr ready "$PR_NUMBER" --undo --repo "$GITHUB_REPOSITORY"
  check-pr:
    if: github.event_name == 'workflow_run' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      has_pr: ${{ steps.check.outputs.has_pr }}
      is_claude_pr: ${{ steps.check.outputs.is_claude_pr }}
      is_draft: ${{ steps.check.outputs.is_draft }}
      pr_number: ${{ steps.check.outputs.pr_number }}
      pr_head_branch: ${{ steps.check.outputs.pr_head_branch }}
      pr_body: ${{ steps.check.outputs.pr_body }}
      has_issue: ${{ steps.check.outputs.has_issue }}
      issue_number: ${{ steps.check.outputs.issue_number }}
      conclusion: ${{ steps.conclusion.outputs.conclusion }}
    steps:
      - id: conclusion
        name: Determine conclusion
        env:
          INPUT_CONCLUSION: ${{ inputs.conclusion }}
          EVENT_CONCLUSION: ${{ github.event.workflow_run.conclusion }}
        run: |-
          if [[ -n "$INPUT_CONCLUSION" ]]; then
            echo "conclusion=$INPUT_CONCLUSION" >> $GITHUB_OUTPUT
          else
            echo "conclusion=$EVENT_CONCLUSION" >> $GITHUB_OUTPUT
          fi
      - id: check
        name: PR view (extended)
        uses: ./.github/actions-ts/pr-view-extended
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}
          head_branch: ${{ github.event.workflow_run.head_branch }}
          pr_number: ${{ inputs.pr_number }}
  failure-convert-to-draft:
    if: |-
      (github.event.workflow_run.conclusion == 'failure' || needs.check-pr.outputs.conclusion == 'failure') &&
      needs.check-pr.outputs.has_pr == 'true' &&
      needs.check-pr.outputs.is_claude_pr == 'true' &&
      needs.check-pr.outputs.is_draft == 'false'
    runs-on: ubuntu-latest
    steps:
      - id: convert_to_draft
        name: gh pr ready --undo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.check-pr.outputs.pr_number }}
        run: gh pr ready "$PR_NUMBER" --undo --repo "$GITHUB_REPOSITORY"
      - id: log_conversion
        name: Log conversion
        run: 'echo "Converted PR #${{ needs.check-pr.outputs.pr_number }} to draft due to CI failure"'
    needs:
      - null
  failure-fix-and-push:
    if: |-
      (github.event.workflow_run.conclusion == 'failure' || needs.check-pr.outputs.conclusion == 'failure') &&
      (needs.failure-convert-to-draft.result == 'success' || needs.failure-convert-to-draft.result == 'skipped') &&
      needs.check-pr.outputs.has_pr == 'true' &&
      needs.check-pr.outputs.is_claude_pr == 'true'
    runs-on: ubuntu-latest
    steps:
      - id: count_comments
        name: gh api (count comments)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.check-pr.outputs.pr_number }}
          USER_LOGIN: claude[bot]
        run: |-
          review_comments=$(gh api "repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER/comments" --jq "[.[] | select(.user.login == \"$USER_LOGIN\")] | length")
          issue_comments=$(gh api "repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments" --jq "[.[] | select(.user.login == \"$USER_LOGIN\")] | length")
          reviews=$(gh api "repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER/reviews" --jq "[.[] | select(.user.login == \"$USER_LOGIN\")] | length")
          total=$((review_comments + issue_comments + reviews))
          echo "count=$total" >> $GITHUB_OUTPUT
      - id: check_limit
        name: Check comment limit
        env:
          COMMENT_COUNT: ${{ steps.count_comments.outputs.count }}
          MAX_COMMENTS: '50'
        run: |-
          if [[ "$COMMENT_COUNT" -ge "$MAX_COMMENTS" ]]; then
            echo "exceeded=true" >> $GITHUB_OUTPUT
            echo "Claude has made $COMMENT_COUNT comments (max: $MAX_COMMENTS). Stopping to prevent infinite loop."
          else
            echo "exceeded=false" >> $GITHUB_OUTPUT
          fi
      - id: checkout
        if: steps.check_limit.outputs.exceeded == 'false'
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-pr.outputs.pr_head_branch }}
          fetch-depth: 0
      - id: git_config
        if: steps.check_limit.outputs.exceeded == 'false'
        name: git config
        env:
          USER_NAME: Claude Bot
          USER_EMAIL: claude-bot@anthropic.com
        run: |-
          git config --global user.name "$USER_NAME"
          git config --global user.email "$USER_EMAIL"
      - id: claude_fix
        if: steps.check_limit.outputs.exceeded == 'false'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: .claude/settings.json
          prompt: |-
            The CI build failed for PR #${{ needs.check-pr.outputs.pr_number }} on branch ${{ needs.check-pr.outputs.pr_head_branch }}.

            1. Analyze the project to understand the build and test process (see CLAUDE.md).
            2. Run `make check` and `make test` to reproduce the failure.
            3. Fix the issue.
            4. Verify the fix by running tests again.
            5. Push the changes to the same branch.

            This is an automated CI fix loop - focus on fixing the specific failure.
          claude_args: '--model claude-opus-4-5-20251101 --max-turns 200'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    needs:
      - null
      - null
  failure-suggest-fixes:
    if: |-
      (github.event.workflow_run.conclusion == 'failure' || needs.check-pr.outputs.conclusion == 'failure') &&
      needs.check-pr.outputs.has_pr == 'true' &&
      needs.check-pr.outputs.is_claude_pr == 'false'
    runs-on: ubuntu-latest
    steps:
      - id: checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-pr.outputs.pr_head_branch }}
          fetch-depth: 0
      - id: claude_suggest
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: .claude/settings.json
          prompt: |-
            The CI build failed for PR #${{ needs.check-pr.outputs.pr_number }} on branch ${{ needs.check-pr.outputs.pr_head_branch }}.

            This is a human-created PR, so DO NOT push any changes directly.

            Instead:
            1. Analyze the project to understand the build and test process (see CLAUDE.md).
            2. Run `make check` and `make test` to reproduce the failure.
            3. Identify the root cause of the failure.
            4. Submit a PR review with your findings and suggestions.

            ## IMPORTANT: Always Post Visible Feedback

            You MUST submit a PR review with your analysis. Use one of:
            ```
            # If you have specific fix suggestions:
            gh pr review ${{ needs.check-pr.outputs.pr_number }} --comment --body "## CI Failure Analysis

            **Root Cause:** <description>

            **Suggested Fixes:**
            <specific code suggestions with file paths and line numbers>"

            # For inline comments on specific files/lines:
            gh api repos/$GITHUB_REPOSITORY/pulls/${{ needs.check-pr.outputs.pr_number }}/comments \
              -f body="suggestion" -f path="file.ts" -f line=42 -f side="RIGHT"
            ```

            NEVER leave the PR without feedback - even if you can't identify the exact issue,
            post what you found and any partial analysis.

            Be helpful and specific - the human author should be able to easily apply your suggestions.
          claude_args: '--model claude-opus-4-5-20251101 --max-turns 200'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    needs:
      - null
  success-check-comments:
    if: |-
      (github.event.workflow_run.conclusion == 'success' || needs.check-pr.outputs.conclusion == 'success') &&
      needs.check-pr.outputs.has_pr == 'true'
    runs-on: ubuntu-latest
    outputs:
      has_unresolved: ${{ steps.comments.outputs.has_unresolved }}
      unresolved_count: ${{ steps.comments.outputs.unresolved_count }}
    steps:
      - id: comments
        name: gh api graphql (unresolved comments)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.check-pr.outputs.pr_number }}
        run: |-
          repo_name="${GITHUB_REPOSITORY#*/}"
          owner="${GITHUB_REPOSITORY%/*}"

          result=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $pr: Int!) {
              repository(owner: $owner, name: $repo) {
                pullRequest(number: $pr) {
                  reviewThreads(first: 100) {
                    nodes {
                      isResolved
                    }
                  }
                }
              }
            }
          ' \
            -F owner="$owner" \
            -F repo="$repo_name" \
            -F pr="$PR_NUMBER")

          unresolved_count=$(echo "$result" | jq '[.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false)] | length')
          echo "unresolved_count=$unresolved_count" >> $GITHUB_OUTPUT
          echo "has_unresolved=$([[ "$unresolved_count" -gt 0 ]] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
      - id: notify
        name: gh pr comment
        if: steps.comments.outputs.has_unresolved == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.check-pr.outputs.pr_number }}
          BODY: |-
            ⏸️ **CI passed but not moving to Review**

            There are **${{ steps.comments.outputs.unresolved_count }} unresolved comment thread(s)** on this PR.

            Please resolve all comments before the PR can move to Review status.
        run: |-
          comment_url=$(gh pr comment "$PR_NUMBER" --body "$BODY" --repo "$GITHUB_REPOSITORY" 2>&1)
          comment_id=$(echo "$comment_url" | grep -oE '[0-9]+$' || echo "")
          echo "comment_id=$comment_id" >> $GITHUB_OUTPUT
    needs:
      - null
  success-update-project:
    if: |-
      (github.event.workflow_run.conclusion == 'success' || needs.check-pr.outputs.conclusion == 'success') &&
      needs.check-pr.outputs.has_issue == 'true' &&
      needs.success-check-comments.outputs.has_unresolved != 'true'
    runs-on: ubuntu-latest
    steps:
      - id: update_project
        name: gh api graphql (update project status)
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.check-pr.outputs.issue_number }}
          TARGET_STATUS: In review
        run: |2-
            repo_name="${GITHUB_REPOSITORY#*/}"
            owner="${GITHUB_REPOSITORY%/*}"

            # Find the project item
            result=$(gh api graphql -f query='query($owner: String!, $repo: String!, $issue: Int!) {
            repository(owner: $owner, name: $repo) {
              issue(number: $issue) {
                projectItems(first: 10) {
                  nodes {
                    id
                    project {
                      id
                      title
                      field(name: "Status") {
                        ... on ProjectV2SingleSelectField {
                          id
                          options { id name }
                        }
                      }
                    }
                  }
                }
              }
            }
          }' \
              -F owner="$owner" \
              -F repo="$repo_name" \
              -F issue="$ISSUE_NUMBER" 2>/dev/null || echo "{}")

            # Extract project info
            item=$(echo "$result" | jq -r '.data.repository.issue.projectItems.nodes[0] // empty')
            if [[ -z "$item" ]]; then
              echo "No project item found for issue #$ISSUE_NUMBER"
              exit 0
            fi

            item_id=$(echo "$item" | jq -r '.id')
            project_id=$(echo "$item" | jq -r '.project.id')
            field_id=$(echo "$item" | jq -r '.project.field.id')
            option_id=$(echo "$item" | jq -r --arg status "$TARGET_STATUS" '.project.field.options[] | select(.name == $status) | .id')

            if [[ -z "$option_id" ]]; then
              echo "Status '$TARGET_STATUS' not found in project"
              exit 0
            fi

            # Update the status
            gh api graphql -f query='mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
            updateProjectV2ItemFieldValue(input: {
              projectId: $projectId
              itemId: $itemId
              fieldId: $fieldId
              value: { singleSelectOptionId: $optionId }
            }) {
              projectV2Item { id }
            }
          }' \
              -F projectId="$project_id" \
              -F itemId="$item_id" \
              -F fieldId="$field_id" \
              -F optionId="$option_id"

            echo "Updated project status to '$TARGET_STATUS'"
    needs:
      - null
      - null
  success-ready-for-review:
    if: |-
      always() &&
      (github.event.workflow_run.conclusion == 'success' || needs.check-pr.outputs.conclusion == 'success') &&
      needs.check-pr.outputs.has_pr == 'true' &&
      needs.success-check-comments.outputs.has_unresolved != 'true'
    runs-on: ubuntu-latest
    steps:
      - id: mark_ready
        name: gh pr ready
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.check-pr.outputs.pr_number }}
        run: gh pr ready "$PR_NUMBER" --repo "$GITHUB_REPOSITORY"
      - id: add_label
        name: gh pr edit --add-label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.check-pr.outputs.pr_number }}
          LABEL: review-ready
        run: gh pr edit "$PR_NUMBER" --add-label "$LABEL" --repo "$GITHUB_REPOSITORY" || true
      - id: request_reviewer
        name: gh pr edit --add-reviewer
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.check-pr.outputs.pr_number }}
          REVIEWERS: nopo-bot
        run: gh pr edit "$PR_NUMBER" --add-reviewer "$REVIEWERS" --repo "$GITHUB_REPOSITORY"
    needs:
      - null
      - null
      - null
