name: Claude CI Loop
'on':
  push:
    branches-ignore:
      - main
  workflow_run:
    workflows:
      - CI
      - Release
    types:
      - completed
  workflow_dispatch:
    inputs:
      pr_number:
        description: PR number to process
        required: true
        type: string
      conclusion:
        description: Simulated workflow conclusion
        required: true
        type: choice
        options:
          - failure
          - success
        default: failure
permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  id-token: write
defaults:
  run:
    shell: bash
jobs:
  push-convert-to-draft:
    if: |-
      github.event_name == 'push' &&
      !startsWith(github.ref_name, 'gh-readonly-queue/')
    runs-on: ubuntu-latest
    concurrency:
      group: claude-review-${{ github.ref_name }}
      cancel-in-progress: true
    steps:
      - id: get_pr
        name: gh pr list
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_BRANCH: ${{ github.ref_name }}
        run: |-
          pr=$(gh pr list --repo "$GITHUB_REPOSITORY" --head "$HEAD_BRANCH"  --json number,isDraft,author,headRefName --jq '.[0]')
          echo "number=$(echo "$pr" | jq -r '.number // empty')" >> $GITHUB_OUTPUT
          echo "is_draft=$(echo "$pr" | jq -r '.isDraft // empty')" >> $GITHUB_OUTPUT
          echo "author=$(echo "$pr" | jq -r '.author.login // empty')" >> $GITHUB_OUTPUT
          echo "head_branch=$(echo "$pr" | jq -r '.headRefName // empty')" >> $GITHUB_OUTPUT
          echo "found=$([[ -n "$pr" && "$pr" != "null" ]] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
      - id: convert_to_draft
        if: steps.get_pr.outputs.found == 'true' && steps.get_pr.outputs.is_draft == 'false'
        name: gh pr ready --undo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.get_pr.outputs.number }}
        run: gh pr ready "$PR_NUMBER" --undo --repo "$GITHUB_REPOSITORY"
  check-pr:
    if: github.event_name == 'workflow_run' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      has_pr: ${{ steps.check.outputs.has_pr }}
      is_claude_pr: ${{ steps.check.outputs.is_claude_pr }}
      is_draft: ${{ steps.check.outputs.is_draft }}
      pr_number: ${{ steps.check.outputs.pr_number }}
      pr_head_branch: ${{ steps.check.outputs.pr_head_branch }}
      pr_body: ${{ steps.check.outputs.pr_body }}
      has_issue: ${{ steps.check.outputs.has_issue }}
      issue_number: ${{ steps.check.outputs.issue_number }}
      conclusion: ${{ steps.conclusion.outputs.conclusion }}
    steps:
      - id: conclusion
        name: Determine conclusion
        env:
          INPUT_CONCLUSION: ${{ inputs.conclusion }}
          EVENT_CONCLUSION: ${{ github.event.workflow_run.conclusion }}
        run: |-
          if [[ -n "$INPUT_CONCLUSION" ]]; then
            echo "conclusion=$INPUT_CONCLUSION" >> $GITHUB_OUTPUT
          else
            echo "conclusion=$EVENT_CONCLUSION" >> $GITHUB_OUTPUT
          fi
      - id: check
        name: PR view (extended)
        uses: ./.github/actions-ts/pr-view-extended
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}
          head_branch: ${{ github.event.workflow_run.head_branch }}
          pr_number: ${{ inputs.pr_number }}
  failure-convert-to-draft:
    if: |-
      (github.event.workflow_run.conclusion == 'failure' || needs.check-pr.outputs.conclusion == 'failure') &&
      needs.check-pr.outputs.has_pr == 'true' &&
      needs.check-pr.outputs.is_claude_pr == 'true' &&
      needs.check-pr.outputs.is_draft == 'false'
    runs-on: ubuntu-latest
    steps:
      - id: convert_to_draft
        name: gh pr ready --undo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.check-pr.outputs.pr_number }}
        run: gh pr ready "$PR_NUMBER" --undo --repo "$GITHUB_REPOSITORY"
      - id: log_conversion
        name: Log conversion
        run: 'echo "Converted PR #${{ needs.check-pr.outputs.pr_number }} to draft due to CI failure"'
    needs:
      - check-pr
  failure-fix-and-push:
    if: |-
      (github.event.workflow_run.conclusion == 'failure' || needs.check-pr.outputs.conclusion == 'failure') &&
      (needs.failure-convert-to-draft.result == 'success' || needs.failure-convert-to-draft.result == 'skipped') &&
      needs.check-pr.outputs.has_pr == 'true' &&
      needs.check-pr.outputs.is_claude_pr == 'true'
    uses: ./.github/workflows/_claude.yml
    with:
      job: ci-fix
      pr_number: ${{ needs.check-pr.outputs.pr_number }}
      branch_name: ${{ needs.check-pr.outputs.pr_head_branch }}
    secrets: inherit
    needs:
      - check-pr
      - failure-convert-to-draft
  failure-suggest-fixes:
    if: |-
      (github.event.workflow_run.conclusion == 'failure' || needs.check-pr.outputs.conclusion == 'failure') &&
      needs.check-pr.outputs.has_pr == 'true' &&
      needs.check-pr.outputs.is_claude_pr == 'false'
    uses: ./.github/workflows/_claude.yml
    with:
      job: ci-suggest
      pr_number: ${{ needs.check-pr.outputs.pr_number }}
      branch_name: ${{ needs.check-pr.outputs.pr_head_branch }}
    secrets: inherit
    needs:
      - check-pr
  success-check-comments:
    if: |-
      (github.event.workflow_run.conclusion == 'success' || needs.check-pr.outputs.conclusion == 'success') &&
      needs.check-pr.outputs.has_pr == 'true'
    runs-on: ubuntu-latest
    outputs:
      has_unresolved: ${{ steps.comments.outputs.has_unresolved }}
      unresolved_count: ${{ steps.comments.outputs.unresolved_count }}
    steps:
      - id: comments
        name: gh api graphql (unresolved comments)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.check-pr.outputs.pr_number }}
        run: |-
          repo_name="${GITHUB_REPOSITORY#*/}"
          owner="${GITHUB_REPOSITORY%/*}"

          result=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $pr: Int!) {
              repository(owner: $owner, name: $repo) {
                pullRequest(number: $pr) {
                  reviewThreads(first: 100) {
                    nodes {
                      isResolved
                    }
                  }
                }
              }
            }
          ' \
            -F owner="$owner" \
            -F repo="$repo_name" \
            -F pr="$PR_NUMBER")

          unresolved_count=$(echo "$result" | jq '[.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false)] | length')
          echo "unresolved_count=$unresolved_count" >> $GITHUB_OUTPUT
          echo "has_unresolved=$([[ "$unresolved_count" -gt 0 ]] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
      - id: notify
        name: gh pr comment
        if: steps.comments.outputs.has_unresolved == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.check-pr.outputs.pr_number }}
          BODY: |-
            ⏸️ **CI passed but not moving to Review**

            There are **${{ steps.comments.outputs.unresolved_count }} unresolved comment thread(s)** on this PR.

            Please resolve all comments before the PR can move to Review status.
        run: |-
          comment_url=$(gh pr comment "$PR_NUMBER" --body "$BODY" --repo "$GITHUB_REPOSITORY" 2>&1)
          comment_id=$(echo "$comment_url" | grep -oE '[0-9]+$' || echo "")
          echo "comment_id=$comment_id" >> $GITHUB_OUTPUT
    needs:
      - check-pr
  success-update-project:
    if: |-
      (github.event.workflow_run.conclusion == 'success' || needs.check-pr.outputs.conclusion == 'success') &&
      needs.check-pr.outputs.has_issue == 'true' &&
      needs.success-check-comments.outputs.has_unresolved != 'true'
    runs-on: ubuntu-latest
    steps:
      - id: update_project
        name: gh api graphql (update project status)
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.check-pr.outputs.issue_number }}
          TARGET_STATUS: In review
        run: |2-
            repo_name="${GITHUB_REPOSITORY#*/}"
            owner="${GITHUB_REPOSITORY%/*}"

            # Find the project item
            result=$(gh api graphql -f query='query($owner: String!, $repo: String!, $issue: Int!) {
            repository(owner: $owner, name: $repo) {
              issue(number: $issue) {
                projectItems(first: 10) {
                  nodes {
                    id
                    project {
                      id
                      title
                      field(name: "Status") {
                        ... on ProjectV2SingleSelectField {
                          id
                          options { id name }
                        }
                      }
                    }
                  }
                }
              }
            }
          }' \
              -F owner="$owner" \
              -F repo="$repo_name" \
              -F issue="$ISSUE_NUMBER" 2>/dev/null || echo "{}")

            # Extract project info
            item=$(echo "$result" | jq -r '.data.repository.issue.projectItems.nodes[0] // empty')
            if [[ -z "$item" ]]; then
              echo "No project item found for issue #$ISSUE_NUMBER"
              exit 0
            fi

            item_id=$(echo "$item" | jq -r '.id')
            project_id=$(echo "$item" | jq -r '.project.id')
            field_id=$(echo "$item" | jq -r '.project.field.id')
            option_id=$(echo "$item" | jq -r --arg status "$TARGET_STATUS" '.project.field.options[] | select(.name == $status) | .id')

            if [[ -z "$option_id" ]]; then
              echo "Status '$TARGET_STATUS' not found in project"
              exit 0
            fi

            # Update the status
            gh api graphql -f query='mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
            updateProjectV2ItemFieldValue(input: {
              projectId: $projectId
              itemId: $itemId
              fieldId: $fieldId
              value: { singleSelectOptionId: $optionId }
            }) {
              projectV2Item { id }
            }
          }' \
              -F projectId="$project_id" \
              -F itemId="$item_id" \
              -F fieldId="$field_id" \
              -F optionId="$option_id"

            echo "Updated project status to '$TARGET_STATUS'"
    needs:
      - check-pr
      - success-check-comments
  success-ready-for-review:
    if: |-
      always() &&
      (github.event.workflow_run.conclusion == 'success' || needs.check-pr.outputs.conclusion == 'success') &&
      needs.check-pr.outputs.has_pr == 'true' &&
      needs.success-check-comments.outputs.has_unresolved != 'true'
    runs-on: ubuntu-latest
    steps:
      - id: mark_ready
        name: gh pr ready
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.check-pr.outputs.pr_number }}
        run: gh pr ready "$PR_NUMBER" --repo "$GITHUB_REPOSITORY"
      - id: add_label
        name: gh pr edit --add-label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.check-pr.outputs.pr_number }}
          LABEL: review-ready
        run: gh pr edit "$PR_NUMBER" --add-label "$LABEL" --repo "$GITHUB_REPOSITORY" || true
      - id: request_reviewer
        name: gh pr edit --add-reviewer
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.check-pr.outputs.pr_number }}
          REVIEWERS: nopo-bot
        run: gh pr edit "$PR_NUMBER" --add-reviewer "$REVIEWERS" --repo "$GITHUB_REPOSITORY"
    needs:
      - check-pr
      - success-check-comments
      - success-update-project
