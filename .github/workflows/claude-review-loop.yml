name: Claude Review Loop

on:
  pull_request:
    types: [review_requested]
  pull_request_review:
    types: [submitted]

# CRITICAL: This concurrency group MUST match push-convert-to-draft in claude-ci-loop.yml
# The shared group ensures pushes cancel in-flight review workflows.
# - Push uses cancel-in-progress: true (cancels reviews)
# - Review loop uses cancel-in-progress: false (queues, doesn't cancel itself)
# This prevents race conditions where review acts on stale code.
concurrency:
  group: claude-review-${{ github.event.pull_request.head.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  #############################################################################
  # REVIEW REQUEST JOBS (triggered by nopo-bot requested as reviewer)
  #############################################################################

  request-setup:
    if: |
      github.event_name == 'pull_request' &&
      github.event.requested_reviewer.login == 'nopo-bot'
    runs-on: ubuntu-latest
    outputs:
      pr_branch: ${{ github.event.pull_request.head.ref }}
      pr_number: ${{ github.event.pull_request.number }}
      is_draft: ${{ github.event.pull_request.draft }}
      issue_number: ${{ steps.issue.outputs.number }}
      issue_body: ${{ steps.issue.outputs.body }}
      has_issue: ${{ steps.issue.outputs.has_issue }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if draft
        if: github.event.pull_request.draft == true
        run: |
          echo "::warning::PR #${{ github.event.pull_request.number }} is a draft. Skipping review."
          exit 1

      - name: Extract linked issue
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          pr_body=$(gh pr view "$PR_NUMBER" --json body --jq '.body')
          issue_number=$(echo "$pr_body" | grep -oP 'Fixes #\K\d+' | head -1 || true)

          if [[ -n "$issue_number" ]]; then
            echo "has_issue=true" >> $GITHUB_OUTPUT
            echo "number=$issue_number" >> $GITHUB_OUTPUT

            issue_body=$(gh issue view "$issue_number" --json body --jq '.body')
            echo "body<<EOF" >> $GITHUB_OUTPUT
            echo "$issue_body" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_issue=false" >> $GITHUB_OUTPUT
          fi

  request-update-project:
    needs: request-setup
    if: needs.request-setup.outputs.has_issue == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Update project status to In review
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.request-setup.outputs.issue_number }}
        run: |
          result=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $number) {
                  projectItems(first: 10) {
                    nodes {
                      id
                      project { id }
                    }
                  }
                }
              }
            }
          ' -f owner="${GITHUB_REPOSITORY_OWNER}" -f repo="${GITHUB_REPOSITORY#*/}" -F number="$ISSUE_NUMBER")

          item_id=$(echo "$result" | jq -r '.data.repository.issue.projectItems.nodes[0].id // empty')
          project_id=$(echo "$result" | jq -r '.data.repository.issue.projectItems.nodes[0].project.id // empty')

          if [[ -z "$item_id" || -z "$project_id" ]]; then
            echo "Issue not linked to a project - skipping status update"
            exit 0
          fi

          fields=$(gh api graphql -f query='
            query($projectId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options { id name }
                      }
                    }
                  }
                }
              }
            }
          ' -f projectId="$project_id")

          field_id=$(echo "$fields" | jq -r '.data.node.fields.nodes[] | select(.name == "Status") | .id')
          option_id=$(echo "$fields" | jq -r '.data.node.fields.nodes[] | select(.name == "Status") | .options[] | select(.name == "In review") | .id')

          if [[ -z "$field_id" || -z "$option_id" ]]; then
            echo "Could not find Status field or In review option"
            exit 0
          fi

          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(
                input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { singleSelectOptionId: $optionId }
                }
              ) { projectV2Item { id } }
            }
          ' -f projectId="$project_id" -f itemId="$item_id" -f fieldId="$field_id" -f optionId="$option_id"

          echo "Updated project item to In review status"

  request-review:
    needs: [request-setup, request-update-project]
    if: always() && needs.request-setup.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.request-setup.outputs.pr_branch }}
          fetch-depth: 0

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          prompt: |
            You are reviewing PR #${{ needs.request-setup.outputs.pr_number }} on behalf of nopo-bot.

            nopo-bot was requested as a reviewer, which triggers this automated review.
            You (claude[bot]) will perform the actual review and submit it.

            ${{ needs.request-setup.outputs.has_issue == 'true' && format('## Linked Issue #{0}

            {1}

            ## Validation
            - CHECK ALL TODO ITEMS in the issue are addressed
            - VERIFY code follows CLAUDE.md guidelines
            - ENSURE tests cover the requirements

            ', needs.request-setup.outputs.issue_number, needs.request-setup.outputs.issue_body) || '## No Linked Issue
            Performing standard code review.

            ' }}
            ## Step 1: View the Changes

            You are already checked out on the PR branch. To see changes:
            ```bash
            git fetch origin main
            git diff origin/main...HEAD           # Full diff
            git diff origin/main...HEAD --stat    # Summary of changed files
            ```

            ## Step 2: Check Existing Review Comments

            Check for existing review comments using:
            ```bash
            gh pr view ${{ needs.request-setup.outputs.pr_number }} --comments
            ```

            For unresolved comment threads, decide if they should be resolved:
            - If the conversation is COMPLETE: Note it can be resolved
            - If changes were requested and made: Verify the fix
            - If more discussion needed: Leave unresolved

            ## Step 3: Review the Code

            Read the changed files and perform a thorough review:
            - Code quality and best practices
            - Potential bugs or edge cases
            - Test coverage adequacy
            - Security considerations

            ## Step 4: Submit Your Review

            Submit your review using `gh pr review ${{ needs.request-setup.outputs.pr_number }}` with ONE of:
            - `--approve` if ALL requirements met and code is good
            - `--request-changes -b "reason"` if changes are needed
            - `--comment -b "feedback"` if you have questions but no blocking issues

            IMPORTANT:
            - You may APPROVE but must NOT merge
            - A human will make the final merge decision
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 30"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  #############################################################################
  # REVIEW RESPONSE JOBS (triggered by any review on Claude PRs)
  # Responds to both self-reviews (claude[bot]) and human reviews
  # Identifies Claude PRs by branch prefix: feat/issue-*
  #############################################################################

  response-process:
    if: |
      github.event_name == 'pull_request_review' &&
      github.event.pull_request.draft == false &&
      startsWith(github.event.pull_request.head.ref, 'claude/issue/') &&
      (github.event.review.state == 'changes_requested' || github.event.review.state == 'commented')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@anthropic.com"

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          prompt: |
            A review was submitted on PR #${{ github.event.pull_request.number }}.

            Reviewer: ${{ github.event.review.user.login }}
            Review state: ${{ github.event.review.state }}
            Review body: ${{ github.event.review.body }}

            ## Step 1: Get Review Comments

            Fetch the comments from this review:
            ```
            gh api /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments
            ```

            Filter for comments from this review (review_id: ${{ github.event.review.id }}).

            ## Step 2: Process Each Comment

            ${{ github.event.review.user.login == 'claude[bot]' && '### Self-Review (your own review)
            For your own change requests, implement them directly:
            1. Make the requested change
            2. Commit with a clear message
            3. Reply noting the fix

            ' || '### External Review (from human or another reviewer)
            For each piece of feedback, CRITICALLY EVALUATE before acting:

            1. **Understand the request**: What exactly is being asked?
            2. **Evaluate pros/cons**: Is this change beneficial? Does it align with the issue requirements?
            3. **Decide your response**:
               - **ACCEPT**: If the feedback improves the code, implement it and reply with the commit
               - **PUSH BACK**: If you disagree, reply with clear reasoning explaining why
               - **CLARIFY**: If unclear, ask a follow-up question

            DO NOT blindly implement every request. You are the author of this PR and should
            defend good design decisions while remaining open to valid improvements.

            ' }}
            ### For QUESTIONS:
            - Answer thoughtfully with context from the codebase
            - If you need clarification, ask

            ## Step 3: Finalize

            After processing all comments, check if you made any commits:

            ### If you made commits (code changes):
            Push the changes:
            ```
            git push origin ${{ github.event.pull_request.head.ref }}
            ```
            The push will automatically convert PR to draft and trigger CI.
            CI-pass will mark it ready and re-request nopo-bot as reviewer when CI is green.

            ### If you made NO commits (only discussion/questions/pushback):
            Re-request nopo-bot as reviewer to continue the review loop:
            ```
            gh pr edit ${{ github.event.pull_request.number }} --add-reviewer "nopo-bot"
            ```
            This keeps the PR ready and continues the review loop.

            IMPORTANT:
            - Make atomic commits for each change
            - Reference the comment in each commit message
            - Follow CLAUDE.md guidelines for all code changes
            - Push back respectfully when you disagree with feedback
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 30"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
