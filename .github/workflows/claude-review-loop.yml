name: Claude Review Loop
'on':
  pull_request:
    types:
      - review_requested
  pull_request_review:
    types:
      - submitted
  workflow_dispatch:
    inputs:
      pr_number:
        description: PR number to review
        required: true
        type: string
      action:
        description: Action to simulate
        required: true
        type: choice
        options:
          - review
          - respond
concurrency:
  group: claude-review-${{ github.event.pull_request.head.ref }}
  cancel-in-progress: false
permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
defaults:
  run:
    shell: bash
jobs:
  request-setup:
    if: |-
      github.event_name == 'pull_request' &&
      github.event.requested_reviewer.login == 'nopo-bot'
    runs-on: ubuntu-latest
    outputs:
      pr_branch: ${{ github.event.pull_request.head.ref }}
      pr_number: ${{ github.event.pull_request.number }}
      is_draft: ${{ github.event.pull_request.draft }}
      issue_number: ${{ steps.issue.outputs.issue_number }}
      issue_body: ${{ steps.issue.outputs.issue_body }}
      has_issue: ${{ steps.issue.outputs.has_issue }}
      bot_comment_id: ${{ steps.bot_comment.outputs.comment_id }}
    steps:
      - id: check_draft
        name: Check if draft
        if: github.event.pull_request.draft == true
        run: |-
          echo "::warning::PR #${{ github.event.pull_request.number }} is a draft. Skipping review."
          exit 1
      - id: bot_comment
        name: gh pr comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BODY: |-
            ðŸ‘€ **nopo-bot** is reviewing this PR...

            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        run: |-
          comment_url=$(gh pr comment "$PR_NUMBER" --body "$BODY" --repo "$GITHUB_REPOSITORY" 2>&1)
          comment_id=$(echo "$comment_url" | grep -oE '[0-9]+$' || echo "")
          echo "comment_id=$comment_id" >> $GITHUB_OUTPUT
      - id: issue
        name: gh pr view (linked issue)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |2-
                  pr_body=$(gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" --json body --jq '.body')

                  # Extract issue number from PR body (Fixes #123 pattern)
                  issue_number=$(echo "$pr_body" | grep -oE '(Fixes|Closes|Resolves) #[0-9]+' | head -1 | grep -oE '[0-9]+' || echo "")

                  if [[ -n "$issue_number" ]]; then
                    echo "has_issue=true" >> $GITHUB_OUTPUT
                    echo "issue_number=$issue_number" >> $GITHUB_OUTPUT

                    # Fetch the linked issue body
                    issue_body=$(gh issue view "$issue_number" --repo "$GITHUB_REPOSITORY" --json body --jq '.body')
                    {
            echo 'issue_body<<EOF'
            $issue_body
            echo 'EOF'
          } >> $GITHUB_OUTPUT
                  else
                    echo "has_issue=false" >> $GITHUB_OUTPUT
                    echo "issue_number=" >> $GITHUB_OUTPUT
                    {
            echo 'issue_body<<EOF'
            
            echo 'EOF'
          } >> $GITHUB_OUTPUT
                  fi
  request-update-project:
    if: needs.request-setup.outputs.has_issue == 'true'
    runs-on: ubuntu-latest
    steps:
      - id: update_project_status
        name: gh api graphql (update project status)
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.request-setup.outputs.issue_number }}
          TARGET_STATUS: In review
        run: |2-
                repo_name="${GITHUB_REPOSITORY#*/}"
                owner="${GITHUB_REPOSITORY%/*}"

                # Find the project item
                result=$(gh api graphql -f query='query($owner: String!, $repo: String!, $issue: Int!) {
            repository(owner: $owner, name: $repo) {
              issue(number: $issue) {
                projectItems(first: 10) {
                  nodes {
                    id
                    project {
                      id
                      title
                      field(name: "Status") {
                        ... on ProjectV2SingleSelectField {
                          id
                          options { id name }
                        }
                      }
                    }
                  }
                }
              }
            }
          }' \
                  -F owner="$owner" \
                  -F repo="$repo_name" \
                  -F issue="$ISSUE_NUMBER" 2>/dev/null || echo "{}")

                # Extract project info
                item=$(echo "$result" | jq -r '.data.repository.issue.projectItems.nodes[0] // empty')
                if [[ -z "$item" ]]; then
                  echo "No project item found for issue #$ISSUE_NUMBER"
                  exit 0
                fi

                item_id=$(echo "$item" | jq -r '.id')
                project_id=$(echo "$item" | jq -r '.project.id')
                field_id=$(echo "$item" | jq -r '.project.field.id')
                option_id=$(echo "$item" | jq -r --arg status "$TARGET_STATUS" '.project.field.options[] | select(.name == $status) | .id')

                if [[ -z "$option_id" ]]; then
                  echo "Status '$TARGET_STATUS' not found in project"
                  exit 0
                fi

                # Update the status
                gh api graphql -f query='mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
            updateProjectV2ItemFieldValue(input: {
              projectId: $projectId
              itemId: $itemId
              fieldId: $fieldId
              value: { singleSelectOptionId: $optionId }
            }) {
              projectV2Item { id }
            }
          }' \
                  -F projectId="$project_id" \
                  -F itemId="$item_id" \
                  -F fieldId="$field_id" \
                  -F optionId="$option_id"

                echo "Updated project status to '$TARGET_STATUS'"
    needs:
      - request-setup
  request-review:
    if: always() && needs.request-setup.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - id: checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.request-setup.outputs.pr_branch }}
          fetch-depth: 0
      - id: claude_review
        uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/review.txt
          prompt_replacements: |-
            ${{ toJson(fromJson(format('{"PR_NUMBER": "{0}", "ISSUE_SECTION": "{1}"}',
                      needs.request-setup.outputs.pr_number,
                      needs.request-setup.outputs.has_issue == 'true' && format('## Linked Issue #{0}\n\n{1}\n\n## Validation\n- CHECK ALL TODO ITEMS in the issue are addressed\n- VERIFY code follows CLAUDE.md guidelines\n- ENSURE tests cover the requirements\n\n', needs.request-setup.outputs.issue_number, needs.request-setup.outputs.issue_body) || '## No Linked Issue\nPerforming standard code review.\n\n'))) }}
          max_turns: '50'
      - id: reaction_success
        name: gh api (add reaction)
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ needs.request-setup.outputs.bot_comment_id }}
          REACTION: rocket
        run: gh api "repos/$GITHUB_REPOSITORY/issues/comments/$COMMENT_ID/reactions" -f content="$REACTION"
      - id: reaction_failure
        name: gh api (add reaction)
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ needs.request-setup.outputs.bot_comment_id }}
          REACTION: eyes
        run: gh api "repos/$GITHUB_REPOSITORY/issues/comments/$COMMENT_ID/reactions" -f content="$REACTION"
      - id: remove_reviewer
        name: gh pr edit --remove-reviewer
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.request-setup.outputs.pr_number }}
          REVIEWERS: nopo-bot
        run: gh pr edit "$PR_NUMBER" --remove-reviewer "$REVIEWERS" --repo "$GITHUB_REPOSITORY" || true
    needs:
      - request-setup
      - request-update-project
  response-process:
    if: |-
      github.event_name == 'pull_request_review' &&
      github.event.review.user.login == 'claude[bot]' &&
      github.event.pull_request.draft == false &&
      (github.event.review.state == 'CHANGES_REQUESTED' || github.event.review.state == 'COMMENTED')
    runs-on: ubuntu-latest
    steps:
      - id: checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
      - id: git_config
        name: git config
        env:
          USER_NAME: Claude Bot
          USER_EMAIL: claude-bot@anthropic.com
        run: |-
          git config --global user.name "$USER_NAME"
          git config --global user.email "$USER_EMAIL"
      - id: claude_response
        uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/review-response.txt
          prompt_replacements: |-
            ${{ toJson(fromJson(format('{"PR_NUMBER": "{0}", "REVIEW_STATE": "{1}", "REVIEW_BODY": "{2}", "REPOSITORY": "{3}", "REVIEW_ID": "{4}", "HEAD_REF": "{5}"}',
                      github.event.pull_request.number,
                      github.event.review.state,
                      github.event.review.body,
                      github.repository,
                      github.event.review.id,
                      github.event.pull_request.head.ref))) }}
          max_turns: '50'
  human-review-response:
    if: |-
      github.event_name == 'pull_request_review' &&
      github.event.review.user.login != 'claude[bot]' &&
      github.event.pull_request.draft == false &&
      (github.event.review.state == 'CHANGES_REQUESTED' || github.event.review.state == 'COMMENTED')
    runs-on: ubuntu-latest
    steps:
      - id: check_author
        name: gh pr view (check claude)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |-
          pr=$(gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" --json headRefName,author)
          author=$(echo "$pr" | jq -r '.author.login')
          head_branch=$(echo "$pr" | jq -r '.headRefName')

          is_claude_pr="false"
          if [[ "$author" == "claude[bot]" || "$head_branch" == claude/* ]]; then
            is_claude_pr="true"
          fi

          echo "is_claude_pr=$is_claude_pr" >> $GITHUB_OUTPUT
      - id: checkout
        if: steps.check_author.outputs.is_claude_pr == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
      - id: git_config
        name: git config
        if: steps.check_author.outputs.is_claude_pr == 'true'
        env:
          USER_NAME: Claude Bot
          USER_EMAIL: claude-bot@anthropic.com
        run: |-
          git config --global user.name "$USER_NAME"
          git config --global user.email "$USER_EMAIL"
      - id: claude_human_response
        if: steps.check_author.outputs.is_claude_pr == 'true'
        uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/human-review-response.txt
          prompt_replacements: |-
            ${{ toJson(fromJson(format('{"REVIEWER_LOGIN": "{0}", "PR_NUMBER": "{1}", "REVIEW_STATE": "{2}", "REVIEW_BODY": "{3}", "REPOSITORY": "{4}", "REVIEW_ID": "{5}", "HEAD_REF": "{6}"}',
                      github.event.review.user.login,
                      github.event.pull_request.number,
                      github.event.review.state,
                      github.event.review.body,
                      github.repository,
                      github.event.review.id,
                      github.event.pull_request.head.ref))) }}
          max_turns: '50'
