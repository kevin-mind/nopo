# Test cleanup workflow
#
# Called by claude-test-runner when tests fail to clean up test issues
# Can also be triggered manually for cleanup
#
# Features:
# - Closes issues, sub-issues, and PRs
# - Verification job waits 3 min then re-checks state
# - Retries cleanup once if state is not as expected

name: Test Cleanup

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to clean up'
        required: true
        type: string
      action:
        description: 'Cleanup action: close | cleanup | delete'
        required: false
        default: 'close'
        type: choice
        options:
          - close
          - cleanup
          - delete
      is_retry:
        description: 'Internal: Whether this is a retry attempt'
        required: false
        default: 'false'
        type: string

  # Allow calling from other workflows
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number to clean up'
        required: true
        type: string
      action:
        description: 'Cleanup action: close | cleanup | delete'
        required: false
        default: 'close'
        type: string
      is_retry:
        description: 'Internal: Whether this is a retry attempt'
        required: false
        default: 'false'
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ inputs.issue_number }}
      action: ${{ inputs.action }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'
          cache-dependency-path: '.github/actions-ts/package-lock.json'

      - name: Install dependencies
        run: npm ci
        working-directory: .github/actions-ts

      - name: Run cleanup
        uses: ./.github/actions-ts/claude-test-helper
        with:
          action: ${{ inputs.action }}
          issue_number: ${{ inputs.issue_number }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}

      - name: Report result
        run: |
          echo "Cleanup complete for issue #${{ inputs.issue_number }}"
          echo "Action: ${{ inputs.action }}"

  # Verification job - runs 3 min after cleanup to ensure state is correct
  # Only runs on first attempt (not retry) to prevent infinite loops
  verify:
    needs: cleanup
    if: inputs.is_retry != 'true' && inputs.action == 'close'
    runs-on: ubuntu-latest
    steps:
      - name: Wait for GitHub Project automations
        run: |
          echo "Waiting 3 minutes for GitHub Project automations to complete..."
          sleep 180

      - name: Verify cleanup state
        id: verify
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
        run: |
          echo "Verifying cleanup state for issue #$ISSUE_NUMBER"

          needs_retry=false

          # Check parent issue state
          issue_state=$(gh issue view $ISSUE_NUMBER --repo ${{ github.repository }} --json state --jq '.state')
          echo "Parent issue state: $issue_state"

          if [[ "$issue_state" != "CLOSED" ]]; then
            echo "::warning::Parent issue #$ISSUE_NUMBER is not closed (state: $issue_state)"
            needs_retry=true
          fi

          # Get sub-issues and project status via GraphQL
          response=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!, $projectNumber: Int!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $number) {
                  state
                  projectItems(first: 10) {
                    nodes {
                      project { number }
                      fieldValues(first: 20) {
                        nodes {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            name
                            field { ... on ProjectV2SingleSelectField { name } }
                          }
                        }
                      }
                    }
                  }
                  subIssues(first: 20) {
                    nodes {
                      number
                      state
                      projectItems(first: 10) {
                        nodes {
                          project { number }
                          fieldValues(first: 20) {
                            nodes {
                              ... on ProjectV2ItemFieldSingleSelectValue {
                                name
                                field { ... on ProjectV2SingleSelectField { name } }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          ' -f owner=${{ github.repository_owner }} -f repo=${{ github.event.repository.name }} -F number=$ISSUE_NUMBER -F projectNumber=${{ vars.PROJECT_NUMBER || 1 }})

          # Extract parent issue project status
          parent_status=$(echo "$response" | jq -r '
            .data.repository.issue.projectItems.nodes[]
            | select(.project.number == ${{ vars.PROJECT_NUMBER || 1 }})
            | .fieldValues.nodes[]
            | select(.field.name == "Status")
            | .name
          ' 2>/dev/null || echo "unknown")
          echo "Parent issue project status: $parent_status"

          if [[ "$parent_status" != "Done" && "$parent_status" != "unknown" ]]; then
            echo "::warning::Parent issue #$ISSUE_NUMBER project status is not Done (status: $parent_status)"
            # Don't retry for status - GitHub Project automation should handle it
          fi

          # Get sub-issues
          sub_issues=$(echo "$response" | jq -r '.data.repository.issue.subIssues.nodes // []')
          echo "Sub-issues: $(echo "$sub_issues" | jq -c '.')"

          # Check each sub-issue
          for row in $(echo "$sub_issues" | jq -r '.[] | @base64'); do
            _jq() {
              echo ${row} | base64 --decode | jq -r ${1}
            }

            sub_number=$(_jq '.number')
            sub_state=$(_jq '.state')
            sub_status=$(_jq ".projectItems.nodes[] | select(.project.number == ${{ vars.PROJECT_NUMBER || 1 }}) | .fieldValues.nodes[] | select(.field.name == \"Status\") | .name" 2>/dev/null || echo "unknown")

            echo "  Sub-issue #$sub_number: state=$sub_state, project_status=$sub_status"

            if [[ "$sub_state" != "CLOSED" ]]; then
              echo "::warning::Sub-issue #$sub_number is not closed (state: $sub_state)"
              needs_retry=true
            fi
          done

          # Check for open PRs linked to the issue
          prs=$(gh pr list --repo ${{ github.repository }} --search "linked:issue:$ISSUE_NUMBER" --json number,state --jq '.[] | select(.state == "OPEN") | .number')

          if [[ -n "$prs" ]]; then
            echo "::warning::Found open PRs linked to issue: $prs"
            needs_retry=true
          fi

          echo "needs_retry=$needs_retry" >> $GITHUB_OUTPUT

      - name: Trigger retry cleanup
        if: steps.verify.outputs.needs_retry == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::notice::Re-running cleanup due to incomplete state"
          gh workflow run _test_cleanup.yml \
            --repo ${{ github.repository }} \
            --field issue_number=${{ inputs.issue_number }} \
            --field action=${{ inputs.action }} \
            --field is_retry=true
          echo "Retry cleanup triggered"

      - name: Report verification result
        run: |
          if [[ "${{ steps.verify.outputs.needs_retry }}" == "true" ]]; then
            echo "::warning::Cleanup verification failed - retry triggered"
          else
            echo "::notice::Cleanup verification passed - all resources cleaned up"
          fi
