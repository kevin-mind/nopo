name: Manage Issue

# Manage an issue and its sub-issues with different methods:
# - reset: Re-open closed issues, set parent to "Backlog", sub-issues to "Ready"
# - close: Close all issues, set statuses to "Done"
# - delete: Permanently delete the issue and sub-issues (requires _e2e label)

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to manage'
        required: true
        type: string
      method:
        description: 'Method to apply'
        required: true
        type: choice
        options:
          - reset
          - close
          - delete

permissions:
  contents: read
  issues: write

jobs:
  manage-issue:
    runs-on: ubuntu-latest
    # Delete action requires special approval environment
    environment: ${{ inputs.method == 'delete' && 'delete-approval' || '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: ${{ inputs.method == 'reset' && 'Reset Issue' || inputs.method == 'close' && 'Close Issue' || 'Delete Issue' }}
        id: action
        uses: ./.github/actions-ts/claude-test-helper
        with:
          action: ${{ inputs.method }}
          issue_number: ${{ inputs.issue_number }}
          github_token: ${{ secrets.NOPO_BOT_PAT }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}

      - name: Write Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # Issue ${{ inputs.method == 'reset' && 'Reset' || inputs.method == 'close' && 'Closed' || 'Deleted' }}

          | Property | Value |
          |----------|-------|
          | **Issue** | [#${{ inputs.issue_number }}](${{ github.server_url }}/${{ github.repository }}/issues/${{ inputs.issue_number }}) |
          | **Method** | ${{ inputs.method }} |
          EOF

          if [[ "${{ inputs.method }}" == "reset" ]]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          | **Issues Reopened** | ${{ steps.action.outputs.reset_count || 0 }} |

          The issue and any sub-issues have been:
          - Re-opened (if closed)
          - Parent status set to **Backlog**
          - Sub-issue statuses set to **Ready**
          EOF
          elif [[ "${{ inputs.method }}" == "close" ]]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          | **Issues Closed** | ${{ steps.action.outputs.close_count || 0 }} |

          The issue and any sub-issues have been:
          - Closed
          - All statuses set to **Done**
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          | **Issues Deleted** | ${{ steps.action.outputs.delete_count || 0 }} |

          **⚠️ The issue and all sub-issues have been permanently deleted.**
          EOF
          fi
