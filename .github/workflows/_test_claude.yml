name: Test Claude Automation
run-name: "Test Claude - ${{ inputs.job || 'all' }}${{ github.event_name == 'schedule' && ' (scheduled)' || '' }}"
on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      job:
        description: 'Job to test (all = run all tests)'
        required: true
        type: choice
        options:
          - all
          - unit-tests
          - issue-triage
          - issue-implement
          - ci-fix
          - ci-suggest
          - pr-review
          - discussion-research
          - detect-event
      resource_number:
        description: 'Issue/PR/Discussion number (creates test resource if empty)'
        required: false
        type: string
        default: ''
      mock_mode:
        description: 'Mock mode (true = no real Claude calls)'
        type: string
        default: 'false'
      cleanup:
        description: 'Clean up test data after test'
        type: boolean
        default: true

  # Called by CI workflow
  workflow_call:
    inputs:
      job:
        description: 'Job to test'
        required: true
        type: string
      resource_number:
        description: 'Issue/PR/Discussion number'
        required: false
        type: string
        default: ''
      mock_mode:
        description: 'Mock mode'
        type: string
        default: 'false'
      cleanup:
        description: 'Clean up test data after test'
        type: boolean
        default: true

  # Daily integration test at midnight UTC
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write
  issues: write
  pull-requests: write
  discussions: write
  actions: write
  id-token: write

# ============================================================================
# UNIT TESTS
# ============================================================================
jobs:
  unit-tests:
    if: inputs.job == 'unit-tests' || inputs.job == 'all' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - name: Run GitHub Actions tests
        run: pnpm run --filter @nopo/github-actions test

  # ============================================================================
  # DETECT EVENT ACTION TEST
  # ============================================================================
  detect-event:
    if: inputs.job == 'detect-event' || inputs.job == 'all' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create test issue
        id: test_issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_url=$(gh issue create \
            --title "[TEST] Detect event test - $(date +%s)" \
            --body "Test issue for detect-event action" \
            --label "test:automation,skip-dispatch")
          issue_number="${issue_url##*/}"
          echo "issue_number=$issue_number" >> $GITHUB_OUTPUT

      - name: Run detect-event action
        id: detect
        uses: ./.github/actions-ts/claude-detect-event
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_EVENT_NAME: issues
          GITHUB_EVENT_PATH: /tmp/test-event.json

      - name: Verify detection outputs
        run: |
          echo "Job: ${{ steps.detect.outputs.job }}"
          echo "Resource Type: ${{ steps.detect.outputs.resource_type }}"
          echo "Skip: ${{ steps.detect.outputs.skip }}"

      - name: Cleanup test issue
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.test_issue.outputs.issue_number }}
        run: |
          gh issue close "$ISSUE_NUMBER" --reason "not planned" || true

  # ============================================================================
  # ISSUE TRIAGE TEST (inline workflow_call)
  # ============================================================================
  issue-triage-setup:
    if: inputs.job == 'issue-triage' || inputs.job == 'all' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    outputs:
      context_json: ${{ steps.context.outputs.json }}
      issue_number: ${{ steps.issue.outputs.number }}
    steps:
      - uses: actions/checkout@v4

      - name: Create test issue
        if: inputs.resource_number == ''
        id: create
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_url=$(gh issue create \
            --title "[TEST] Triage test - $(date +%s)" \
            --body "Test issue for triage workflow.

          ## Description
          This is an automated test issue.

          ## Priority
          Medium

          ## Todo
          - [ ] Test task 1
          - [ ] Test task 2" \
            --label "test:automation,skip-dispatch")
          echo "issue_number=${issue_url##*/}" >> $GITHUB_OUTPUT

      - name: Set issue number
        id: issue
        run: |
          if [[ -n "${{ inputs.resource_number }}" ]]; then
            echo "number=${{ inputs.resource_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ steps.create.outputs.issue_number }}" >> $GITHUB_OUTPUT
          fi

      - name: Build context JSON
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
        run: |
          issue=$(gh issue view "$ISSUE_NUMBER" --json title,body)
          title=$(echo "$issue" | jq -r '.title')
          body=$(echo "$issue" | jq -r '.body')

          json=$(jq -nc \
            --arg num "$ISSUE_NUMBER" \
            --arg title "$title" \
            --arg body "$body" \
            '{issue_number: $num, issue_title: $title, issue_body: $body}')
          echo "json=$json" >> $GITHUB_OUTPUT

  issue-triage-run:
    needs: issue-triage-setup
    if: needs.issue-triage-setup.result == 'success'
    uses: ./.github/workflows/_claude.yml
    with:
      job: issue-triage
      context_json: ${{ needs.issue-triage-setup.outputs.context_json }}
      mock_mode: ${{ inputs.mock_mode }}
    secrets: inherit

  issue-triage-verify:
    needs: [issue-triage-setup, issue-triage-run]
    if: always() && needs.issue-triage-setup.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Verify triage results
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.issue-triage-setup.outputs.issue_number }}
          MOCK_MODE: ${{ inputs.mock_mode }}
          RUN_RESULT: ${{ needs.issue-triage-run.result }}
        run: |
          echo "Run result: $RUN_RESULT"
          echo "Verifying triage for issue #$ISSUE_NUMBER"
          issue_data=$(gh issue view "$ISSUE_NUMBER" --json labels,comments)
          echo "$issue_data" | jq .

          if [[ "$MOCK_MODE" != "true" && "$RUN_RESULT" == "success" ]]; then
            if echo "$issue_data" | jq -e '.labels[].name | select(. == "triaged")' > /dev/null 2>&1; then
              echo "âœ… Issue has 'triaged' label"
            else
              echo "âš ï¸ Issue does not have 'triaged' label"
            fi
          fi

  # ============================================================================
  # ISSUE IMPLEMENT TEST (inline workflow_call)
  # ============================================================================
  issue-implement-setup:
    if: inputs.job == 'issue-implement' || inputs.job == 'all' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    outputs:
      context_json: ${{ steps.context.outputs.json }}
      issue_number: ${{ steps.issue.outputs.number }}
    steps:
      - uses: actions/checkout@v4

      - name: Create test issue
        if: inputs.resource_number == ''
        id: create
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_url=$(gh issue create \
            --title "[TEST] Implement test - $(date +%s)" \
            --body "## Description
          Add a test comment to AGENTS.md

          ## Todo
          - [ ] Add a comment at the end of AGENTS.md" \
            --label "test:automation,skip-dispatch")
          echo "issue_number=${issue_url##*/}" >> $GITHUB_OUTPUT

      - name: Set issue number
        id: issue
        run: |
          if [[ -n "${{ inputs.resource_number }}" ]]; then
            echo "number=${{ inputs.resource_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ steps.create.outputs.issue_number }}" >> $GITHUB_OUTPUT
          fi

      - name: Build context JSON
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
        run: |
          issue=$(gh issue view "$ISSUE_NUMBER" --json title,body)
          title=$(echo "$issue" | jq -r '.title')
          body=$(echo "$issue" | jq -r '.body')
          branch="claude/issue/$ISSUE_NUMBER"

          json=$(jq -nc \
            --arg num "$ISSUE_NUMBER" \
            --arg title "$title" \
            --arg body "$body" \
            --arg branch "$branch" \
            '{issue_number: $num, issue_title: $title, issue_body: $body, branch_name: $branch}')
          echo "json=$json" >> $GITHUB_OUTPUT

      - name: Create branch for test
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
        run: |
          branch="claude/issue/$ISSUE_NUMBER"
          # Create branch from main if it doesn't exist
          if ! git ls-remote --heads origin "$branch" | grep -q "$branch"; then
            git checkout -b "$branch"
            git push origin "$branch"
            echo "âœ“ Created branch $branch"
          else
            echo "Branch $branch already exists"
          fi

  issue-implement-run:
    needs: issue-implement-setup
    if: needs.issue-implement-setup.result == 'success'
    uses: ./.github/workflows/_claude.yml
    with:
      job: issue-implement
      context_json: ${{ needs.issue-implement-setup.outputs.context_json }}
      mock_mode: ${{ inputs.mock_mode }}
    secrets: inherit

  # ============================================================================
  # PR PREPARE (creates test PR for ci-fix, ci-suggest, pr-review tests)
  # ============================================================================
  pr-prepare:
    if: |
      (inputs.job == 'ci-fix' || inputs.job == 'ci-suggest' || inputs.job == 'pr-review' || inputs.job == 'all' || github.event_name == 'schedule') &&
      (inputs.resource_number == '' || github.event_name == 'schedule')
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.pr.outputs.number }}
      issue_number: ${{ steps.issue.outputs.number }}
      branch_name: ${{ steps.branch.outputs.name }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create test issue
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_url=$(gh issue create \
            --title "[TEST] PR test - $(date +%s)" \
            --body "## Description
          Test issue for PR workflow tests.

          ## Todo
          - [ ] Test task" \
            --label "test:automation,skip-dispatch")
          echo "number=${issue_url##*/}" >> $GITHUB_OUTPUT

      - name: Create branch
        id: branch
        env:
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
        run: |
          branch="claude/issue/$ISSUE_NUMBER"
          git checkout -b "$branch"
          echo "name=$branch" >> $GITHUB_OUTPUT

      - name: Make test change
        run: |
          # Add a test file (not a workflow file, to avoid needing workflows permission)
          echo "# Test change for PR ${{ steps.issue.outputs.number }} - $(date +%s)" > /tmp/test-change.md
          mkdir -p .test
          cp /tmp/test-change.md .test/test-change-${{ steps.issue.outputs.number }}.md
          git add .test/
          git commit -m "test: add test change for PR tests"
          git push origin "${{ steps.branch.outputs.name }}"

      - name: Create draft PR
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.number }}
          BRANCH_NAME: ${{ steps.branch.outputs.name }}
        run: |
          pr_url=$(gh pr create \
            --title "[TEST] PR for workflow tests" \
            --body "Fixes #$ISSUE_NUMBER

          Test PR for ci-fix, ci-suggest, and pr-review workflow tests." \
            --head "$BRANCH_NAME" \
            --draft)
          echo "number=${pr_url##*/}" >> $GITHUB_OUTPUT

  # ============================================================================
  # CI FIX TEST
  # ============================================================================
  ci-fix-setup:
    needs: [pr-prepare]
    if: |
      always() &&
      (inputs.job == 'ci-fix' || inputs.job == 'all' || github.event_name == 'schedule') &&
      (inputs.resource_number != '' || needs.pr-prepare.outputs.pr_number != '')
    runs-on: ubuntu-latest
    outputs:
      context_json: ${{ steps.context.outputs.json }}
    steps:
      - uses: actions/checkout@v4

      - name: Build context JSON
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ inputs.resource_number || needs.pr-prepare.outputs.pr_number }}
        run: |
          pr=$(gh pr view "$PR_NUMBER" --json headRefName)
          branch=$(echo "$pr" | jq -r '.headRefName')

          json=$(jq -nc \
            --arg pr "$PR_NUMBER" \
            --arg branch "$branch" \
            '{pr_number: $pr, branch_name: $branch}')
          echo "json=$json" >> $GITHUB_OUTPUT

  ci-fix-run:
    needs: ci-fix-setup
    if: needs.ci-fix-setup.result == 'success'
    uses: ./.github/workflows/_claude.yml
    with:
      job: ci-fix
      context_json: ${{ needs.ci-fix-setup.outputs.context_json }}
      mock_mode: ${{ inputs.mock_mode }}
    secrets: inherit

  # ============================================================================
  # CI SUGGEST TEST
  # ============================================================================
  ci-suggest-setup:
    needs: [pr-prepare]
    if: |
      always() &&
      (inputs.job == 'ci-suggest' || inputs.job == 'all' || github.event_name == 'schedule') &&
      (inputs.resource_number != '' || needs.pr-prepare.outputs.pr_number != '')
    runs-on: ubuntu-latest
    outputs:
      context_json: ${{ steps.context.outputs.json }}
    steps:
      - uses: actions/checkout@v4

      - name: Build context JSON
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ inputs.resource_number || needs.pr-prepare.outputs.pr_number }}
        run: |
          pr=$(gh pr view "$PR_NUMBER" --json headRefName)
          branch=$(echo "$pr" | jq -r '.headRefName')

          json=$(jq -nc \
            --arg pr "$PR_NUMBER" \
            --arg branch "$branch" \
            '{pr_number: $pr, branch_name: $branch}')
          echo "json=$json" >> $GITHUB_OUTPUT

  ci-suggest-run:
    needs: ci-suggest-setup
    if: needs.ci-suggest-setup.result == 'success'
    uses: ./.github/workflows/_claude.yml
    with:
      job: ci-suggest
      context_json: ${{ needs.ci-suggest-setup.outputs.context_json }}
      mock_mode: ${{ inputs.mock_mode }}
    secrets: inherit

  # ============================================================================
  # PR REVIEW TEST
  # ============================================================================
  pr-review-setup:
    needs: [pr-prepare]
    if: |
      always() &&
      (inputs.job == 'pr-review' || inputs.job == 'all' || github.event_name == 'schedule') &&
      (inputs.resource_number != '' || needs.pr-prepare.outputs.pr_number != '')
    runs-on: ubuntu-latest
    outputs:
      context_json: ${{ steps.context.outputs.json }}
    steps:
      - uses: actions/checkout@v4

      - name: Build context JSON
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ inputs.resource_number || needs.pr-prepare.outputs.pr_number }}
        run: |
          pr=$(gh pr view "$PR_NUMBER" --json headRefName,body)
          branch=$(echo "$pr" | jq -r '.headRefName')

          # Extract issue section from PR body if present
          body=$(echo "$pr" | jq -r '.body // ""')
          issue_section=""
          if echo "$body" | grep -q "Fixes #"; then
            issue_num=$(echo "$body" | grep -oE 'Fixes #[0-9]+' | head -1 | grep -oE '[0-9]+')
            if [[ -n "$issue_num" ]]; then
              issue_section=$(gh issue view "$issue_num" --json body --jq '.body // ""' 2>/dev/null || echo "")
            fi
          fi

          json=$(jq -nc \
            --arg pr "$PR_NUMBER" \
            --arg branch "$branch" \
            --arg issue "$issue_section" \
            '{pr_number: $pr, branch_name: $branch, issue_section: $issue}')
          echo "json=$json" >> $GITHUB_OUTPUT

  pr-review-run:
    needs: pr-review-setup
    if: needs.pr-review-setup.result == 'success'
    uses: ./.github/workflows/_claude.yml
    with:
      job: pr-review
      context_json: ${{ needs.pr-review-setup.outputs.context_json }}
      mock_mode: ${{ inputs.mock_mode }}
    secrets: inherit

  # ============================================================================
  # DISCUSSION RESEARCH TEST (inline workflow_call)
  # ============================================================================
  discussion-research-setup:
    if: inputs.job == 'discussion-research' || inputs.job == 'all' || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    outputs:
      context_json: ${{ steps.context.outputs.json }}
      discussion_number: ${{ steps.discussion.outputs.number }}
    steps:
      - uses: actions/checkout@v4

      - name: Create test discussion
        if: inputs.resource_number == ''
        id: create
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          result=$(gh api graphql -f query='
            mutation($repoId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
              createDiscussion(input: {
                repositoryId: $repoId,
                categoryId: $categoryId,
                title: $title,
                body: $body
              }) {
                discussion { number }
              }
            }
          ' \
            -f repoId="$(gh repo view --json id -q '.id')" \
            -f categoryId="$(gh api graphql -f query='query($owner: String!, $repo: String!) { repository(owner: $owner, name: $repo) { discussionCategories(first: 1) { nodes { id } } } }' -f owner="${GITHUB_REPOSITORY%/*}" -f repo="${GITHUB_REPOSITORY#*/}" -q '.data.repository.discussionCategories.nodes[0].id')" \
            -f title="[TEST] Research test - $(date +%s)" \
            -f body="## Question
          How does the Claude automation architecture work?

          ## Context
          I want to understand the workflow dispatch pattern.")

          echo "discussion_number=$(echo "$result" | jq -r '.data.createDiscussion.discussion.number')" >> $GITHUB_OUTPUT

      - name: Set discussion number
        id: discussion
        run: |
          if [[ -n "${{ inputs.resource_number }}" ]]; then
            echo "number=${{ inputs.resource_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ steps.create.outputs.discussion_number }}" >> $GITHUB_OUTPUT
          fi

      - name: Build context JSON
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_NUMBER: ${{ steps.discussion.outputs.number }}
        run: |
          result=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                discussion(number: $number) {
                  title
                  body
                }
              }
            }
          ' -f owner="${GITHUB_REPOSITORY%/*}" -f repo="${GITHUB_REPOSITORY#*/}" -F number="$DISCUSSION_NUMBER")

          title=$(echo "$result" | jq -r '.data.repository.discussion.title')
          body=$(echo "$result" | jq -r '.data.repository.discussion.body')

          json=$(jq -nc \
            --arg num "$DISCUSSION_NUMBER" \
            --arg title "$title" \
            --arg body "$body" \
            '{discussion_number: $num, discussion_title: $title, discussion_body: $body}')
          echo "json=$json" >> $GITHUB_OUTPUT

  discussion-research-run:
    needs: discussion-research-setup
    if: needs.discussion-research-setup.result == 'success'
    uses: ./.github/workflows/_claude.yml
    with:
      job: discussion-research
      context_json: ${{ needs.discussion-research-setup.outputs.context_json }}
      mock_mode: ${{ inputs.mock_mode }}
    secrets: inherit

  # ============================================================================
  # CLEANUP
  # ============================================================================
  cleanup-issue:
    needs: [issue-triage-setup, issue-triage-run, issue-implement-setup, issue-implement-run]
    if: |
      always() &&
      (inputs.cleanup == true || github.event_name == 'schedule') &&
      (inputs.resource_number == '' || github.event_name == 'schedule')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Cleanup test issues and branches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TRIAGE_ISSUE: ${{ needs.issue-triage-setup.outputs.issue_number }}
          IMPLEMENT_ISSUE: ${{ needs.issue-implement-setup.outputs.issue_number }}
        run: |
          # Safe to close: resource_number=='' means these were created by this test run
          for issue in $TRIAGE_ISSUE $IMPLEMENT_ISSUE; do
            if [[ -n "$issue" ]]; then
              echo "âœ“ Closing test issue #$issue"
              gh issue close "$issue" --reason "not planned" --comment "ðŸ§¹ Test cleanup" || true

              # Delete associated branch if it exists
              branch="claude/issue/$issue"
              if git ls-remote --heads origin "$branch" | grep -q "$branch"; then
                echo "âœ“ Deleting branch $branch"
                git push origin --delete "$branch" || true
              fi

              # Close any PRs from that branch
              pr_num=$(gh pr list --head "$branch" --json number --jq '.[0].number' 2>/dev/null || echo "")
              if [[ -n "$pr_num" ]]; then
                echo "âœ“ Closing PR #$pr_num"
                gh pr close "$pr_num" --comment "ðŸ§¹ Test cleanup" || true
              fi
            fi
          done

  cleanup-discussion:
    needs: [discussion-research-setup, discussion-research-run]
    if: |
      always() &&
      (inputs.cleanup == true || github.event_name == 'schedule') &&
      (inputs.resource_number == '' || github.event_name == 'schedule')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Close test discussion
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_NUMBER: ${{ needs.discussion-research-setup.outputs.discussion_number }}
        run: |
          if [[ -n "$DISCUSSION_NUMBER" ]]; then
            echo "âœ“ Closing test discussion #$DISCUSSION_NUMBER"

            # Get discussion ID
            discussion_id=$(gh api graphql -f query='
              query($owner: String!, $repo: String!, $number: Int!) {
                repository(owner: $owner, name: $repo) {
                  discussion(number: $number) { id }
                }
              }
            ' -f owner="${GITHUB_REPOSITORY%/*}" -f repo="${GITHUB_REPOSITORY#*/}" -F number="$DISCUSSION_NUMBER" \
              --jq '.data.repository.discussion.id')

            # Close the discussion
            gh api graphql -f query='
              mutation($id: ID!) {
                closeDiscussion(input: { discussionId: $id, reason: OUTDATED }) {
                  discussion { id }
                }
              }
            ' -f id="$discussion_id" || echo "Warning: Could not close discussion"
          fi

  cleanup-pr:
    needs: [pr-prepare, ci-fix-run, ci-suggest-run, pr-review-run]
    if: |
      always() &&
      (inputs.cleanup == true || github.event_name == 'schedule') &&
      (inputs.resource_number == '' || github.event_name == 'schedule') &&
      needs.pr-prepare.outputs.pr_number != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Cleanup test PR and resources
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.pr-prepare.outputs.pr_number }}
          ISSUE_NUMBER: ${{ needs.pr-prepare.outputs.issue_number }}
          BRANCH_NAME: ${{ needs.pr-prepare.outputs.branch_name }}
        run: |
          # Close PR
          if [[ -n "$PR_NUMBER" ]]; then
            echo "âœ“ Closing test PR #$PR_NUMBER"
            gh pr close "$PR_NUMBER" --comment "ðŸ§¹ Test cleanup" --delete-branch || true
          fi

          # Close issue
          if [[ -n "$ISSUE_NUMBER" ]]; then
            echo "âœ“ Closing test issue #$ISSUE_NUMBER"
            gh issue close "$ISSUE_NUMBER" --reason "not planned" --comment "ðŸ§¹ Test cleanup" || true
          fi

          # Delete branch if still exists
          if [[ -n "$BRANCH_NAME" ]] && git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "âœ“ Deleting branch $BRANCH_NAME"
            git push origin --delete "$BRANCH_NAME" || true
          fi

  # ============================================================================
  # FAILURE REPORTING (scheduled runs only)
  # ============================================================================
  report-failure:
    needs:
      - unit-tests
      - detect-event
      - issue-triage-run
      - issue-implement-run
      - ci-fix-run
      - ci-suggest-run
      - pr-review-run
      - discussion-research-run
      - cleanup-issue
      - cleanup-discussion
      - cleanup-pr
    if: |
      always() &&
      github.event_name == 'schedule' &&
      (needs.unit-tests.result == 'failure' ||
       needs.detect-event.result == 'failure' ||
       needs.issue-triage-run.result == 'failure' ||
       needs.issue-implement-run.result == 'failure' ||
       needs.ci-fix-run.result == 'failure' ||
       needs.ci-suggest-run.result == 'failure' ||
       needs.pr-review-run.result == 'failure' ||
       needs.discussion-research-run.result == 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Collect failure information
        id: failures
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_ID: ${{ github.run_id }}
        run: |
          echo "Collecting failure information from run $RUN_ID..."

          # Get failed jobs
          failed_jobs=$(gh run view "$RUN_ID" --json jobs --jq '[.jobs[] | select(.conclusion == "failure") | .name] | join(", ")')
          echo "failed_jobs=$failed_jobs" >> $GITHUB_OUTPUT

          # Get failed job logs (truncated to avoid huge issues)
          logs=$(gh run view "$RUN_ID" --log-failed 2>&1 | head -200 || echo "Could not retrieve logs")

          # Save logs to file for multiline output
          echo "$logs" > /tmp/failed_logs.txt
          echo "logs_file=/tmp/failed_logs.txt" >> $GITHUB_OUTPUT

      - name: Create bug issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FAILED_JOBS: ${{ steps.failures.outputs.failed_jobs }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          logs=$(cat /tmp/failed_logs.txt)

          # Create issue body
          body=$(cat <<EOF
          ## ðŸš¨ Scheduled Claude Integration Test Failed

          **Run URL:** $RUN_URL
          **Failed Jobs:** $FAILED_JOBS
          **Trigger:** Scheduled daily integration test

          ## Failed Job Logs (truncated)

          \`\`\`
          $logs
          \`\`\`

          ## Action Required

          1. Review the [failed workflow run]($RUN_URL)
          2. Identify the root cause
          3. Fix the issue and verify with a manual test run

          ---
          *This issue was automatically created by the scheduled Claude integration test.*
          EOF
          )

          gh issue create \
            --title "ðŸ”´ Scheduled Claude Test Failed - $(date +%Y-%m-%d)" \
            --body "$body" \
            --label "bug,claude-automation"
