name: Test Claude Automation
run-name: "Test Claude - ${{ inputs.job || 'all' }}"
on:
  # Manual trigger for debugging
  workflow_dispatch:
    inputs:
      job:
        description: 'Job to test (all = run all tests)'
        required: true
        type: choice
        options:
          - all
          - unit-tests
          - detect-event
          - issue-triage
          - issue-implement
          - issue-comment
          - ci-fix
          - ci-suggest
          - pr-review
          - pr-response
          - pr-human-response
          - discussion-research
          - discussion-respond
          - discussion-summarize
          - discussion-plan

  # Called by CI workflow
  workflow_call:
    inputs:
      job:
        description: 'Job to test'
        required: true
        type: string
      mock_mode:
        description: 'Mock mode (always true in CI)'
        type: boolean
        default: true

# Note: These permissions are required by _claude.yml's declaration even though
# mock mode doesn't actually use write permissions
permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

# ============================================================================
# TEST JOBS
# ============================================================================
jobs:
  # ============================================================================
  # UNIT TESTS - Test TypeScript action logic directly
  # ============================================================================
  unit-tests:
    if: inputs.job == 'unit-tests' || inputs.job == 'all'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - name: Run GitHub Actions tests
        run: pnpm run --filter @nopo/github-actions test

  # ============================================================================
  # DETECT EVENT - Test event detection with mock event data
  # ============================================================================
  detect-event:
    if: inputs.job == 'detect-event' || inputs.job == 'all'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node

      - name: Create mock issue event
        run: |
          mkdir -p /tmp/test-events
          cat > /tmp/test-events/issue-opened.json << 'EOF'
          {
            "action": "opened",
            "issue": {
              "number": 99999,
              "title": "Mock test issue",
              "body": "This is a mock issue for testing",
              "labels": [],
              "user": { "login": "test-user" }
            },
            "repository": {
              "owner": { "login": "${{ github.repository_owner }}" },
              "name": "${{ github.event.repository.name }}"
            }
          }
          EOF

      - name: Test issue-opened detection
        id: detect-issue
        uses: ./.github/actions-ts/claude-detect-event
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_EVENT_NAME: issues
          GITHUB_EVENT_PATH: /tmp/test-events/issue-opened.json

      - name: Verify issue detection
        run: |
          echo "Testing issue-opened event detection..."
          echo "Job: ${{ steps.detect-issue.outputs.job }}"
          echo "Resource Type: ${{ steps.detect-issue.outputs.resource_type }}"
          echo "Skip: ${{ steps.detect-issue.outputs.skip }}"

          # Verify outputs
          if [[ "${{ steps.detect-issue.outputs.resource_type }}" != "issue" ]]; then
            echo "ERROR: Expected resource_type=issue"
            exit 1
          fi
          echo "âœ“ Issue detection passed"

  # ============================================================================
  # WORKFLOW LOGIC TESTS - Test _claude.yml jobs with mock context
  # Uses mock_mode=true so no real Claude calls or git operations happen
  # ============================================================================

  # Test issue-triage job
  issue-triage:
    if: inputs.job == 'issue-triage' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: issue-triage
      context_json: '{"issue_number":"99999","issue_title":"Mock test issue","issue_body":"Test body for triage"}'
      mock_mode: true
    secrets: inherit

  # Test issue-implement job
  issue-implement:
    if: inputs.job == 'issue-implement' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: issue-implement
      context_json: '{"issue_number":"99999","issue_title":"Mock implement test","issue_body":"## Todo\n- [ ] Test task","branch_name":"test/mock/99999","existing_branch":"false"}'
      mock_mode: true
    secrets: inherit

  # Test issue-comment job
  issue-comment:
    if: inputs.job == 'issue-comment' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: issue-comment
      context_json: '{"issue_number":"99999","context_type":"issue","context_description":"Mock issue for comment test"}'
      mock_mode: true
    secrets: inherit

  # Test ci-fix job
  ci-fix:
    if: inputs.job == 'ci-fix' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: ci-fix
      context_json: '{"pr_number":"99999","branch_name":"test/mock/99999"}'
      mock_mode: true
    secrets: inherit

  # Test ci-suggest job
  ci-suggest:
    if: inputs.job == 'ci-suggest' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: ci-suggest
      context_json: '{"pr_number":"99999","branch_name":"feature/mock-test"}'
      mock_mode: true
    secrets: inherit

  # Test pr-review job
  pr-review:
    if: inputs.job == 'pr-review' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: pr-review
      context_json: '{"pr_number":"99999","branch_name":"test/mock/99999","issue_section":"Fixes #99998"}'
      mock_mode: true
    secrets: inherit

  # Test pr-response job
  pr-response:
    if: inputs.job == 'pr-response' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: pr-response
      context_json: '{"pr_number":"99999","branch_name":"test/mock/99999","review_state":"changes_requested","review_body":"Please fix the tests","review_id":"12345"}'
      mock_mode: true
    secrets: inherit

  # Test pr-human-response job
  pr-human-response:
    if: inputs.job == 'pr-human-response' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: pr-human-response
      context_json: '{"pr_number":"99999","branch_name":"test/mock/99999","reviewer_login":"test-reviewer","review_state":"changes_requested","review_body":"Human review feedback","review_id":"12346"}'
      mock_mode: true
    secrets: inherit

  # Test discussion-research job
  discussion-research:
    if: inputs.job == 'discussion-research' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: discussion-research
      context_json: '{"discussion_number":"99999","discussion_title":"Mock research topic","discussion_body":"Research question for testing"}'
      mock_mode: true
    secrets: inherit

  # Test discussion-respond job
  discussion-respond:
    if: inputs.job == 'discussion-respond' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: discussion-respond
      context_json: '{"discussion_number":"99999","comment_body":"Test comment","comment_author":"test-user"}'
      mock_mode: true
    secrets: inherit

  # Test discussion-summarize job
  discussion-summarize:
    if: inputs.job == 'discussion-summarize' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: discussion-summarize
      context_json: '{"discussion_number":"99999"}'
      mock_mode: true
    secrets: inherit

  # Test discussion-plan job
  discussion-plan:
    if: inputs.job == 'discussion-plan' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: discussion-plan
      context_json: '{"discussion_number":"99999"}'
      mock_mode: true
    secrets: inherit
