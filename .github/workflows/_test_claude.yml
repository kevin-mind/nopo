name: Test Claude Scenario

on:
  workflow_dispatch:
    inputs:
      scenario_name:
        description: 'Scenario directory name'
        required: true
        type: string
      mode:
        description: 'Test mode label (mock or real)'
        type: string
        default: mock
      mock_claude:
        description: 'Mock Claude outputs'
        type: boolean
        default: true

  workflow_call:
    inputs:
      scenario_name:
        description: 'Scenario directory name'
        required: true
        type: string
      mode:
        description: 'Test mode label (mock or real)'
        type: string
        default: mock
      mock_claude:
        description: 'Mock Claude outputs'
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  id-token: write

env:
  GH_TOKEN: ${{ secrets.NOPO_BOT_PAT || secrets.GITHUB_TOKEN }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/setup-nopo
      - run: nopo setup-github root

      - name: Install Claude Code
        if: inputs.mock_claude == false
        run: |
          set -e
          echo "Installing Claude Code..."
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          if [ -f "$HOME/.local/bin/claude" ]; then
            echo "âœ“ Claude Code installed at $HOME/.local/bin/claude"
            "$HOME/.local/bin/claude" --version || echo "Warning: Could not get version"
          else
            echo "::error::Claude Code installation failed"
            exit 1
          fi

      - name: Run test
        id: run
        continue-on-error: true
        uses: ./packages/statemachine/actions/sm-test-runner
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.mock_claude == false && secrets.CLAUDE_CODE_OAUTH_TOKEN || '' }}
          CLAUDE_CODE_PATH: ${{ inputs.mock_claude == false && '/home/runner/.local/bin/claude' || '' }}
        with:
          action: run-configurable
          scenario_name: ${{ inputs.scenario_name }}
          continue: true
          mock_claude: ${{ inputs.mock_claude }}
          mock_ci: true
          multi_issue: true
          github_token: ${{ secrets.NOPO_BOT_PAT }}
          reviewer_token: ${{ secrets.CLAUDE_REVIEWER_PAT }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}

      - name: Cleanup
        if: always() && steps.run.outputs.issue_number != ''
        uses: ./packages/statemachine/actions/sm-test-helper
        with:
          action: cleanup
          issue_number: ${{ steps.run.outputs.issue_number }}
          github_token: ${{ env.GH_TOKEN }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}
          cleanup_mode: close

      - name: Save result
        if: always()
        env:
          SCENARIO: ${{ inputs.scenario_name }}
          MODE: ${{ inputs.mode }}
          STATUS: ${{ steps.run.outputs.status || 'error' }}
          ISSUE_NUMBER: ${{ steps.run.outputs.issue_number || '' }}
          ERROR_MSG: ${{ steps.run.outputs.error || '' }}
          JOB_RESULT: ${{ job.status }}
        run: |
          mkdir -p results
          jq -n \
            --arg scenario "$SCENARIO" \
            --arg mode "$MODE" \
            --arg status "$STATUS" \
            --arg issue_number "$ISSUE_NUMBER" \
            --arg error "$ERROR_MSG" \
            --arg job_result "$JOB_RESULT" \
            '{scenario: $scenario, mode: $mode, status: $status, issue_number: $issue_number, error: $error, job_result: $job_result}' \
            > results/${{ inputs.scenario_name }}-${{ inputs.mode }}.json

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: result-${{ inputs.mode }}-${{ inputs.scenario_name }}
          path: results/
          retention-days: 1

      - name: Fail job if test failed
        if: always() && steps.run.outputs.status != 'completed'
        run: |
          echo "Test failed with status: ${{ steps.run.outputs.status }}"
          echo "Error: ${{ steps.run.outputs.error }}"
          exit 1
