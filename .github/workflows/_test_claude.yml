name: Test Claude Automation
run-name: "Test Claude - ${{ inputs.job || 'all' }}"
on:
  # Manual trigger for debugging
  workflow_dispatch:
    inputs:
      job:
        description: 'Job to test (all = run all tests)'
        required: true
        type: choice
        options:
          - all
          - unit-tests
          - issue-triage
          - issue-iterate
          - issue-iterate-complete
          - issue-iterate-ci-failure
          - issue-comment
          - pr-review
          - pr-response
          - pr-human-response
          - discussion-research
          - discussion-respond
          - discussion-summarize
          - discussion-plan

  # Called by CI workflow
  workflow_call:
    inputs:
      job:
        description: 'Job to test'
        required: true
        type: string
      mock_mode:
        description: 'Mock mode (always true in CI)'
        type: boolean
        default: true

# Note: These permissions are required by _claude.yml's declaration even though
# mock mode doesn't actually use write permissions
permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

# ============================================================================
# TEST JOBS
# ============================================================================
jobs:
  # ============================================================================
  # UNIT TESTS - Test TypeScript action logic directly
  # ============================================================================
  # Note: Event detection logic is tested via unit tests in index.test.ts
  # Workflow-level detection tests are not possible because @actions/github
  # reads GITHUB_EVENT_NAME at module import time (before env overrides)
  unit-tests:
    if: inputs.job == 'unit-tests' || inputs.job == 'all'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/setup-nopo
      - name: Run GitHub Actions tests
        run: nopo test actions root

  # ============================================================================
  # WORKFLOW LOGIC TESTS - Test _claude.yml jobs with mock context
  # Uses mock_mode=true so no real Claude calls or git operations happen
  # ============================================================================

  # Test issue-triage job
  issue-triage:
    if: inputs.job == 'issue-triage' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: issue-triage
      context_json: '{"issue_number":"99999","issue_title":"Mock test issue","issue_body":"Test body for triage"}'
      mock_mode: true
    secrets: inherit

  # Test issue-iterate job - first iteration (assigned trigger)
  issue-iterate:
    if: inputs.job == 'issue-iterate' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: issue-iterate
      context_json: '{"issue_number":"99999","issue_title":"Mock iterate test","issue_body":"## Todo\n- [ ] Test task","branch_name":"test/mock/99999","existing_branch":"false","trigger_type":"assigned"}'
      mock_mode: true
    secrets: inherit

  # Test issue-iterate with already complete state (should early exit)
  issue-iterate-complete:
    if: inputs.job == 'issue-iterate-complete' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: issue-iterate
      # Note: In mock mode, state isn't actually read from issue body
      # This tests that the job runs without errors with complete context
      context_json: '{"issue_number":"99999","issue_title":"Mock complete test","issue_body":"## Todo\n- [x] Completed task","branch_name":"test/mock/99999","existing_branch":"true","trigger_type":"edited"}'
      mock_mode: true
    secrets: inherit

  # Test issue-iterate with CI failure (edited trigger with failed CI state)
  issue-iterate-ci-failure:
    if: inputs.job == 'issue-iterate-ci-failure' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: issue-iterate
      context_json: '{"issue_number":"99999","issue_title":"Mock CI failure test","issue_body":"## Todo\n- [ ] Fix errors","branch_name":"test/mock/99999","existing_branch":"true","trigger_type":"edited"}'
      mock_mode: true
    secrets: inherit

  # Test issue-comment job
  issue-comment:
    if: inputs.job == 'issue-comment' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: issue-comment
      context_json: '{"issue_number":"99999","context_type":"issue","context_description":"Mock issue for comment test"}'
      mock_mode: true
    secrets: inherit

  # Test pr-review job
  pr-review:
    if: inputs.job == 'pr-review' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: pr-review
      context_json: '{"pr_number":"99999","branch_name":"test/mock/99999","issue_section":"Fixes #99998"}'
      mock_mode: true
    secrets: inherit

  # Test pr-response job
  pr-response:
    if: inputs.job == 'pr-response' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: pr-response
      context_json: '{"pr_number":"99999","branch_name":"test/mock/99999","review_state":"changes_requested","review_body":"Please fix the tests","review_id":"12345"}'
      mock_mode: true
    secrets: inherit

  # Test pr-human-response job
  pr-human-response:
    if: inputs.job == 'pr-human-response' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: pr-human-response
      context_json: '{"pr_number":"99999","branch_name":"test/mock/99999","reviewer_login":"test-reviewer","review_state":"changes_requested","review_body":"Human review feedback","review_id":"12346"}'
      mock_mode: true
    secrets: inherit

  # Test discussion-research job
  discussion-research:
    if: inputs.job == 'discussion-research' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: discussion-research
      context_json: '{"discussion_number":"99999","discussion_title":"Mock research topic","discussion_body":"Research question for testing"}'
      mock_mode: true
    secrets: inherit

  # Test discussion-respond job
  discussion-respond:
    if: inputs.job == 'discussion-respond' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: discussion-respond
      context_json: '{"discussion_number":"99999","comment_body":"Test comment","comment_author":"test-user"}'
      mock_mode: true
    secrets: inherit

  # Test discussion-summarize job
  discussion-summarize:
    if: inputs.job == 'discussion-summarize' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: discussion-summarize
      context_json: '{"discussion_number":"99999"}'
      mock_mode: true
    secrets: inherit

  # Test discussion-plan job
  discussion-plan:
    if: inputs.job == 'discussion-plan' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: discussion-plan
      context_json: '{"discussion_number":"99999"}'
      mock_mode: true
    secrets: inherit
