name: Test Claude Automation
run-name: "Test Claude - ${{ inputs.job || 'all' }}"
on:
  # Manual trigger for debugging
  workflow_dispatch:
    inputs:
      job:
        description: 'Job to test (all = run all tests)'
        required: true
        type: choice
        options:
          - all
          - unit-tests
          - detect-event
          - issue-triage
          - issue-iterate
          - issue-iterate-complete
          - issue-iterate-ci-failure
          - issue-comment
          - pr-review
          - pr-response
          - pr-human-response
          - discussion-research
          - discussion-respond
          - discussion-summarize
          - discussion-plan

  # Called by CI workflow
  workflow_call:
    inputs:
      job:
        description: 'Job to test'
        required: true
        type: string
      mock_mode:
        description: 'Mock mode (always true in CI)'
        type: boolean
        default: true

# Note: These permissions are required by _claude.yml's declaration even though
# mock mode doesn't actually use write permissions
permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

# ============================================================================
# TEST JOBS
# ============================================================================
jobs:
  # ============================================================================
  # UNIT TESTS - Test TypeScript action logic directly
  # ============================================================================
  unit-tests:
    if: inputs.job == 'unit-tests' || inputs.job == 'all'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/setup-nopo
      - name: Run GitHub Actions tests
        run: nopo test actions root

  # ============================================================================
  # DETECT EVENT - Test event detection with mock event data
  # ============================================================================
  detect-event:
    if: inputs.job == 'detect-event' || inputs.job == 'all'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node

      - name: Create mock issue events
        run: |
          mkdir -p /tmp/test-events

          # Issue opened event
          cat > /tmp/test-events/issue-opened.json << 'EOF'
          {
            "action": "opened",
            "issue": {
              "number": 99999,
              "title": "Mock test issue",
              "body": "This is a mock issue for testing",
              "labels": [],
              "assignees": [],
              "user": { "login": "test-user" }
            },
            "repository": {
              "owner": { "login": "${{ github.repository_owner }}" },
              "name": "${{ github.event.repository.name }}"
            }
          }
          EOF

          # Issue assigned event (to nopo-bot)
          cat > /tmp/test-events/issue-assigned.json << 'EOF'
          {
            "action": "assigned",
            "issue": {
              "number": 99999,
              "title": "Mock test issue",
              "body": "This is a mock issue for testing",
              "labels": [{"name": "triaged"}],
              "assignees": [{"login": "nopo-bot"}],
              "user": { "login": "test-user" }
            },
            "assignee": { "login": "nopo-bot" },
            "repository": {
              "owner": { "login": "${{ github.repository_owner }}" },
              "name": "${{ github.event.repository.name }}"
            }
          }
          EOF

          # Issue edited event (with nopo-bot assigned - triggers iteration)
          cat > /tmp/test-events/issue-edited-assigned.json << 'EOF'
          {
            "action": "edited",
            "issue": {
              "number": 99999,
              "title": "Mock test issue",
              "body": "This is a mock issue for testing - edited",
              "labels": [{"name": "triaged"}],
              "assignees": [{"login": "nopo-bot"}],
              "user": { "login": "test-user" }
            },
            "repository": {
              "owner": { "login": "${{ github.repository_owner }}" },
              "name": "${{ github.event.repository.name }}"
            }
          }
          EOF

          # Issue edited event (without nopo-bot - triggers triage)
          cat > /tmp/test-events/issue-edited-unassigned.json << 'EOF'
          {
            "action": "edited",
            "issue": {
              "number": 99999,
              "title": "Mock test issue",
              "body": "This is a mock issue for testing - edited",
              "labels": [],
              "assignees": [],
              "user": { "login": "test-user" }
            },
            "repository": {
              "owner": { "login": "${{ github.repository_owner }}" },
              "name": "${{ github.event.repository.name }}"
            }
          }
          EOF

      - name: Test issue-opened detection
        id: detect-issue-opened
        uses: ./.github/actions-ts/claude-detect-event
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_EVENT_NAME: issues
          GITHUB_EVENT_PATH: /tmp/test-events/issue-opened.json

      - name: Verify issue-opened detection
        run: |
          echo "Testing issue-opened event detection..."
          echo "Job: ${{ steps.detect-issue-opened.outputs.job }}"
          echo "Resource Type: ${{ steps.detect-issue-opened.outputs.resource_type }}"
          echo "Skip: ${{ steps.detect-issue-opened.outputs.skip }}"

          if [[ "${{ steps.detect-issue-opened.outputs.job }}" != "issue-triage" ]]; then
            echo "ERROR: Expected job=issue-triage for opened event"
            exit 1
          fi
          if [[ "${{ steps.detect-issue-opened.outputs.resource_type }}" != "issue" ]]; then
            echo "ERROR: Expected resource_type=issue"
            exit 1
          fi
          echo "✓ Issue-opened detection passed"

      - name: Test issue-assigned detection
        id: detect-issue-assigned
        uses: ./.github/actions-ts/claude-detect-event
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_EVENT_NAME: issues
          GITHUB_EVENT_PATH: /tmp/test-events/issue-assigned.json

      - name: Verify issue-assigned detection
        run: |
          echo "Testing issue-assigned event detection..."
          echo "Job: ${{ steps.detect-issue-assigned.outputs.job }}"
          echo "Skip: ${{ steps.detect-issue-assigned.outputs.skip }}"

          if [[ "${{ steps.detect-issue-assigned.outputs.job }}" != "issue-iterate" ]]; then
            echo "ERROR: Expected job=issue-iterate for assigned to nopo-bot"
            exit 1
          fi
          echo "✓ Issue-assigned detection passed"

      - name: Test issue-edited with nopo-bot detection
        id: detect-issue-edited-assigned
        uses: ./.github/actions-ts/claude-detect-event
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_EVENT_NAME: issues
          GITHUB_EVENT_PATH: /tmp/test-events/issue-edited-assigned.json

      - name: Verify issue-edited with nopo-bot detection
        run: |
          echo "Testing issue-edited (with nopo-bot) event detection..."
          echo "Job: ${{ steps.detect-issue-edited-assigned.outputs.job }}"
          echo "Skip: ${{ steps.detect-issue-edited-assigned.outputs.skip }}"

          if [[ "${{ steps.detect-issue-edited-assigned.outputs.job }}" != "issue-iterate" ]]; then
            echo "ERROR: Expected job=issue-iterate for edited with nopo-bot assigned"
            exit 1
          fi
          echo "✓ Issue-edited (with nopo-bot) detection passed"

      - name: Test issue-edited without assignment detection
        id: detect-issue-edited-unassigned
        uses: ./.github/actions-ts/claude-detect-event
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_EVENT_NAME: issues
          GITHUB_EVENT_PATH: /tmp/test-events/issue-edited-unassigned.json

      - name: Verify issue-edited without assignment detection
        run: |
          echo "Testing issue-edited (without nopo-bot) event detection..."
          echo "Job: ${{ steps.detect-issue-edited-unassigned.outputs.job }}"
          echo "Skip: ${{ steps.detect-issue-edited-unassigned.outputs.skip }}"

          if [[ "${{ steps.detect-issue-edited-unassigned.outputs.job }}" != "issue-triage" ]]; then
            echo "ERROR: Expected job=issue-triage for edited without nopo-bot assigned"
            exit 1
          fi
          echo "✓ Issue-edited (without nopo-bot) detection passed"

      - name: Summary
        run: |
          echo "All detect-event tests passed!"
          echo "- issue-opened → issue-triage ✓"
          echo "- issue-assigned (nopo-bot) → issue-iterate ✓"
          echo "- issue-edited (with nopo-bot) → issue-iterate ✓"
          echo "- issue-edited (without nopo-bot, no triaged) → issue-triage ✓"

  # ============================================================================
  # WORKFLOW LOGIC TESTS - Test _claude.yml jobs with mock context
  # Uses mock_mode=true so no real Claude calls or git operations happen
  # ============================================================================

  # Test issue-triage job
  issue-triage:
    if: inputs.job == 'issue-triage' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: issue-triage
      context_json: '{"issue_number":"99999","issue_title":"Mock test issue","issue_body":"Test body for triage"}'
      mock_mode: true
    secrets: inherit

  # Test issue-iterate job - first iteration (assigned trigger)
  issue-iterate:
    if: inputs.job == 'issue-iterate' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: issue-iterate
      context_json: '{"issue_number":"99999","issue_title":"Mock iterate test","issue_body":"## Todo\n- [ ] Test task","branch_name":"test/mock/99999","existing_branch":"false","trigger_type":"assigned"}'
      mock_mode: true
    secrets: inherit

  # Test issue-iterate with already complete state (should early exit)
  issue-iterate-complete:
    if: inputs.job == 'issue-iterate-complete' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: issue-iterate
      # Note: In mock mode, state isn't actually read from issue body
      # This tests that the job runs without errors with complete context
      context_json: '{"issue_number":"99999","issue_title":"Mock complete test","issue_body":"## Todo\n- [x] Completed task","branch_name":"test/mock/99999","existing_branch":"true","trigger_type":"edited"}'
      mock_mode: true
    secrets: inherit

  # Test issue-iterate with CI failure (edited trigger with failed CI state)
  issue-iterate-ci-failure:
    if: inputs.job == 'issue-iterate-ci-failure' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: issue-iterate
      context_json: '{"issue_number":"99999","issue_title":"Mock CI failure test","issue_body":"## Todo\n- [ ] Fix errors","branch_name":"test/mock/99999","existing_branch":"true","trigger_type":"edited"}'
      mock_mode: true
    secrets: inherit

  # Test issue-comment job
  issue-comment:
    if: inputs.job == 'issue-comment' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: issue-comment
      context_json: '{"issue_number":"99999","context_type":"issue","context_description":"Mock issue for comment test"}'
      mock_mode: true
    secrets: inherit

  # Test pr-review job
  pr-review:
    if: inputs.job == 'pr-review' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: pr-review
      context_json: '{"pr_number":"99999","branch_name":"test/mock/99999","issue_section":"Fixes #99998"}'
      mock_mode: true
    secrets: inherit

  # Test pr-response job
  pr-response:
    if: inputs.job == 'pr-response' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: pr-response
      context_json: '{"pr_number":"99999","branch_name":"test/mock/99999","review_state":"changes_requested","review_body":"Please fix the tests","review_id":"12345"}'
      mock_mode: true
    secrets: inherit

  # Test pr-human-response job
  pr-human-response:
    if: inputs.job == 'pr-human-response' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: pr-human-response
      context_json: '{"pr_number":"99999","branch_name":"test/mock/99999","reviewer_login":"test-reviewer","review_state":"changes_requested","review_body":"Human review feedback","review_id":"12346"}'
      mock_mode: true
    secrets: inherit

  # Test discussion-research job
  discussion-research:
    if: inputs.job == 'discussion-research' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: discussion-research
      context_json: '{"discussion_number":"99999","discussion_title":"Mock research topic","discussion_body":"Research question for testing"}'
      mock_mode: true
    secrets: inherit

  # Test discussion-respond job
  discussion-respond:
    if: inputs.job == 'discussion-respond' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: discussion-respond
      context_json: '{"discussion_number":"99999","comment_body":"Test comment","comment_author":"test-user"}'
      mock_mode: true
    secrets: inherit

  # Test discussion-summarize job
  discussion-summarize:
    if: inputs.job == 'discussion-summarize' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: discussion-summarize
      context_json: '{"discussion_number":"99999"}'
      mock_mode: true
    secrets: inherit

  # Test discussion-plan job
  discussion-plan:
    if: inputs.job == 'discussion-plan' || inputs.job == 'all'
    uses: ./.github/workflows/_claude.yml
    with:
      job: discussion-plan
      context_json: '{"discussion_number":"99999"}'
      mock_mode: true
    secrets: inherit
