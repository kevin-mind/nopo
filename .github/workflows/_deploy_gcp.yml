name: Deploy to GCP

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'The version to deploy'
        required: true
        type: string
      digest:
        description: 'The digest to deploy'
        required: false
        type: string
      environment:
        description: 'The environment to deploy to'
        required: true
        type: choice
        options:
          - stage
          - prod

  workflow_call:
    inputs:
      version:
        description: 'The version to deploy'
        required: true
        type: string
      digest:
        description: 'The digest to deploy'
        required: false
        type: string
      environment:
        description: 'The environment to deploy to'
        required: true
        type: string

permissions: {}

defaults:
  run:
    shell: bash

concurrency:
  group: deploy-${{ inputs.environment }}
  cancel-in-progress: false

env:
  GCP_REGION: europe-west1
  TERRAFORM_VERSION: "1.7.0"

jobs:
  context:
    runs-on: ubuntu-latest
    outputs:
      backend_image: ${{ steps.images.outputs.backend }}
      web_image: ${{ steps.images.outputs.web }}
      subdomain_prefix: ${{ steps.env_config.outputs.subdomain_prefix }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine image tags
        id: images
        env:
          REGISTRY: ${{ vars.GCP_ARTIFACT_REGISTRY }}
          VERSION: ${{ inputs.version }}
        run: |
          echo "backend=${REGISTRY}/backend:${VERSION}" >> "$GITHUB_OUTPUT"
          echo "web=${REGISTRY}/web:${VERSION}" >> "$GITHUB_OUTPUT"
          cat "$GITHUB_OUTPUT"

      - name: Environment config
        id: env_config
        env:
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          if [[ "$ENVIRONMENT" == "stage" ]]; then
            echo "subdomain_prefix=stage" >> "$GITHUB_OUTPUT"
          else
            echo "subdomain_prefix=" >> "$GITHUB_OUTPUT"
          fi
          cat "$GITHUB_OUTPUT"

  push_images:
    name: Push images to Artifact Registry
    needs: [context]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    strategy:
      matrix:
        service: [backend, web]
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-docker
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker "${{ env.GCP_REGION }}-docker.pkg.dev" --quiet

      - name: Pull and push image
        env:
          GHCR_IMAGE: ghcr.io/${{ github.repository }}-${{ matrix.service }}:${{ inputs.version }}
          GCP_IMAGE: ${{ vars.GCP_ARTIFACT_REGISTRY }}/${{ matrix.service }}:${{ inputs.version }}
        run: |
          docker pull "${GHCR_IMAGE}"
          docker tag "${GHCR_IMAGE}" "${GCP_IMAGE}"
          docker push "${GCP_IMAGE}"

  deploy:
    name: Deploy to ${{ inputs.environment }}
    needs: [context, push_images]
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: https://${{ needs.context.outputs.subdomain_prefix && format('{0}.', needs.context.outputs.subdomain_prefix) || '' }}${{ vars.DOMAIN }}
    permissions:
      contents: read
      id-token: write
    outputs:
      load_balancer_ip: ${{ steps.deploy.outputs.load_balancer_ip }}
      public_url: ${{ steps.deploy.outputs.public_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy with Terraform
        id: deploy
        uses: ./.github/actions/deploy-gcp
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          region: ${{ env.GCP_REGION }}
          environment: ${{ inputs.environment }}
          domain: ${{ vars.DOMAIN }}
          subdomain_prefix: ${{ needs.context.outputs.subdomain_prefix }}
          backend_image: ${{ needs.context.outputs.backend_image }}
          web_image: ${{ needs.context.outputs.web_image }}
          terraform_state_bucket: ${{ vars.TERRAFORM_STATE_BUCKET }}

  run_migrations:
    name: Run database migrations
    needs: [deploy]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Run migrations
        env:
          PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
          REGION: ${{ env.GCP_REGION }}
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          SERVICE_NAME="nopo-${ENVIRONMENT}-backend"

          # Execute migration command in Cloud Run job
          gcloud run jobs execute "${SERVICE_NAME}-migrate" \
            --project="${PROJECT_ID}" \
            --region="${REGION}" \
            --wait \
            || echo "Migration job may not exist yet, skipping..."

  smoketest:
    name: Smoke test
    needs: [context, deploy, run_migrations]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-node

      - name: Run smoketest
        uses: ./.github/actions/smoketest
        with:
          public_url: ${{ needs.deploy.outputs.public_url }}

  tag_environment:
    name: Tag environment images
    needs: [context, smoketest]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
    strategy:
      matrix:
        service: [backend, web]
    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-docker
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag environment image on GHCR
        env:
          GHCR_VERSION_IMAGE: ghcr.io/${{ github.repository }}-${{ matrix.service }}:${{ inputs.version }}
          GHCR_ENV_IMAGE: ghcr.io/${{ github.repository }}-${{ matrix.service }}:${{ inputs.environment }}
        run: |
          docker pull "${GHCR_VERSION_IMAGE}"
          docker tag "${GHCR_VERSION_IMAGE}" "${GHCR_ENV_IMAGE}"
          docker push "${GHCR_ENV_IMAGE}"
