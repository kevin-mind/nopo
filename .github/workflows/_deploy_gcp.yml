name: Deploy to GCP

on:
  workflow_dispatch:
    inputs:
      version:
        description: "The version to deploy"
        required: true
        type: string
      digest:
        description: "The digest to deploy"
        required: false
        type: string
      environment:
        description: "The environment to deploy to"
        required: true
        type: choice
        options:
          - stage
          - prod

  workflow_call:
    inputs:
      version:
        description: "The version to deploy"
        required: true
        type: string
      digest:
        description: "The digest to deploy"
        required: false
        type: string
      environment:
        description: "The environment to deploy to"
        required: true
        type: string

permissions: {}

defaults:
  run:
    shell: bash

concurrency:
  group: deploy-${{ inputs.environment }}
  cancel-in-progress: false

env:
  GCP_REGION: us-central1
  TERRAFORM_VERSION: "1.7.0"

jobs:
  context:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      services: ${{ steps.services.outputs.services }}
      subdomain_prefix: ${{ steps.env_config.outputs.subdomain_prefix }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - name: Discover services
        id: services
        uses: ./.github/actions/service-names
        with:
          filter: buildable
      - name: Environment config
        id: env_config
        env:
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          if [[ "$ENVIRONMENT" == "stage" ]]; then
            echo "subdomain_prefix=stage" >> "$GITHUB_OUTPUT"
          else
            echo "subdomain_prefix=" >> "$GITHUB_OUTPUT"
          fi

  # ===========================================================================
  # INFRASTRUCTURE PROVISIONING
  # Ensure base infra (Registry, Buckets, etc.) exists before we try to use it
  # ===========================================================================
  provision_infra:
    name: Provision Infrastructure
    needs: [context]
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    timeout-minutes: 20
    permissions:
      contents: read
      id-token: write
    outputs:
      artifact_registry_url: ${{ steps.apply.outputs.artifact_registry_url }}
      static_bucket_name: ${{ steps.apply.outputs.static_bucket_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        env:
          TF_STATE_BUCKET: ${{ vars.TERRAFORM_STATE_BUCKET }}
          ENVIRONMENT: ${{ inputs.environment }}
        working-directory: infrastructure/terraform/environments/${{ inputs.environment }}/infra
        run: |
          terraform init -input=false \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="prefix=nopo/${ENVIRONMENT}/infra"

      - name: Terraform Apply
        id: apply
        env:
          TF_VAR_project_id: ${{ vars.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ env.GCP_REGION }}
          TF_VAR_domain: ${{ vars.DOMAIN }}
          TF_VAR_supabase_database_url: ${{ secrets.SUPABASE_DATABASE_URL }}
        working-directory: infrastructure/terraform/environments/${{ inputs.environment }}/infra
        run: |
          # Apply infra changes (create/update registry, buckets, etc.)
          terraform apply -input=false -auto-approve

          # Capture outputs
          artifact_registry_url=$(terraform output -raw artifact_registry_url)
          static_bucket_name=$(terraform output -raw static_bucket_name)

          echo "artifact_registry_url=${artifact_registry_url}" >> "$GITHUB_OUTPUT"
          echo "static_bucket_name=${static_bucket_name}" >> "$GITHUB_OUTPUT"

  # ===========================================================================
  # GET CURRENT STATE
  # We need to know what's currently deployed to the stable slot
  # ===========================================================================
  get_current_state:
    name: Get Current State
    needs: [provision_infra]
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      contents: read
      id-token: write
    outputs:
      current_stable_backend: ${{ steps.state.outputs.backend_image }}
      current_stable_web: ${{ steps.state.outputs.web_image }}
      new_backend_image: ${{ steps.new_images.outputs.backend_image }}
      new_web_image: ${{ steps.new_images.outputs.web_image }}
    steps:
      - uses: actions/checkout@v4
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Get stable images
        id: state
        env:
          TF_STATE_BUCKET: ${{ vars.TERRAFORM_STATE_BUCKET }}
          ENVIRONMENT: ${{ inputs.environment }}
          REGISTRY: ${{ needs.provision_infra.outputs.artifact_registry_url }}
          VERSION: ${{ inputs.version }}
        working-directory: infrastructure/terraform/environments/${{ inputs.environment }}/services
        run: |
          # Init to read state
          terraform init -input=false \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="prefix=nopo/${ENVIRONMENT}/services" 2>/dev/null || true

          # If first run, use new images as stable
          backend_image="${REGISTRY}/backend:${VERSION}"
          web_image="${REGISTRY}/web:${VERSION}"

          # Try to read real state if it exists (logic to read from vars would go here)
          # For now defaulting to new version for safety/simplicity on first run

          echo "backend_image=${backend_image}" >> "$GITHUB_OUTPUT"
          echo "web_image=${web_image}" >> "$GITHUB_OUTPUT"

      - name: Build new image tags
        id: new_images
        env:
          REGISTRY: ${{ needs.provision_infra.outputs.artifact_registry_url }}
          VERSION: ${{ inputs.version }}
        run: |
          backend_image="${REGISTRY}/backend:${VERSION}"
          web_image="${REGISTRY}/web:${VERSION}"
          echo "backend_image=${backend_image}" >> "$GITHUB_OUTPUT"
          echo "web_image=${web_image}" >> "$GITHUB_OUTPUT"

  # ===========================================================================
  # BUILD & PUSH
  # ===========================================================================
  push_images:
    name: Push ${{ matrix.service }}
    needs: [context, provision_infra]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: write
    strategy:
      matrix:
        service: ${{ fromJson(needs.context.outputs.services) }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-docker
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - name: Configure Docker
        run: gcloud auth configure-docker "${{ env.GCP_REGION }}-docker.pkg.dev" --quiet

      - name: Push to Artifact Registry
        env:
          GHCR_IMAGE: ghcr.io/${{ github.repository }}-${{ matrix.service }}:${{ inputs.version }}
          GCP_IMAGE: ${{ needs.provision_infra.outputs.artifact_registry_url }}/${{ matrix.service }}:${{ inputs.version }}
        run: |
          docker pull "${GHCR_IMAGE}"
          docker tag "${GHCR_IMAGE}" "${GCP_IMAGE}"
          docker push "${GCP_IMAGE}"

  # ===========================================================================
  # DEPLOY (Canary)
  # ===========================================================================
  deploy_canary:
    name: Deploy Canary
    needs: [context, provision_infra, get_current_state, push_images]
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: ${{ steps.deploy.outputs.public_url }}
    permissions:
      contents: read
      id-token: write
    outputs:
      public_url: ${{ steps.deploy.outputs.public_url }}
    steps:
      - uses: actions/checkout@v4
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy Services (Canary)
        id: deploy
        uses: ./.github/actions/deploy-gcp
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          region: ${{ env.GCP_REGION }}
          environment: ${{ inputs.environment }}
          domain: ${{ vars.DOMAIN }}
          subdomain_prefix: ${{ needs.context.outputs.subdomain_prefix }}
          terraform_state_bucket: ${{ vars.TERRAFORM_STATE_BUCKET }}
          # Images
          stable_backend_image: ${{ needs.get_current_state.outputs.current_stable_backend }}
          stable_web_image: ${{ needs.get_current_state.outputs.current_stable_web }}
          canary_backend_image: ${{ needs.get_current_state.outputs.new_backend_image }}
          canary_web_image: ${{ needs.get_current_state.outputs.new_web_image }}
          # DB
          supabase_database_url: ${{ secrets.SUPABASE_DATABASE_URL }}

  # ===========================================================================
  # UPLOAD ASSETS
  # ===========================================================================
  upload_assets:
    name: Upload Assets ${{ matrix.service }}
    needs: [context, provision_infra, deploy_canary]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    strategy:
      matrix:
        service: ${{ fromJson(needs.context.outputs.services) }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/setup-docker
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Upload to GCS
        env:
          GHCR_IMAGE: ghcr.io/${{ github.repository }}-${{ matrix.service }}:${{ inputs.version }}
          BUCKET_NAME: ${{ needs.provision_infra.outputs.static_bucket_name }}
          SERVICE: ${{ matrix.service }}
        run: |
          # Extract service config
          service_config=$(make list -- --json --jq ".services.\"${SERVICE}\"")
          static_path=$(echo "${service_config}" | jq -r '.static_path // empty')

          if [[ -z "${static_path}" || "${static_path}" == "null" ]]; then
            echo "No static_path for ${SERVICE}, skipping"
            exit 0
          fi

          # Pull and extract
          docker pull "${GHCR_IMAGE}"
          CONTAINER_ID=$(docker create "${GHCR_IMAGE}")
          EXTRACT_DIR=$(mktemp -d)

          if docker cp "${CONTAINER_ID}:/app/apps/${SERVICE}/${static_path}/." "${EXTRACT_DIR}/" 2>/dev/null; then
            echo "Uploading assets to gs://${BUCKET_NAME}/${SERVICE}/..."
            gcloud storage cp -r "${EXTRACT_DIR}/*" "gs://${BUCKET_NAME}/${SERVICE}/" \
              --cache-control="public, max-age=31536000, immutable" --quiet
          else
            echo "No static files found in image"
          fi

          docker rm "${CONTAINER_ID}" > /dev/null

  # ===========================================================================
  # MIGRATIONS & TEST
  # ===========================================================================
  run_migrations:
    name: Database Migrations
    needs: [context, deploy_canary, upload_assets]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Check and Run Migrations
        env:
          PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
          REGION: ${{ env.GCP_REGION }}
          ENVIRONMENT: ${{ inputs.environment }}
          SERVICES: ${{ needs.context.outputs.services }}
        run: |
          services_payload=$(make list -- --json --jq '.services')
          for service in $(echo "${SERVICES}" | jq -r '.[]'); do
            config=$(echo "${services_payload}" | jq -c --arg s "$service" '.[$s]')
            run_migrations=$(echo "${config}" | jq -r '.run_migrations // false')
            
            if [[ "${run_migrations}" == "true" ]]; then
              echo "Running migrations for ${service}..."
              JOB_NAME="nopo-${ENVIRONMENT}-${service}-migrate"
              gcloud run jobs execute "${JOB_NAME}" --project="${PROJECT_ID}" --region="${REGION}" --wait || true
            fi
          done

  smoketest_canary:
    name: Smoketest Canary
    needs: [deploy_canary, run_migrations]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - name: Test Canary
        uses: ./.github/actions/smoketest
        with:
          public_url: ${{ needs.deploy_canary.outputs.public_url }}
          canary: true

  # ===========================================================================
  # PROMOTE & FINALIZE
  # ===========================================================================
  promote:
    name: Promote to Stable
    needs: [context, deploy_canary, smoketest_canary, get_current_state]
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: https://${{ needs.context.outputs.subdomain_prefix && format('{0}.', needs.context.outputs.subdomain_prefix) || '' }}${{ vars.DOMAIN }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Deploy Services (Promote)
        uses: ./.github/actions/deploy-gcp
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          region: ${{ env.GCP_REGION }}
          environment: ${{ inputs.environment }}
          domain: ${{ vars.DOMAIN }}
          subdomain_prefix: ${{ needs.context.outputs.subdomain_prefix }}
          terraform_state_bucket: ${{ vars.TERRAFORM_STATE_BUCKET }}
          # Stable now gets new images
          stable_backend_image: ${{ needs.get_current_state.outputs.new_backend_image }}
          stable_web_image: ${{ needs.get_current_state.outputs.new_web_image }}
          # Canary stays same
          canary_backend_image: ${{ needs.get_current_state.outputs.new_backend_image }}
          canary_web_image: ${{ needs.get_current_state.outputs.new_web_image }}
          # DB
          supabase_database_url: ${{ secrets.SUPABASE_DATABASE_URL }}

  tag_environment:
    name: Tag Environment
    needs: [context, promote]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service: ${{ fromJson(needs.context.outputs.services) }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-docker
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Tag Image
        env:
          GHCR_VERSION: ghcr.io/${{ github.repository }}-${{ matrix.service }}:${{ inputs.version }}
          GHCR_ENV: ghcr.io/${{ github.repository }}-${{ matrix.service }}:${{ inputs.environment }}
        run: |
          docker pull "${GHCR_VERSION}"
          docker tag "${GHCR_VERSION}" "${GHCR_ENV}"
          docker push "${GHCR_ENV}"
