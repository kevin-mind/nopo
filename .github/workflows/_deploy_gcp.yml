name: Deploy to GCP
'on':
  workflow_dispatch:
    inputs:
      version:
        description: The version to deploy
        required: true
        type: string
      digest:
        description: The digest to deploy
        required: false
        type: string
      environment:
        description: The environment to deploy to
        required: true
        type: choice
        options:
          - stage
          - prod
      services:
        description: JSON array of services to deploy
        required: true
        type: string
  workflow_call:
    inputs:
      version:
        description: The version to deploy
        required: true
        type: string
      digest:
        description: The digest to deploy
        required: false
        type: string
      environment:
        description: The environment to deploy to
        required: true
        type: string
      services:
        description: JSON array of services to deploy
        required: true
        type: string
concurrency:
  group: deploy-${{ inputs.environment }}
  cancel-in-progress: false
permissions: {}
defaults:
  run:
    shell: bash
env:
  GCP_REGION: us-central1
  TERRAFORM_VERSION: 1.7.0
jobs:
  context:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      services: ${{ steps.services.outputs.services }}
      subdomain_prefix: ${{ steps.env_config.outputs.subdomain_prefix }}
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: setup_node
        uses: ./.github/actions/setup-node
      - id: services
        name: Validate services
        uses: ./.github/actions/validate-services
        with:
          services: ${{ inputs.services }}
      - id: env_config
        name: Environment config
        env:
          ENVIRONMENT: ${{ inputs.environment }}
        run: |-
          if [[ "$ENVIRONMENT" == "stage" ]]; then
            echo "subdomain_prefix=stage" >> $GITHUB_OUTPUT
          else
            echo "subdomain_prefix=" >> $GITHUB_OUTPUT
          fi
  provision_infra:
    name: Provision Infrastructure
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    timeout-minutes: 20
    permissions:
      contents: read
      id-token: write
    outputs:
      artifact_registry_url: ${{ steps.apply.outputs.artifact_registry_url }}
      static_bucket_name: ${{ steps.apply.outputs.static_bucket_name }}
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: auth
        name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - id: setup_terraform
        name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0
          terraform_wrapper: false
      - id: init
        name: Terraform Init
        env:
          TF_STATE_BUCKET: ${{ vars.TERRAFORM_STATE_BUCKET }}
          ENVIRONMENT: ${{ inputs.environment }}
        working-directory: infrastructure/terraform/environments/${{ inputs.environment }}/infra
        run: |
          terraform init -input=false \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="prefix=nopo/${ENVIRONMENT}/infra"
      - id: apply
        name: Terraform Apply
        env:
          TF_VAR_project_id: ${{ vars.GCP_PROJECT_ID }}
          TF_VAR_region: us-central1
          TF_VAR_domain: ${{ vars.DOMAIN }}
          TF_VAR_supabase_database_url: ${{ secrets.SUPABASE_DATABASE_URL }}
        working-directory: infrastructure/terraform/environments/${{ inputs.environment }}/infra
        run: |-
          # Apply infra changes (create/update registry, buckets, etc.)
          terraform apply -input=false -auto-approve

          # Capture outputs
          artifact_registry_url=$(terraform output -raw artifact_registry_url)
          static_bucket_name=$(terraform output -raw static_bucket_name)

          echo "artifact_registry_url=$artifact_registry_url" >> $GITHUB_OUTPUT
          echo "static_bucket_name=$static_bucket_name" >> $GITHUB_OUTPUT
    needs:
      - context
  get_current_state:
    name: Get Current State
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      contents: read
      id-token: write
    outputs:
      stable_backend_image: ${{ steps.images.outputs.stable_backend_image }}
      stable_web_image: ${{ steps.images.outputs.stable_web_image }}
      canary_backend_image: ${{ steps.images.outputs.canary_backend_image }}
      canary_web_image: ${{ steps.images.outputs.canary_web_image }}
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: auth
        name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - id: setup_terraform
        name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0
          terraform_wrapper: false
      - id: images
        name: Build image variables
        env:
          REGISTRY: ${{ needs.provision_infra.outputs.artifact_registry_url }}
          VERSION: ${{ inputs.version }}
          SERVICES: ${{ needs.context.outputs.services }}
        run: |-
          services_array=$(echo "${SERVICES}" | jq -c '.')

          # Only set images for services we're actually deploying
          # For services not in the list, output empty string (Terraform will treat as null)
          if echo "${services_array}" | jq -e '.[] | select(. == "backend")' > /dev/null 2>&1; then
            stable_backend_image="${REGISTRY}/backend:${VERSION}"
            canary_backend_image="${REGISTRY}/backend:${VERSION}"
          else
            stable_backend_image=""
            canary_backend_image=""
          fi

          if echo "${services_array}" | jq -e '.[] | select(. == "web")' > /dev/null 2>&1; then
            stable_web_image="${REGISTRY}/web:${VERSION}"
            canary_web_image="${REGISTRY}/web:${VERSION}"
          else
            stable_web_image=""
            canary_web_image=""
          fi

          echo "stable_backend_image=$stable_backend_image" >> $GITHUB_OUTPUT
          echo "stable_web_image=$stable_web_image" >> $GITHUB_OUTPUT
          echo "canary_backend_image=$canary_backend_image" >> $GITHUB_OUTPUT
          echo "canary_web_image=$canary_web_image" >> $GITHUB_OUTPUT

          echo "Images for deployment:"
          echo "  Stable backend: ${stable_backend_image:-<not deploying>}"
          echo "  Stable web: ${stable_web_image:-<not deploying>}"
          echo "  Canary backend: ${canary_backend_image:-<not deploying>}"
          echo "  Canary web: ${canary_web_image:-<not deploying>}"
    needs:
      - context
      - provision_infra
  push_images:
    name: Push ${{ matrix.service }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      id-token: write
    strategy:
      matrix:
        service: ${{ fromJson(needs.context.outputs.services) }}
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: setup_docker
        uses: ./.github/actions/setup-docker
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - id: auth
        name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - id: configure_docker
        name: Configure Docker
        run: gcloud auth configure-docker "us-central1-docker.pkg.dev" --quiet
      - id: push
        name: Push to Artifact Registry
        env:
          SOURCE_IMAGE: ghcr.io/${{ github.repository }}-${{ matrix.service }}:${{ inputs.version }}
          TARGET_IMAGE: ${{ needs.provision_infra.outputs.artifact_registry_url }}/${{ matrix.service }}:${{ inputs.version }}
        run: |-
          docker pull "$SOURCE_IMAGE"
          docker tag "$SOURCE_IMAGE" "$TARGET_IMAGE"
          docker push "$TARGET_IMAGE"
    needs:
      - context
      - provision_infra
  deploy_canary:
    name: Deploy Canary
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: ${{ steps.deploy.outputs.public_url }}
    permissions:
      contents: read
      id-token: write
    outputs:
      public_url: ${{ steps.deploy.outputs.public_url }}
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: auth
        name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - id: deploy
        name: Deploy Services (Canary)
        uses: ./.github/actions/deploy-gcp
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          region: us-central1
          environment: ${{ inputs.environment }}
          domain: ${{ vars.DOMAIN }}
          subdomain_prefix: ${{ needs.context.outputs.subdomain_prefix }}
          terraform_state_bucket: ${{ vars.TERRAFORM_STATE_BUCKET }}
          stable_backend_image: ${{ needs.get_current_state.outputs.stable_backend_image }}
          stable_web_image: ${{ needs.get_current_state.outputs.stable_web_image }}
          canary_backend_image: ${{ needs.get_current_state.outputs.canary_backend_image }}
          canary_web_image: ${{ needs.get_current_state.outputs.canary_web_image }}
    needs:
      - context
      - provision_infra
      - get_current_state
      - push_images
  upload_assets:
    name: Upload Assets ${{ matrix.service }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    strategy:
      matrix:
        service: ${{ fromJson(needs.context.outputs.services) }}
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: setup_node
        uses: ./.github/actions/setup-node
      - id: setup_docker
        uses: ./.github/actions/setup-docker
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - id: auth
        name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - id: upload
        name: Upload to GCS
        env:
          GHCR_IMAGE: ghcr.io/${{ github.repository }}-${{ matrix.service }}:${{ inputs.version }}
          BUCKET_NAME: ${{ needs.provision_infra.outputs.static_bucket_name }}
          SERVICE: ${{ matrix.service }}
        run: |-
          # Extract service config
          service_config=$(make list -- --json --jq ".services.\"${SERVICE}\"")
          static_path=$(echo "${service_config}" | jq -r '.static_path // empty')

          if [[ -z "${static_path}" || "${static_path}" == "null" ]]; then
            echo "No static_path for ${SERVICE}, skipping"
            exit 0
          fi

          # Pull and extract
          docker pull "${GHCR_IMAGE}"
          CONTAINER_ID=$(docker create "${GHCR_IMAGE}")
          EXTRACT_DIR=$(mktemp -d)

          if docker cp "${CONTAINER_ID}:/app/apps/${SERVICE}/${static_path}/." "${EXTRACT_DIR}/" 2>/dev/null; then
            echo "Uploading assets to gs://${BUCKET_NAME}/${SERVICE}/..."
            gcloud storage cp -r "${EXTRACT_DIR}/*" "gs://${BUCKET_NAME}/${SERVICE}/" \
              --cache-control="public, max-age=31536000, immutable" --quiet
          else
            echo "No static files found in image"
          fi

          docker rm "${CONTAINER_ID}" > /dev/null
    needs:
      - context
      - provision_infra
  run_migrations:
    name: Database Migrations
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: setup_node
        uses: ./.github/actions/setup-node
      - id: auth
        name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - id: setup_gcloud
        name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      - id: run_migrations
        name: Check and Run Migrations
        env:
          PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
          REGION: us-central1
          ENVIRONMENT: ${{ inputs.environment }}
          SERVICES: ${{ needs.context.outputs.services }}
        run: |-
          services_payload=$(make list -- --json --jq '.services')
          for service in $(echo "${SERVICES}" | jq -r '.[]'); do
            config=$(echo "${services_payload}" | jq -c --arg s "$service" '.[$s]')
            run_migrations=$(echo "${config}" | jq -r '.run_migrations // false')

            if [[ "${run_migrations}" == "true" ]]; then
              echo "Running migrations for ${service}..."
              JOB_NAME="nopo-${ENVIRONMENT}-${service}-migrate"
              gcloud run jobs execute "${JOB_NAME}" --project="${PROJECT_ID}" --region="${REGION}" --wait || true
            fi
          done
    needs:
      - context
      - deploy_canary
  smoketest_canary:
    name: Smoketest Canary
    runs-on: ubuntu-latest
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: setup_node
        uses: ./.github/actions/setup-node
      - id: smoketest
        name: Test Canary
        uses: ./.github/actions/smoketest
        with:
          public_url: ${{ needs.deploy_canary.outputs.public_url }}
          canary: true
    needs:
      - deploy_canary
      - run_migrations
      - upload_assets
  promote:
    name: Promote to Stable
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: https://${{ needs.context.outputs.subdomain_prefix && format('{0}.', needs.context.outputs.subdomain_prefix) || '' }}${{ vars.DOMAIN }}
    permissions:
      contents: read
      id-token: write
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: auth
        name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - id: deploy
        name: Deploy Services (Promote)
        uses: ./.github/actions/deploy-gcp
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          region: us-central1
          environment: ${{ inputs.environment }}
          domain: ${{ vars.DOMAIN }}
          subdomain_prefix: ${{ needs.context.outputs.subdomain_prefix }}
          terraform_state_bucket: ${{ vars.TERRAFORM_STATE_BUCKET }}
          stable_backend_image: ${{ needs.get_current_state.outputs.canary_backend_image }}
          stable_web_image: ${{ needs.get_current_state.outputs.canary_web_image }}
          canary_backend_image: ${{ needs.get_current_state.outputs.canary_backend_image }}
          canary_web_image: ${{ needs.get_current_state.outputs.canary_web_image }}
    needs:
      - context
      - deploy_canary
      - smoketest_canary
      - get_current_state
  tag_environment:
    name: Tag Environment
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service: ${{ fromJson(needs.context.outputs.services) }}
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: setup_docker
        uses: ./.github/actions/setup-docker
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - id: tag
        name: Tag Image
        env:
          SOURCE_IMAGE: ghcr.io/${{ github.repository }}-${{ matrix.service }}:${{ inputs.version }}
          TARGET_IMAGE: ghcr.io/${{ github.repository }}-${{ matrix.service }}:${{ inputs.environment }}
        run: |-
          docker pull "$SOURCE_IMAGE"
          docker tag "$SOURCE_IMAGE" "$TARGET_IMAGE"
          docker push "$TARGET_IMAGE"
    needs:
      - context
      - promote
