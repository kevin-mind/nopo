name: Convert PR to Draft on Push

on:
  push:
    branches-ignore:
      - main

permissions:
  pull-requests: write

jobs:
  convert-to-draft:
    runs-on: ubuntu-latest
    steps:
      - name: Find and convert PR to draft
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_BRANCH: ${{ github.ref_name }}
        run: |
          # Find PR for this branch
          pr=$(gh pr list --repo "$GITHUB_REPOSITORY" --head "$HEAD_BRANCH" --json number,isDraft --jq '.[0]')

          if [[ -z "$pr" || "$pr" == "null" ]]; then
            echo "No PR found for branch $HEAD_BRANCH"
            exit 0
          fi

          pr_number=$(echo "$pr" | jq -r '.number')
          is_draft=$(echo "$pr" | jq -r '.isDraft')

          if [[ "$is_draft" == "true" ]]; then
            echo "PR #$pr_number is already a draft"
            exit 0
          fi

          # Convert to draft
          gh pr ready "$pr_number" --undo --repo "$GITHUB_REPOSITORY"
          echo "Converted PR #$pr_number to draft (push detected, CI will mark ready when green)"
