# This file was auto-generated by github-actions-workflow-ts.
# Do not edit directly. Instead, edit the corresponding .wac.ts file in .github/workflows-ts/
# and run `pnpm run gwf:build` to regenerate this file.
name: Discussion Event Dispatcher
'on':
  discussion:
    types:
      - created
      - edited
  discussion_comment:
    types:
      - created
permissions:
  contents: write
  discussions: write
defaults:
  run:
    shell: bash
jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch to handler
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |-
            const eventName = context.eventName;
            const payload = context.payload;

            // Determine action type
            let actionType = 'unknown';
            let discussionNumber, discussionTitle, discussionBody, commentId, commentBody, commentAuthor;

            if (eventName === 'discussion') {
              discussionNumber = payload.discussion.number;
              discussionTitle = payload.discussion.title;
              discussionBody = payload.discussion.body;

              if (payload.action === 'created') {
                actionType = 'research';
              }
            } else if (eventName === 'discussion_comment') {
              discussionNumber = payload.discussion.number;
              discussionTitle = payload.discussion.title;
              discussionBody = payload.discussion.body;
              commentId = payload.comment.node_id;
              commentBody = payload.comment.body;
              commentAuthor = payload.comment.user.login;

              // Check if this is a top-level comment (no parent)
              // GitHub's discussion_comment webhook doesn't include reply info directly,
              // so we check the comment's parent_id field (null = top-level)
              const isTopLevel = !payload.comment.parent_id;

              // Check for commands first (works for any author)
              const body = commentBody.trim();
              if (body === '/summarize') {
                actionType = 'summarize';
              } else if (body === '/plan') {
                actionType = 'plan';
              } else if (body === '/complete') {
                actionType = 'complete';
              } else if (commentAuthor !== 'claude[bot]' && commentAuthor !== 'nopo-bot') {
                // Human comment - always respond
                actionType = 'respond';
              } else if (isTopLevel && commentBody.includes('## üîç Research:')) {
                // Bot's top-level research thread - trigger investigation
                actionType = 'respond';
                console.log('Triggering response for bot research thread');
              } else {
                // Skip bot's reply comments (prevent infinite loop)
                console.log('Skipping bot reply comment to prevent infinite loop');
                return;
              }
            }

            // Dispatch to handler workflow
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'discussion_event',
              client_payload: {
                action_type: actionType,
                discussion_number: discussionNumber,
                discussion_title: discussionTitle,
                discussion_body: discussionBody,
                comment_id: commentId,
                comment_body: commentBody,
                comment_author: commentAuthor
              }
            });

            console.log(`Dispatched ${actionType} event for discussion #${discussionNumber}`);
