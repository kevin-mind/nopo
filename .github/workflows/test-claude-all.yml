name: Test All Scenarios with Claude Analysis

run-name: "All Scenarios | ${{ inputs.include_real_claude && 'Mock + Real Claude' || 'Mock Only' }}"

on:
  workflow_dispatch:
    inputs:
      include_real_claude:
        description: 'Include real Claude tests (in addition to mock tests)'
        type: boolean
        default: true
      max_parallel:
        description: 'Max parallel jobs per batch'
        type: number
        default: 5

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  id-token: write

env:
  GH_TOKEN: ${{ secrets.NOPO_BOT_PAT || secrets.GITHUB_TOKEN }}

jobs:
  # ============================================================================
  # BATCH 1: Core scenarios (mock Claude)
  # ============================================================================
  batch1-mock:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        scenario:
          - full-flow
          - triage
          - grooming-ready
          - pivot-simple
          - issue-comment
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - uses: pnpm/action-setup@v4
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @more/prompts compile
      - name: Build actions
        run: cd .github/actions-ts && pnpm run build

      - name: Run test
        id: run
        continue-on-error: true
        uses: ./packages/statemachine/actions/sm-test-runner
        with:
          action: run-configurable
          scenario_name: ${{ matrix.scenario }}
          continue: true
          mock_claude: true
          mock_ci: true
          multi_issue: true
          github_token: ${{ secrets.NOPO_BOT_PAT }}
          reviewer_token: ${{ secrets.CLAUDE_REVIEWER_PAT }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}

      - name: Cleanup
        if: always() && steps.run.outputs.issue_number != ''
        uses: ./packages/statemachine/actions/sm-test-helper
        with:
          action: cleanup
          issue_number: ${{ steps.run.outputs.issue_number }}
          github_token: ${{ env.GH_TOKEN }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}
          cleanup_mode: close

      - name: Save result
        if: always()
        run: |
          mkdir -p results
          cat > results/${{ matrix.scenario }}-mock.json << 'EOF'
          {
            "scenario": "${{ matrix.scenario }}",
            "mode": "mock",
            "status": "${{ steps.run.outputs.status || 'error' }}",
            "issue_number": "${{ steps.run.outputs.issue_number || '' }}",
            "error": "${{ steps.run.outputs.error || '' }}",
            "job_result": "${{ job.status }}"
          }
          EOF

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: result-batch1-${{ matrix.scenario }}
          path: results/
          retention-days: 1

  # ============================================================================
  # BATCH 2: Edge case scenarios (mock Claude only - these REQUIRE mock)
  # ============================================================================
  batch2-edge-cases:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        scenario:
          - ci-failure-recovery
          - circuit-breaker
          - review-changes-requested
          - issue-reset
          - slash-lfg
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - uses: pnpm/action-setup@v4
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @more/prompts compile
      - name: Build actions
        run: cd .github/actions-ts && pnpm run build

      - name: Run test
        id: run
        continue-on-error: true
        uses: ./packages/statemachine/actions/sm-test-runner
        with:
          action: run-configurable
          scenario_name: ${{ matrix.scenario }}
          continue: true
          mock_claude: true
          mock_ci: true
          multi_issue: true
          github_token: ${{ secrets.NOPO_BOT_PAT }}
          reviewer_token: ${{ secrets.CLAUDE_REVIEWER_PAT }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}

      - name: Cleanup
        if: always() && steps.run.outputs.issue_number != ''
        uses: ./packages/statemachine/actions/sm-test-helper
        with:
          action: cleanup
          issue_number: ${{ steps.run.outputs.issue_number }}
          github_token: ${{ env.GH_TOKEN }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}
          cleanup_mode: close

      - name: Save result
        if: always()
        run: |
          mkdir -p results
          cat > results/${{ matrix.scenario }}-mock.json << 'EOF'
          {
            "scenario": "${{ matrix.scenario }}",
            "mode": "mock",
            "status": "${{ steps.run.outputs.status || 'error' }}",
            "issue_number": "${{ steps.run.outputs.issue_number || '' }}",
            "error": "${{ steps.run.outputs.error || '' }}",
            "job_result": "${{ job.status }}"
          }
          EOF

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: result-batch2-${{ matrix.scenario }}
          path: results/
          retention-days: 1

  # ============================================================================
  # BATCH 3: PR and pivot scenarios (mock Claude)
  # ============================================================================
  batch3-mock:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        scenario:
          - pr-review-approved
          - pr-review-comment
          - pr-push-during-review
          - pivot-add
          - pivot-remove
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - uses: pnpm/action-setup@v4
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @more/prompts compile
      - name: Build actions
        run: cd .github/actions-ts && pnpm run build

      - name: Run test
        id: run
        continue-on-error: true
        uses: ./packages/statemachine/actions/sm-test-runner
        with:
          action: run-configurable
          scenario_name: ${{ matrix.scenario }}
          continue: true
          mock_claude: true
          mock_ci: true
          multi_issue: true
          github_token: ${{ secrets.NOPO_BOT_PAT }}
          reviewer_token: ${{ secrets.CLAUDE_REVIEWER_PAT }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}

      - name: Cleanup
        if: always() && steps.run.outputs.issue_number != ''
        uses: ./packages/statemachine/actions/sm-test-helper
        with:
          action: cleanup
          issue_number: ${{ steps.run.outputs.issue_number }}
          github_token: ${{ env.GH_TOKEN }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}
          cleanup_mode: close

      - name: Save result
        if: always()
        run: |
          mkdir -p results
          cat > results/${{ matrix.scenario }}-mock.json << 'EOF'
          {
            "scenario": "${{ matrix.scenario }}",
            "mode": "mock",
            "status": "${{ steps.run.outputs.status || 'error' }}",
            "issue_number": "${{ steps.run.outputs.issue_number || '' }}",
            "error": "${{ steps.run.outputs.error || '' }}",
            "job_result": "${{ job.status }}"
          }
          EOF

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: result-batch3-${{ matrix.scenario }}
          path: results/
          retention-days: 1

  # ============================================================================
  # BATCH 4: Complex pivot scenarios (mock Claude)
  # ============================================================================
  batch4-mock:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        scenario:
          - pivot-revert
          - pivot-complex
          - grooming-with-subissues
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - uses: pnpm/action-setup@v4
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @more/prompts compile
      - name: Build actions
        run: cd .github/actions-ts && pnpm run build

      - name: Run test
        id: run
        continue-on-error: true
        uses: ./packages/statemachine/actions/sm-test-runner
        with:
          action: run-configurable
          scenario_name: ${{ matrix.scenario }}
          continue: true
          mock_claude: true
          mock_ci: true
          multi_issue: true
          github_token: ${{ secrets.NOPO_BOT_PAT }}
          reviewer_token: ${{ secrets.CLAUDE_REVIEWER_PAT }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}

      - name: Cleanup
        if: always() && steps.run.outputs.issue_number != ''
        uses: ./packages/statemachine/actions/sm-test-helper
        with:
          action: cleanup
          issue_number: ${{ steps.run.outputs.issue_number }}
          github_token: ${{ env.GH_TOKEN }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}
          cleanup_mode: close

      - name: Save result
        if: always()
        run: |
          mkdir -p results
          cat > results/${{ matrix.scenario }}-mock.json << 'EOF'
          {
            "scenario": "${{ matrix.scenario }}",
            "mode": "mock",
            "status": "${{ steps.run.outputs.status || 'error' }}",
            "issue_number": "${{ steps.run.outputs.issue_number || '' }}",
            "error": "${{ steps.run.outputs.error || '' }}",
            "job_result": "${{ job.status }}"
          }
          EOF

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: result-batch4-${{ matrix.scenario }}
          path: results/
          retention-days: 1

  # ============================================================================
  # BATCH 5: Real Claude tests (only if include_real_claude is true)
  # Tests core scenarios with actual Claude to verify real behavior
  # ============================================================================
  batch5-real-claude:
    if: inputs.include_real_claude == true
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        scenario:
          - full-flow
          - triage
          - pivot-simple
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - uses: pnpm/action-setup@v4
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @more/prompts compile
      - name: Build actions
        run: cd .github/actions-ts && pnpm run build

      - name: Install Claude Code
        run: |
          set -e
          echo "Installing Claude Code..."
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          if [ -f "$HOME/.local/bin/claude" ]; then
            echo "✓ Claude Code installed at $HOME/.local/bin/claude"
            "$HOME/.local/bin/claude" --version || echo "Warning: Could not get version"
          else
            echo "::error::Claude Code installation failed"
            exit 1
          fi

      - name: Run test
        id: run
        continue-on-error: true
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          CLAUDE_CODE_PATH: /home/runner/.local/bin/claude
        uses: ./packages/statemachine/actions/sm-test-runner
        with:
          action: run-configurable
          scenario_name: ${{ matrix.scenario }}
          continue: true
          mock_claude: false
          mock_ci: true
          multi_issue: true
          github_token: ${{ secrets.NOPO_BOT_PAT }}
          reviewer_token: ${{ secrets.CLAUDE_REVIEWER_PAT }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}

      - name: Cleanup
        if: always() && steps.run.outputs.issue_number != ''
        uses: ./packages/statemachine/actions/sm-test-helper
        with:
          action: cleanup
          issue_number: ${{ steps.run.outputs.issue_number }}
          github_token: ${{ env.GH_TOKEN }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}
          cleanup_mode: close

      - name: Save result
        if: always()
        run: |
          mkdir -p results
          cat > results/${{ matrix.scenario }}-real.json << 'EOF'
          {
            "scenario": "${{ matrix.scenario }}",
            "mode": "real",
            "status": "${{ steps.run.outputs.status || 'error' }}",
            "issue_number": "${{ steps.run.outputs.issue_number || '' }}",
            "error": "${{ steps.run.outputs.error || '' }}",
            "job_result": "${{ job.status }}"
          }
          EOF

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: result-batch5-${{ matrix.scenario }}
          path: results/
          retention-days: 1

  # ============================================================================
  # CLAUDE ANALYSIS: Analyze results and propose solutions
  # ============================================================================
  claude-analysis:
    needs: [batch1-mock, batch2-edge-cases, batch3-mock, batch4-mock, batch5-real-claude]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - uses: pnpm/action-setup@v4
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @more/prompts compile
      - name: Build actions
        run: cd .github/actions-ts && pnpm run build

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: result-*
          path: all-results
          merge-multiple: true

      - name: Aggregate results
        id: aggregate
        run: |
          # Combine all JSON files into a single array
          RESULTS=$(find all-results -name "*.json" -exec cat {} \; | jq -s '.')

          # Count results
          TOTAL=$(echo "$RESULTS" | jq 'length')
          PASSED=$(echo "$RESULTS" | jq '[.[] | select(.status == "completed")] | length')
          FAILED=$(echo "$RESULTS" | jq '[.[] | select(.status != "completed")] | length')

          # Create summary
          SUMMARY="Total: $TOTAL | Passed: $PASSED | Failed: $FAILED"

          if [[ "$FAILED" -gt 0 ]]; then
            HAS_FAILURES="true"
          else
            HAS_FAILURES="false"
          fi

          # Save for Claude
          echo "$RESULTS" > /tmp/all_results.json

          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          echo "has_failures=$HAS_FAILURES" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          # Output summary
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**$SUMMARY**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List failures
          if [[ "$HAS_FAILURES" == "true" ]]; then
            echo "### Failures" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$RESULTS" | jq '[.[] | select(.status != "completed")]' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### All Results" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo "$RESULTS" | jq '.' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Install Claude Code
        run: |
          set -e
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Run Claude Analysis
        id: analysis
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          # Read the results
          RESULTS=$(cat /tmp/all_results.json)

          # Create context file
          cat > /tmp/analysis_prompt.md << 'PROMPT_EOF'
          # State Machine Test Suite Analysis

          You are analyzing the results of an automated end-to-end test suite for a GitHub Actions state machine that automates issue management.

          ## Summary
          PROMPT_EOF

          echo "${{ steps.aggregate.outputs.summary }}" >> /tmp/analysis_prompt.md

          cat >> /tmp/analysis_prompt.md << 'PROMPT_EOF'

          ## Test Results
          ```json
          PROMPT_EOF

          cat /tmp/all_results.json >> /tmp/analysis_prompt.md

          cat >> /tmp/analysis_prompt.md << 'PROMPT_EOF'
          ```

          ## Job Status
          - Batch 1 (Core Mock): ${{ needs.batch1-mock.result }}
          - Batch 2 (Edge Cases): ${{ needs.batch2-edge-cases.result }}
          - Batch 3 (PR/Pivot Mock): ${{ needs.batch3-mock.result }}
          - Batch 4 (Complex Mock): ${{ needs.batch4-mock.result }}
          - Batch 5 (Real Claude): ${{ needs.batch5-real-claude.result }}

          ## Workflow Context
          - Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - Branch: ${{ github.ref_name }}
          - Commit: ${{ github.sha }}

          ## Your Task

          Analyze the test results and provide:

          1. **Validity Assessment**
             - Are these test results valid? (not infrastructure issues)
             - Any flaky tests or timing issues?

          2. **For Failures (if any)**
             - Root cause analysis for each failure
             - Is it a test fixture issue, state machine bug, or external dependency?
             - Specific fix recommendation with file paths if possible

          3. **Overall Health**
             - If all passing: Confirm suite health
             - If failures: Prioritize fixes
             - Actionable next steps

          Format as GitHub-flavored markdown.
          PROMPT_EOF

          # Run Claude
          echo "Running Claude analysis..."
          ANALYSIS=$(~/.local/bin/claude --print --dangerously-skip-permissions -p "$(cat /tmp/analysis_prompt.md)" 2>&1 || echo "Claude analysis failed")

          # Output
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Claude Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$ANALYSIS" >> $GITHUB_STEP_SUMMARY

      - name: Final Status
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.aggregate.outputs.has_failures }}" == "true" ]]; then
            echo "## ❌ Some Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**${{ steps.aggregate.outputs.failed }}** out of **${{ steps.aggregate.outputs.total }}** tests failed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See Claude analysis above for recommendations." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ✅ All Tests Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All **${{ steps.aggregate.outputs.total }}** tests completed successfully." >> $GITHUB_STEP_SUMMARY
          fi
