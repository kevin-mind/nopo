name: Test All Scenarios with Claude Analysis

run-name: "All Scenarios | ${{ inputs.include_real_claude && 'Mock + Real Claude' || 'Mock Only' }}"

on:
  workflow_dispatch:
    inputs:
      include_real_claude:
        description: 'Include real Claude tests (in addition to mock tests)'
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  id-token: write

env:
  GH_TOKEN: ${{ secrets.NOPO_BOT_PAT || secrets.GITHUB_TOKEN }}

jobs:
  # ============================================================================
  # Mock Claude tests - all scenarios
  # ============================================================================
  test-mock-claude:
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        scenario:
          - full-flow
          - triage
          - grooming-ready
          - pivot-simple
          - issue-comment
          - ci-failure-recovery
          - circuit-breaker
          - review-changes-requested
          - issue-reset
          - slash-lfg
          - pr-review-approved
          - pr-review-comment
          - pr-push-during-review
          - pivot-add
          - pivot-remove
          - pivot-revert
          - pivot-complex
          - grooming-with-subissues
    uses: ./.github/workflows/_test_claude.yml
    with:
      scenario_name: ${{ matrix.scenario }}
      mode: mock
      mock_claude: true
    secrets: inherit

  # ============================================================================
  # Real Claude tests - core scenarios only (conditional)
  # ============================================================================
  test-real-claude:
    if: inputs.include_real_claude == true
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        scenario:
          - full-flow
          - triage
          - pivot-simple
    uses: ./.github/workflows/_test_claude.yml
    with:
      scenario_name: ${{ matrix.scenario }}
      mode: real
      mock_claude: false
    secrets: inherit

  # ============================================================================
  # Sweep: Belt-and-suspenders cleanup of all test resources
  # ============================================================================
  sweep:
    needs: [test-mock-claude, test-real-claude]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/setup-nopo
      - run: nopo build --tags github-actions

      - name: Download all manifests
        uses: actions/download-artifact@v4
        with:
          pattern: manifest-*
          path: manifests
          merge-multiple: true

      - name: Sweep all test resources
        if: hashFiles('manifests/*.json') != ''
        uses: ./packages/statemachine/actions/sm-test-helper
        with:
          action: sweep
          manifest_dir: manifests
          github_token: ${{ secrets.NOPO_BOT_PAT }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}

  # ============================================================================
  # Claude Analysis: Analyze results and propose solutions
  # ============================================================================
  analysis:
    needs: [test-mock-claude, test-real-claude]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node
      - uses: ./.github/actions/setup-nopo
      - run: nopo build --tags github-actions

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: result-*
          path: all-results
          merge-multiple: true

      - name: Aggregate results
        id: aggregate
        env:
          MOCK_RESULT: ${{ needs.test-mock-claude.result }}
          REAL_RESULT: ${{ needs.test-real-claude.result }}
          RUN_ID: ${{ github.run_id }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          BRANCH: ${{ github.ref_name }}
          COMMIT: ${{ github.sha }}
        run: |
          # Combine all JSON files into a single array
          RESULTS=$(find all-results -name "*.json" -exec cat {} \; | jq -s '.')

          # Count results
          TOTAL=$(echo "$RESULTS" | jq 'length')
          PASSED=$(echo "$RESULTS" | jq '[.[] | select(.status == "completed")] | length')
          FAILED=$(echo "$RESULTS" | jq '[.[] | select(.status != "completed")] | length')

          # Create summary
          SUMMARY="Total: $TOTAL | Passed: $PASSED | Failed: $FAILED"

          if [[ "$FAILED" -gt 0 ]]; then
            HAS_FAILURES="true"
          else
            HAS_FAILURES="false"
          fi

          # Build enriched results file with workflow metadata
          jq -n \
            --arg run_id "$RUN_ID" \
            --arg run_url "$RUN_URL" \
            --arg branch "$BRANCH" \
            --arg commit "$COMMIT" \
            --arg mock "$MOCK_RESULT" \
            --arg real "$REAL_RESULT" \
            --arg summary "$SUMMARY" \
            --argjson results "$RESULTS" \
            '{
              workflow: {
                run_id: $run_id,
                run_url: $run_url,
                branch: $branch,
                commit: $commit,
                batches: {
                  "test-mock-claude": $mock,
                  "test-real-claude": $real
                }
              },
              summary: $summary,
              results: $results
            }' > /tmp/all_results.json

          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
          echo "has_failures=$HAS_FAILURES" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          # Output summary
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**$SUMMARY**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List failures
          if [[ "$HAS_FAILURES" == "true" ]]; then
            echo "### Failures" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$RESULTS" | jq '[.[] | select(.status != "completed")]' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### All Results" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo "$RESULTS" | jq '.' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Install Claude Code
        run: |
          set -e
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Collect scenario context for failures
        id: scenario-docs
        if: steps.aggregate.outputs.has_failures == 'true'
        run: |
          DOCS=""
          SCENARIOS_DIR="packages/statemachine/actions/sm-test-runner/fixtures/scenarios"
          DISCUSSION_DIR="packages/statemachine/actions/sm-test-runner/fixtures/discussion/scenarios"

          # Extract failed scenario names from results
          FAILED=$(jq -r '.results[] | select(.status != "completed" or .job_result == "failure") | .scenario' /tmp/all_results.json | sort -u)

          for scenario in $FAILED; do
            # Check issue scenarios first, then discussion scenarios
            if [ -f "$SCENARIOS_DIR/$scenario/README.md" ]; then
              DOCS+="$(cat "$SCENARIOS_DIR/$scenario/README.md")"
              DOCS+=$'\n\n---\n\n'
            elif [ -f "$DISCUSSION_DIR/$scenario/README.md" ]; then
              DOCS+="$(cat "$DISCUSSION_DIR/$scenario/README.md")"
              DOCS+=$'\n\n---\n\n'
            fi
          done

          echo "$DOCS" > /tmp/scenario_docs.md

      - name: Build prompt templates
        run: pnpm --filter @more/prompts exec tsx scripts/render-templates.ts

      - name: Run Claude Analysis
        id: claude
        uses: ./packages/claude/actions/claude
        with:
          prompt_file: packages/prompts/prompts/test-analysis.txt
          prompt_vars: >-
            {"TEST_RESULTS_FILE":"/tmp/all_results.json","SCENARIO_DOCS_FILE":"${{ steps.aggregate.outputs.has_failures == 'true' && '/tmp/scenario_docs.md' || '' }}"}
          allowed_tools: "Read,Bash"
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Write analysis to summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Claude Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.claude.outputs.output }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Stats:** ${{ steps.claude.outputs.num_turns }} turns | \$${{ steps.claude.outputs.cost_usd }} cost" >> $GITHUB_STEP_SUMMARY

      - name: Final Status
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.aggregate.outputs.has_failures }}" == "true" ]]; then
            echo "## ❌ Some Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**${{ steps.aggregate.outputs.failed }}** out of **${{ steps.aggregate.outputs.total }}** tests failed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See Claude analysis above for recommendations." >> $GITHUB_STEP_SUMMARY
            # Fail the workflow when tests fail
            exit 1
          else
            echo "## ✅ All Tests Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All **${{ steps.aggregate.outputs.total }}** tests completed successfully." >> $GITHUB_STEP_SUMMARY
          fi
