name: Claude Implement

on:
  issues:
    types: [assigned]

concurrency:
  group: claude-issue-${{ github.event.issue.number }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  check:
    runs-on: ubuntu-latest
    # Only run when assigned to Claude
    if: github.event.assignee.login == 'claude[bot]'
    outputs:
      should_implement: ${{ steps.check-pr.outputs.should_implement }}
    steps:
      - name: Check if PR already exists
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Check if there's already a PR for this issue
          existing_pr=$(gh pr list --repo "$GITHUB_REPOSITORY" --search "Fixes #$ISSUE_NUMBER in:body" --json number --jq '.[0].number' || true)

          if [[ -n "$existing_pr" && "$existing_pr" != "null" ]]; then
            echo "PR #$existing_pr already exists for issue #$ISSUE_NUMBER"
            echo "should_implement=false" >> $GITHUB_OUTPUT
          else
            echo "No existing PR found - proceeding with implementation"
            echo "should_implement=true" >> $GITHUB_OUTPUT
          fi

  update-project-status:
    needs: check
    if: needs.check.outputs.should_implement == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Update project status to In Progress
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Get project item from issue
          result=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $number) {
                  projectItems(first: 10) {
                    nodes {
                      id
                      project { id }
                    }
                  }
                }
              }
            }
          ' -f owner="${GITHUB_REPOSITORY_OWNER}" -f repo="${GITHUB_REPOSITORY#*/}" -F number="$ISSUE_NUMBER")

          item_id=$(echo "$result" | jq -r '.data.repository.issue.projectItems.nodes[0].id // empty')
          project_id=$(echo "$result" | jq -r '.data.repository.issue.projectItems.nodes[0].project.id // empty')

          if [[ -z "$item_id" || -z "$project_id" ]]; then
            echo "Issue not linked to a project - skipping status update"
            exit 0
          fi

          # Get Status field and In Progress option IDs
          fields=$(gh api graphql -f query='
            query($projectId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options { id name }
                      }
                    }
                  }
                }
              }
            }
          ' -f projectId="$project_id")

          field_id=$(echo "$fields" | jq -r '.data.node.fields.nodes[] | select(.name == "Status") | .id')
          option_id=$(echo "$fields" | jq -r '.data.node.fields.nodes[] | select(.name == "Status") | .options[] | select(.name == "In Progress") | .id')

          if [[ -z "$field_id" || -z "$option_id" ]]; then
            echo "Could not find Status field or In Progress option"
            exit 0
          fi

          # Update to In Progress status
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(
                input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { singleSelectOptionId: $optionId }
                }
              ) { projectV2Item { id } }
            }
          ' -f projectId="$project_id" -f itemId="$item_id" -f fieldId="$field_id" -f optionId="$option_id"

          echo "Updated project item to In Progress status"

  implement:
    needs: [check, update-project-status]
    if: needs.check.outputs.should_implement == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@anthropic.com"

      - name: Create or checkout branch
        id: branch
        env:
          BRANCH_NAME: feat/issue-${{ github.event.issue.number }}
        run: |
          git fetch origin
          if git show-ref --verify --quiet refs/remotes/origin/$BRANCH_NAME; then
            git checkout $BRANCH_NAME
            git pull origin $BRANCH_NAME
          else
            git checkout -b $BRANCH_NAME
          fi
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Implement issue #${{ github.event.issue.number }}: "${{ github.event.issue.title }}"

            Issue body:
            ${{ github.event.issue.body }}

            You are on branch `${{ steps.branch.outputs.name }}`.

            INSTRUCTIONS:

            1. IMPLEMENT:
               - Follow the guidelines in CLAUDE.md strictly
               - Address all items in the Todo section
               - Keep changes focused and minimal

            2. VERIFY:
               - Run `make check` to validate linting and types
               - Run `make test` to run tests
               - Fix any failures before proceeding

            3. COMMIT AND PUSH:
               - Commit your changes with a descriptive message
               - Push the branch to origin

            4. CREATE DRAFT PR:
               - Use `gh pr create --draft` to create a DRAFT pull request
               - The PR body MUST contain "Fixes #${{ github.event.issue.number }}"
               - Include a detailed description of changes

            IMPORTANT:
            - The "Fixes #N" pattern is REQUIRED for automatic issue linking and closure
            - Create as DRAFT so CI can run first - it will be marked ready automatically when CI passes
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 30"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
