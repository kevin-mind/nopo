name: Claude Business Logic
'on':
  workflow_call:
    inputs:
      job:
        description: Job to run
        required: true
        type: string
      context_json:
        description: JSON blob with all context needed by the job
        required: true
        type: string
      mock_mode:
        description: Mock mode for testing
        type: string
        default: 'false'
  workflow_dispatch:
    inputs:
      job:
        description: Job to run
        required: true
        type: choice
        options:
          - issue-triage
          - issue-implement
          - issue-comment
          - ci-fix
          - ci-suggest
          - pr-review
          - pr-response
          - pr-human-response
          - discussion-research
          - discussion-respond
          - discussion-summarize
          - discussion-plan
      context_json:
        description: JSON blob with context (see plan for structure)
        required: true
        type: string
      mock_mode:
        description: Mock mode for testing
        type: string
        default: 'false'
permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write
defaults:
  run:
    shell: bash

jobs:
  # ============================================================================
  # CONTEXT - Transform input to prompt replacements format
  # ============================================================================
  context:
    runs-on: ubuntu-latest
    outputs:
      prompt_replacements: ${{ steps.format.outputs.json }}
      branch_name: ${{ steps.extract.outputs.branch_name }}
    steps:
      - id: extract
        name: Extract branch_name for checkout
        run: |
          branch=$(echo '${{ inputs.context_json }}' | jq -r '.branch_name // "main"')
          echo "branch_name=$branch" >> $GITHUB_OUTPUT

      - id: format
        name: Transform to uppercase keys
        run: |
          # Transform all keys to uppercase for prompt replacements
          # Use -c for compact single-line output (required for GITHUB_OUTPUT)
          json=$(echo '${{ inputs.context_json }}' | jq -c 'with_entries(.key |= ascii_upcase)')
          echo "json=$json" >> $GITHUB_OUTPUT

  # ============================================================================
  # ISSUE JOBS
  # ============================================================================
  issue-triage:
    needs: context
    if: inputs.job == 'issue-triage'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/triage.txt
          prompt_replacements: ${{ needs.context.outputs.prompt_replacements }}
          max_turns: '50'
          mock_mode: ${{ inputs.mock_mode }}
      - uses: actions/upload-artifact@v4
        with:
          name: claude-triage-output
          path: triage-output.json
          retention-days: 1
          if-no-files-found: ignore

  issue-implement:
    needs: context
    if: inputs.job == 'issue-implement'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.context.outputs.branch_name }}
          fetch-depth: 0
      - name: git config
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@anthropic.com"
      - id: augment
        name: Check for existing branch work
        env:
          BRANCH_NAME: ${{ needs.context.outputs.branch_name }}
          BASE_REPLACEMENTS: ${{ needs.context.outputs.prompt_replacements }}
        run: |
          # Check if branch has commits beyond main
          diff=$(git diff main.."$BRANCH_NAME" --stat 2>/dev/null || echo "")
          if [[ -n "$diff" ]]; then
            section=$(cat <<'SECTION'
          ## ⚠️ EXISTING BRANCH - Previous work detected

          This branch already has changes from a previous implementation attempt:
          ```
          $diff
          ```

          **CRITICAL**: Review what is already done. Do NOT re-implement completed work.
          Start from the CURRENT state of the code and continue toward the goal.
          If an edit fails because the text is not found, the change may already be applied.
          SECTION
          )
            section="${section//\$diff/$diff}"
          else
            section=""
          fi
          # Add EXISTING_BRANCH_SECTION to replacements
          json=$(echo "$BASE_REPLACEMENTS" | jq -c --arg section "$section" '. + {EXISTING_BRANCH_SECTION: $section}')
          echo "json=$json" >> $GITHUB_OUTPUT
      - uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/implement.txt
          prompt_replacements: ${{ steps.augment.outputs.json }}
          max_turns: '200'
          show_full_output: 'true'
          assignee_trigger: nopo-bot
          mock_mode: ${{ inputs.mock_mode }}

  issue-comment:
    needs: context
    if: inputs.job == 'issue-comment'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.context.outputs.branch_name }}
          fetch-depth: 0
      - uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/comment.txt
          prompt_replacements: ${{ needs.context.outputs.prompt_replacements }}
          max_turns: '100'
          trigger_phrase: '@claude'
          mock_mode: ${{ inputs.mock_mode }}

  # ============================================================================
  # CI JOBS
  # ============================================================================
  ci-fix:
    needs: context
    if: inputs.job == 'ci-fix'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.context.outputs.branch_name }}
          fetch-depth: 0
      - name: git config
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@anthropic.com"
      - id: augment
        name: Add HEAD_BRANCH alias
        env:
          BASE_REPLACEMENTS: ${{ needs.context.outputs.prompt_replacements }}
          BRANCH_NAME: ${{ needs.context.outputs.branch_name }}
        run: |
          json=$(echo "$BASE_REPLACEMENTS" | jq -c --arg branch "$BRANCH_NAME" '. + {HEAD_BRANCH: $branch}')
          echo "json=$json" >> $GITHUB_OUTPUT
      - uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/ci-fix.txt
          prompt_replacements: ${{ steps.augment.outputs.json }}
          max_turns: '200'
          mock_mode: ${{ inputs.mock_mode }}

  ci-suggest:
    needs: context
    if: inputs.job == 'ci-suggest'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.context.outputs.branch_name }}
          fetch-depth: 0
      - id: augment
        name: Add HEAD_BRANCH alias
        env:
          BASE_REPLACEMENTS: ${{ needs.context.outputs.prompt_replacements }}
          BRANCH_NAME: ${{ needs.context.outputs.branch_name }}
        run: |
          json=$(echo "$BASE_REPLACEMENTS" | jq -c --arg branch "$BRANCH_NAME" '. + {HEAD_BRANCH: $branch}')
          echo "json=$json" >> $GITHUB_OUTPUT
      - uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/ci-suggest.txt
          prompt_replacements: ${{ steps.augment.outputs.json }}
          max_turns: '200'
          mock_mode: ${{ inputs.mock_mode }}

  # ============================================================================
  # PR REVIEW JOBS
  # ============================================================================
  pr-review:
    needs: context
    if: inputs.job == 'pr-review'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.context.outputs.branch_name }}
          fetch-depth: 0
      - uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/review.txt
          prompt_replacements: ${{ needs.context.outputs.prompt_replacements }}
          max_turns: '50'
          mock_mode: ${{ inputs.mock_mode }}

  pr-response:
    needs: context
    if: inputs.job == 'pr-response'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.context.outputs.branch_name }}
          fetch-depth: 0
      - name: git config
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@anthropic.com"
      - id: augment
        name: Add REPOSITORY and HEAD_REF
        env:
          BASE_REPLACEMENTS: ${{ needs.context.outputs.prompt_replacements }}
          BRANCH_NAME: ${{ needs.context.outputs.branch_name }}
        run: |
          json=$(echo "$BASE_REPLACEMENTS" | jq -c \
            --arg repo "${{ github.repository }}" \
            --arg branch "$BRANCH_NAME" \
            '. + {REPOSITORY: $repo, HEAD_REF: $branch}')
          echo "json=$json" >> $GITHUB_OUTPUT
      - uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/review-response.txt
          prompt_replacements: ${{ steps.augment.outputs.json }}
          max_turns: '50'
          mock_mode: ${{ inputs.mock_mode }}

  pr-human-response:
    needs: context
    if: inputs.job == 'pr-human-response'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.context.outputs.branch_name }}
          fetch-depth: 0
      - name: git config
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@anthropic.com"
      - id: augment
        name: Add REPOSITORY and HEAD_REF
        env:
          BASE_REPLACEMENTS: ${{ needs.context.outputs.prompt_replacements }}
          BRANCH_NAME: ${{ needs.context.outputs.branch_name }}
        run: |
          json=$(echo "$BASE_REPLACEMENTS" | jq -c \
            --arg repo "${{ github.repository }}" \
            --arg branch "$BRANCH_NAME" \
            '. + {REPOSITORY: $repo, HEAD_REF: $branch}')
          echo "json=$json" >> $GITHUB_OUTPUT
      - uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/human-review-response.txt
          prompt_replacements: ${{ steps.augment.outputs.json }}
          max_turns: '50'
          mock_mode: ${{ inputs.mock_mode }}

  # ============================================================================
  # DISCUSSION JOBS
  # ============================================================================
  discussion-research:
    needs: context
    if: inputs.job == 'discussion-research'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/discussion-research.txt
          prompt_replacements: ${{ needs.context.outputs.prompt_replacements }}
          max_turns: '30'
          show_full_output: 'true'
          mock_mode: ${{ inputs.mock_mode }}
      - uses: actions/upload-artifact@v4
        with:
          name: claude-discussion-output
          path: |
            /tmp/research-thread-*.md
            /tmp/discussion-updated-body.md
          retention-days: 1
          if-no-files-found: ignore

  discussion-respond:
    needs: context
    if: inputs.job == 'discussion-respond'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/discussion-respond.txt
          prompt_replacements: ${{ needs.context.outputs.prompt_replacements }}
          max_turns: '100'
          show_full_output: 'true'
          mock_mode: ${{ inputs.mock_mode }}
      - uses: actions/upload-artifact@v4
        with:
          name: claude-discussion-output
          path: |
            /tmp/discussion-response.md
            /tmp/discussion-updated-body.md
          retention-days: 1
          if-no-files-found: ignore

  discussion-summarize:
    needs: context
    if: inputs.job == 'discussion-summarize'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/discussion-summarize.txt
          prompt_replacements: ${{ needs.context.outputs.prompt_replacements }}
          max_turns: '50'
          show_full_output: 'true'
          mock_mode: ${{ inputs.mock_mode }}
      - uses: actions/upload-artifact@v4
        with:
          name: claude-discussion-output
          path: /tmp/discussion-summary.md
          retention-days: 1
          if-no-files-found: ignore

  discussion-plan:
    needs: context
    if: inputs.job == 'discussion-plan'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/discussion-plan.txt
          prompt_replacements: ${{ needs.context.outputs.prompt_replacements }}
          max_turns: '100'
          show_full_output: 'true'
          mock_mode: ${{ inputs.mock_mode }}
      - uses: actions/upload-artifact@v4
        with:
          name: claude-discussion-output
          path: /tmp/discussion-plan-summary.md
          retention-days: 1
          if-no-files-found: ignore
