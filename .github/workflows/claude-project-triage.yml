name: Claude Project Triage

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: read
  issues: write
  id-token: write

jobs:
  check-triage:
    runs-on: ubuntu-latest
    outputs:
      should_triage: ${{ steps.check.outputs.should_triage }}
    steps:
      - name: Check if triage needed
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Get issue labels
          labels=$(gh issue view "$ISSUE_NUMBER" --json labels --jq '.labels[].name' | tr '\n' ' ')

          # Triage if:
          # 1. Issue was just opened (no triage label yet)
          # 2. Issue has 'needs-triage' label
          if [[ "${{ github.event.action }}" == "opened" ]]; then
            echo "New issue opened - needs triage"
            echo "should_triage=true" >> $GITHUB_OUTPUT
          elif [[ "$labels" == *"needs-triage"* ]]; then
            echo "Issue has needs-triage label"
            echo "should_triage=true" >> $GITHUB_OUTPUT
          else
            echo "No triage needed"
            echo "should_triage=false" >> $GITHUB_OUTPUT
          fi

  triage:
    needs: check-triage
    if: needs.check-triage.outputs.should_triage == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are triaging issue #${{ github.event.issue.number }}: "${{ github.event.issue.title }}"

            Issue body:
            ${{ github.event.issue.body }}

            Your tasks:
            1. ADD APPROPRIATE LABELS based on the issue type:
               - 'bug' for bug reports
               - 'enhancement' for new features
               - 'documentation' for docs changes
               - 'refactor' for code improvements
               - Priority labels if urgency is indicated

            2. SEARCH FOR SIMILAR ISSUES:
               - Use `gh issue list` to find related issues
               - If similar issues exist, add a comment linking to them
               - Check if this might be a duplicate

            3. EXPAND CONTEXT:
               - Review the codebase for relevant files mentioned or implied
               - Add a comment with additional technical context
               - Reference specific files/functions that will be affected

            4. ANSWER QUESTIONS:
               - If the issue has a Questions section, research and answer them
               - Update the issue body or add a comment with answers

            5. VALIDATE COMPLETENESS:
               - If Description or Details are unclear, add 'needs-info' label
               - Ask clarifying questions in a comment
               - If Todo items are vague, suggest more specific tasks

            6. REMOVE 'needs-triage' label when done (if present)

            IMPORTANT:
            - DO NOT add the 'ready' label - a human must do that
            - DO NOT assign the issue to anyone
            - Focus on making the issue as clear and actionable as possible
          claude_args: "--model claude-3-5-sonnet-latest"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
