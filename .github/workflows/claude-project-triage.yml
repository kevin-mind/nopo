name: Claude Project Triage

on:
  projects_v2_item:
    types:
      - created
      - edited

permissions:
  contents: read
  issues: write
  id-token: write

jobs:
  check-status:
    runs-on: ubuntu-latest
    # Only run when Status field changes to Backlog
    if: |
      github.event.changes.field_value.field_name == 'Status' &&
      github.event.changes.field_value.to.name == 'Backlog'
    outputs:
      issue_number: ${{ steps.get-issue.outputs.issue_number }}
      issue_title: ${{ steps.get-issue.outputs.issue_title }}
      issue_body: ${{ steps.get-issue.outputs.issue_body }}
    steps:
      - name: Get issue details
        id: get-issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ITEM_ID: ${{ github.event.projects_v2_item.node_id }}
        run: |
          # Query the project item to get the linked issue
          result=$(gh api graphql -f query='
            query($itemId: ID!) {
              node(id: $itemId) {
                ... on ProjectV2Item {
                  content {
                    ... on Issue {
                      number
                      title
                      body
                    }
                  }
                }
              }
            }
          ' -f itemId="$ITEM_ID")

          issue_number=$(echo "$result" | jq -r '.data.node.content.number // empty')
          issue_title=$(echo "$result" | jq -r '.data.node.content.title // empty')

          if [[ -z "$issue_number" ]]; then
            echo "No issue linked to this project item"
            exit 0
          fi

          echo "issue_number=$issue_number" >> $GITHUB_OUTPUT
          echo "issue_title=$issue_title" >> $GITHUB_OUTPUT

          # Get issue body separately (can be large)
          issue_body=$(echo "$result" | jq -r '.data.node.content.body // empty')
          echo "issue_body<<EOF" >> $GITHUB_OUTPUT
          echo "$issue_body" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  triage:
    needs: check-status
    if: needs.check-status.outputs.issue_number != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are triaging issue #${{ needs.check-status.outputs.issue_number }}: "${{ needs.check-status.outputs.issue_title }}"

            Issue body:
            ${{ needs.check-status.outputs.issue_body }}

            Your tasks:
            1. ADD APPROPRIATE LABELS based on the issue type:
               - 'bug' for bug reports
               - 'enhancement' for new features
               - 'documentation' for docs changes
               - 'refactor' for code improvements
               - Priority labels if urgency is indicated

            2. SEARCH FOR SIMILAR ISSUES:
               - Use `gh issue list` to find related issues
               - If similar issues exist, add a comment linking to them
               - Check if this might be a duplicate

            3. EXPAND CONTEXT:
               - Review the codebase for relevant files mentioned or implied
               - Add a comment with additional technical context
               - Reference specific files/functions that will be affected

            4. ANSWER QUESTIONS:
               - If the issue has a Questions section, research and answer them
               - Update the issue body or add a comment with answers

            5. VALIDATE COMPLETENESS:
               - If Description or Details are unclear, add 'needs-info' label
               - Ask clarifying questions in a comment
               - If Todo items are vague, suggest more specific tasks

            IMPORTANT:
            - DO NOT move the issue to 'Ready' - a human must do that
            - DO NOT assign the issue to anyone
            - Focus on making the issue as clear and actionable as possible
          claude_args: "--model claude-opus-4-5-20251101"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add triaged label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh issue edit ${{ needs.check-status.outputs.issue_number }} --add-label "triaged"
