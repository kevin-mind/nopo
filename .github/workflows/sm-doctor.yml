name: SM Doctor
on:
  workflow_dispatch:
    inputs:
      failed_run_id:
        description: The workflow run ID that failed verification
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

concurrency:
  group: sm-doctor-${{ inputs.failed_run_id }}
  cancel-in-progress: true

jobs:
  diagnose-and-fix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: false

      - name: Configure git
        env:
          NOPO_BOT_PAT: ${{ secrets.NOPO_BOT_PAT }}
        run: |
          git config url."https://${NOPO_BOT_PAT}@github.com/".insteadOf "https://github.com/"
          git config user.name "nopo-bot"
          git config user.email "nopo-bot@users.noreply.github.com"

      - name: Setup Node (pnpm)
        uses: ./.github/actions/setup-node

      - name: Setup nopo CLI
        uses: ./.github/actions/setup-nopo

      - name: Download diagnosis artifact
        env:
          GH_TOKEN: ${{ secrets.NOPO_BOT_PAT }}
        run: |
          gh run download ${{ inputs.failed_run_id }} \
            --name "sm-diagnosis-${{ inputs.failed_run_id }}" \
            --dir /tmp/diagnosis

      - name: Install Claude Code
        run: |
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Create fix branch
        run: git checkout -b "claude/fix/${{ inputs.failed_run_id }}"

      - name: Run Doctor
        id: doctor
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ secrets.NOPO_BOT_PAT }}
        run: |
          claude --print --output-format json \
            --allowedTools "Edit,Write,Read,Glob,Grep,Bash(cd packages/statemachine && pnpm exec vitest run:*)" \
            "You are diagnosing a state machine verification failure.

          1. Read the diagnosis file at /tmp/diagnosis/diagnosis.json
          2. Read the relevant state machine source code (mutators, predictors, compare logic) in packages/statemachine/
          3. Determine: is the prediction wrong (false negative) or the execution wrong (true bug)?
          4. Fix the code in packages/statemachine/
          5. Add a test case that reproduces this failure
          6. Run tests: cd packages/statemachine && pnpm exec vitest run

          Return a JSON object with these fields:
          - classification: one of false_negative, true_bug, race_condition, unknown
          - confidence: 0-1 confidence score
          - root_cause: detailed explanation of what went wrong
          - fix_summary: what was changed and why
          - affected_files: list of files that were modified" \
            > /tmp/doctor-output.json || true

          # Extract structured fields — handle both direct JSON and wrapped output
          if jq -e '.root_cause' /tmp/doctor-output.json > /dev/null 2>&1; then
            ROOT_CAUSE=$(jq -r '.root_cause' /tmp/doctor-output.json)
            FIX_SUMMARY=$(jq -r '.fix_summary' /tmp/doctor-output.json)
            CLASSIFICATION=$(jq -r '.classification' /tmp/doctor-output.json)
            CONFIDENCE=$(jq -r '.confidence' /tmp/doctor-output.json)
          else
            ROOT_CAUSE="See doctor output for details"
            FIX_SUMMARY="See doctor output for details"
            CLASSIFICATION="unknown"
            CONFIDENCE="0"
          fi

          {
            echo "root_cause<<EOF"
            echo "$ROOT_CAUSE"
            echo "EOF"
            echo "fix_summary<<EOF"
            echo "$FIX_SUMMARY"
            echo "EOF"
            echo "classification=$CLASSIFICATION"
            echo "confidence=$CONFIDENCE"
          } >> "$GITHUB_OUTPUT"

      - name: Create PR
        if: ${{ !cancelled() }}
        env:
          GH_TOKEN: ${{ secrets.NOPO_BOT_PAT }}
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes — doctor could not produce a fix"
            exit 0
          fi

          git add -A
          git commit -m "$(cat <<'COMMIT_EOF'
          fix(statemachine): auto-fix verification failure from run #${{ inputs.failed_run_id }}

          Co-Authored-By: Claude <noreply@anthropic.com>
          COMMIT_EOF
          )"

          git push -u origin "claude/fix/${{ inputs.failed_run_id }}"

          FAILED_RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ inputs.failed_run_id }}"
          DOCTOR_RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          gh pr create \
            --title "fix(statemachine): auto-fix verification failure #${{ inputs.failed_run_id }}" \
            --body "$(cat <<PR_EOF
          ## Verification Failure Auto-Fix

          **Failed run:** ${FAILED_RUN_URL}
          **Doctor run:** ${DOCTOR_RUN_URL}
          **Classification:** ${{ steps.doctor.outputs.classification }} (confidence: ${{ steps.doctor.outputs.confidence }})

          ## Root Cause

          ${{ steps.doctor.outputs.root_cause }}

          ## Fix Summary

          ${{ steps.doctor.outputs.fix_summary }}

          ## Test Plan

          - [ ] New test case covers the failure scenario
          - [ ] All existing statemachine tests pass
          - [ ] Manual review of the fix

          Generated by sm-doctor
          PR_EOF
          )"
