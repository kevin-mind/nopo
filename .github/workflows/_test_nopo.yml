name: Test Nopo CLI
'on':
  workflow_call: {}
permissions: {}
defaults:
  run:
    shell: bash
jobs:
  build:
    runs-on: ubuntu-latest
    name: '[nopo] build (${{ matrix.expected }})'
    strategy:
      matrix:
        expected:
          - success
          - failure
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: setup_node
        uses: ./.github/actions/setup-node
      - id: setup_uv
        uses: ./.github/actions/setup-uv
      - id: monkeywrench
        name: Monkeywrench nopo
        if: ${{ matrix.expected == 'failure' }}
        run: |
          rm -f ./nopo/scripts/src/index.ts
      - id: nopo
        name: Make nopo
        continue-on-error: true
        run: make -C ./nopo/scripts init
      - id: verify
        name: Verify result
        env:
          expected: ${{ matrix.expected }}
          actual: ${{ steps.nopo.outcome }}
        run: |-
          if [[ "$expected" != "$actual" ]]; then
            echo "Expected build to result in $expected, but got $actual"
            exit 1
          fi
  unit:
    runs-on: ubuntu-latest
    name: '[nopo] unit tests'
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: setup_node
        uses: ./.github/actions/setup-node
      - id: setup_uv
        uses: ./.github/actions/setup-uv
      - id: setup_nopo
        uses: ./.github/actions/setup-nopo
      - id: run_tests
        name: Run unit tests
        run: nopo test nopo root
  actions:
    runs-on: ubuntu-latest
    name: '[actions] TypeScript actions'
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: setup_node
        uses: ./.github/actions/setup-node
      - id: setup_nopo
        uses: ./.github/actions/setup-nopo
      - id: run_tests
        name: Run TypeScript actions tests
        run: nopo test actions root
      - id: validate_build
        name: Validate TypeScript actions build
        run: nopo check actions root
  e2e:
    runs-on: ubuntu-latest
    name: '[nopo] e2e: ${{ matrix.test.name }}'
    strategy:
      fail-fast: false
      matrix:
        test:
          - name: list services
            command: nopo list
            expect: minimal
          - name: list json
            command: nopo list --json
            expect: complex
          - name: list dependent
            command: nopo list
            expect: dependent
          - name: test command
            command: nopo test minimal
            expect: FIXTURE_MINIMAL_TEST_SUCCESS
          - name: check command
            command: nopo check minimal
            expect: FIXTURE_MINIMAL_CHECK_SUCCESS
          - name: subcommand check:py
            command: nopo check py complex
            expect: FIXTURE_COMPLEX_CHECK_PY_SUCCESS
          # Test: subcommand only in one service runs only on that service (no error)
          - name: subcommand filter (only complex has compile:unique)
            command: nopo compile unique
            expect: FIXTURE_COMPLEX_COMPILE_UNIQUE_SUCCESS
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: setup_node
        uses: ./.github/actions/setup-node
      - id: setup_uv
        uses: ./.github/actions/setup-uv
      - id: setup_nopo
        uses: ./.github/actions/setup-nopo
      - id: run_e2e
        name: Run ${{ matrix.test.name }}
        working-directory: ./nopo/fixtures
        env:
          COMMAND: ${{ matrix.test.command }}
          EXPECT: ${{ matrix.test.expect }}
        run: |-
          echo "Running: $COMMAND"
                  output=$($COMMAND 2>&1) || true
                  echo "$output"
                  if [[ -n "$EXPECT" ]]; then
                    if echo "$output" | grep -q "$EXPECT"; then
                      echo "✓ Found expected output: $EXPECT"
                    else
                      echo "✗ Expected output not found: $EXPECT"
                      exit 1
                    fi
                  fi
