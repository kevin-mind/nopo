# This file was auto-generated by github-actions-workflow-ts.
# Do not edit directly. Instead, edit the corresponding .wac.ts file in .github/workflows-ts/
# and run `pnpm run gwf:build` to regenerate this file.
name: Claude Stalled Review Detector
'on':
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: Dry run (don't post comments)
        required: false
        default: 'false'
        type: boolean
permissions:
  contents: read
  pull-requests: write
  issues: write
defaults:
  run:
    shell: bash
jobs:
  detect-stalled-reviews:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check for stalled review requests
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |-
          echo "Checking for PRs with stalled nopo-bot review requests..."

          # Get all open PRs with nopo-bot as requested reviewer
          prs=$(gh pr list --repo "$GITHUB_REPOSITORY" --state open --json number,title,headRefName,isDraft,reviewRequests,createdAt,updatedAt)

          echo "$prs" | jq -c '.[]' | while read -r pr; do
            pr_number=$(echo "$pr" | jq -r '.number')
            pr_title=$(echo "$pr" | jq -r '.title')
            is_draft=$(echo "$pr" | jq -r '.isDraft')
            review_requests=$(echo "$pr" | jq -r '.reviewRequests')

            # Check if nopo-bot is requested
            has_nopo_bot=$(echo "$review_requests" | jq '[.[] | select(.login == "nopo-bot")] | length')

            if [[ "$has_nopo_bot" -eq 0 ]]; then
              continue
            fi

            echo "PR #$pr_number has nopo-bot requested"

            # Check if there's a recent "reviewing" comment from nopo-bot
            recent_comment=$(gh api "/repos/$GITHUB_REPOSITORY/issues/$pr_number/comments" \
              --jq '[.[] | select(.user.login == "github-actions[bot]" and (.body | contains("nopo-bot") and contains("reviewing")))] | sort_by(.created_at) | last // empty')

            if [[ -n "$recent_comment" ]]; then
              comment_time=$(echo "$recent_comment" | jq -r '.created_at')
              echo "  Found reviewing comment at: $comment_time"
              # Review is in progress, not stalled
              continue
            fi

            # No recent reviewing comment - check if review was submitted
            reviews=$(gh api "/repos/$GITHUB_REPOSITORY/pulls/$pr_number/reviews" \
              --jq '[.[] | select(.user.login == "claude[bot]")] | length')

            if [[ "$reviews" -gt 0 ]]; then
              echo "  Claude already reviewed - not stalled"
              continue
            fi

            # Determine why the review might be stalled
            reason=""
            if [[ "$is_draft" == "true" ]]; then
              reason="PR is a draft (reviews are skipped for drafts)"
            else
              reason="No review started - possible webhook failure or workflow error"
            fi

            echo "  STALLED: $reason"

            if [[ "$DRY_RUN" == "true" ]]; then
              echo "  [DRY RUN] Would post comment to PR #$pr_number"
              continue
            fi

            # Check if we already posted a stalled notification recently (within 2 hours)
            existing_notification=$(gh api "/repos/$GITHUB_REPOSITORY/issues/$pr_number/comments" \
              --jq '[.[] | select(.user.login == "github-actions[bot]" and (.body | contains("Review Request Stalled")))] | sort_by(.created_at) | last // empty')

            if [[ -n "$existing_notification" ]]; then
              notification_time=$(echo "$existing_notification" | jq -r '.created_at')
              # Skip if notification is less than 2 hours old
              notification_epoch=$(date -d "$notification_time" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$notification_time" +%s 2>/dev/null || echo "0")
              current_epoch=$(date +%s)
              hours_diff=$(( (current_epoch - notification_epoch) / 3600 ))

              if [[ "$hours_diff" -lt 2 ]]; then
                echo "  Already notified $hours_diff hours ago - skipping"
                continue
              fi
            fi

            # Post diagnostic comment
            gh pr comment "$pr_number" --body "## ⚠️ Review Request Stalled

          **nopo-bot** was requested as a reviewer but no review has started.

          **Possible reason:** $reason

          **To retry:**
          1. Remove nopo-bot from reviewers: \`gh pr edit $pr_number --remove-reviewer nopo-bot\`
          2. Re-add nopo-bot: \`gh pr edit $pr_number --add-reviewer nopo-bot\`

          Or check the [Actions tab](https://github.com/$GITHUB_REPOSITORY/actions/workflows/claude-review-loop.yml) for failed workflow runs.

          _This is an automated diagnostic message._"

            echo "  Posted stalled review notification"
          done

          echo "Done checking for stalled reviews"
