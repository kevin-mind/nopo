name: Claude CI Fix

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

concurrency:
  group: claude-ci-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  check-pr:
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    outputs:
      has_pr: ${{ steps.check.outputs.has_pr }}
      is_claude_pr: ${{ steps.check.outputs.is_claude_pr }}
      is_draft: ${{ steps.check.outputs.is_draft }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Check PR author and draft status
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          # Find PR for this branch
          pr=$(gh pr list --repo "$GITHUB_REPOSITORY" --head "$HEAD_BRANCH" --json number,author,isDraft --jq '.[0]')

          if [[ -z "$pr" ]]; then
            echo "No PR found for branch $HEAD_BRANCH"
            echo "has_pr=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          pr_number=$(echo "$pr" | jq -r '.number')
          author=$(echo "$pr" | jq -r '.author.login')
          is_draft=$(echo "$pr" | jq -r '.isDraft')

          echo "PR #$pr_number by $author (draft: $is_draft)"
          echo "has_pr=true" >> $GITHUB_OUTPUT
          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
          echo "is_draft=$is_draft" >> $GITHUB_OUTPUT

          # Check if PR was created by Claude automation
          if [[ "$author" == "claude[bot]" ]]; then
            echo "is_claude_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_claude_pr=false" >> $GITHUB_OUTPUT
          fi

  # Convert Claude PR to draft on CI failure
  convert-to-draft:
    needs: check-pr
    if: |
      needs.check-pr.outputs.has_pr == 'true' &&
      needs.check-pr.outputs.is_claude_pr == 'true' &&
      needs.check-pr.outputs.is_draft == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Convert PR to draft
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.check-pr.outputs.pr_number }}
        run: |
          gh pr ready "$PR_NUMBER" --undo --repo "$GITHUB_REPOSITORY"
          echo "Converted PR #$PR_NUMBER to draft due to CI failure"

  # For Claude PRs: fix and push directly (PR is now draft)
  fix-and-push:
    needs: [check-pr, convert-to-draft]
    if: |
      (needs.convert-to-draft.result == 'success' || needs.convert-to-draft.result == 'skipped') &&
      needs.check-pr.outputs.has_pr == 'true' &&
      needs.check-pr.outputs.is_claude_pr == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check Claude comment count
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.check-pr.outputs.pr_number }}
        run: |
          # Count comments from claude[bot] on this PR
          review_comments=$(gh api "/repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER/comments" --jq '[.[] | select(.user.login == "claude[bot]")] | length')
          issue_comments=$(gh api "/repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments" --jq '[.[] | select(.user.login == "claude[bot]")] | length')
          reviews=$(gh api "/repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER/reviews" --jq '[.[] | select(.user.login == "claude[bot]")] | length')

          total=$((review_comments + issue_comments + reviews))
          echo "Claude has made $total comments/reviews on PR #$PR_NUMBER"

          if [[ "$total" -gt 20 ]]; then
            echo "::error::Claude has made over 20 comments on this PR. Stopping to prevent infinite loop."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@anthropic.com"

      - name: Create Claude settings
        run: |
          mkdir -p .claude
          cat > .claude/settings.json << 'EOF'
          {
            "permissions": {
              "allow": [
                "Bash(git:*)",
                "Bash(gh:*)",
                "Bash(make:*)",
                "Bash(pnpm:*)",
                "Bash(nopo:*)"
              ]
            }
          }
          EOF

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          prompt: |
            The CI build failed for PR #${{ needs.check-pr.outputs.pr_number }} on branch ${{ github.event.workflow_run.head_branch }}.

            1. Analyze the project to understand the build and test process (see CLAUDE.md).
            2. Run `make check` and `make test` to reproduce the failure.
            3. Fix the issue.
            4. Verify the fix by running tests again.
            5. Push the changes to the same branch.

            This is an automated CI fix loop - focus on fixing the specific failure.
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 30"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # For human PRs: suggest fixes via review comments
  suggest-fixes:
    needs: check-pr
    if: |
      needs.check-pr.outputs.has_pr == 'true' &&
      needs.check-pr.outputs.is_claude_pr == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Create Claude settings
        run: |
          mkdir -p .claude
          cat > .claude/settings.json << 'EOF'
          {
            "permissions": {
              "allow": [
                "Bash(git:*)",
                "Bash(gh:*)",
                "Bash(make:*)",
                "Bash(pnpm:*)",
                "Bash(nopo:*)"
              ]
            }
          }
          EOF

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          prompt: |
            The CI build failed for PR #${{ needs.check-pr.outputs.pr_number }} on branch ${{ github.event.workflow_run.head_branch }}.

            This is a human-created PR, so DO NOT push any changes directly.

            Instead:
            1. Analyze the project to understand the build and test process (see CLAUDE.md).
            2. Run `make check` and `make test` to reproduce the failure.
            3. Identify the root cause of the failure.
            4. Submit a PR review with INLINE COMMENTS suggesting specific fixes.
               - Use `gh pr review` with `--comment` and include specific code suggestions
               - Point to the exact lines that need to be changed
               - Provide the corrected code in code blocks
            5. If the fix is complex, add a summary comment explaining the overall approach.

            Use the GitHub CLI to submit review comments:
            ```
            gh pr review ${{ needs.check-pr.outputs.pr_number }} --comment --body "..."
            ```

            For inline comments on specific files/lines, you can use:
            ```
            gh api repos/$GITHUB_REPOSITORY/pulls/${{ needs.check-pr.outputs.pr_number }}/comments \
              -f body="suggestion" -f path="file.ts" -f line=42 -f side="RIGHT"
            ```

            Be helpful and specific - the human author should be able to easily apply your suggestions.
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 30"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
