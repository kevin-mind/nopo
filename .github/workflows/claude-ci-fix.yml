name: Claude CI Fix

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  check-pr:
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    outputs:
      should_fix: ${{ steps.check.outputs.should_fix }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Check if Claude-created PR
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          # Find PR for this branch
          pr=$(gh pr list --repo "$GITHUB_REPOSITORY" --head "$HEAD_BRANCH" --json number,author --jq '.[0]')

          if [[ -z "$pr" ]]; then
            echo "No PR found for branch $HEAD_BRANCH"
            echo "should_fix=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          pr_number=$(echo "$pr" | jq -r '.number')
          author=$(echo "$pr" | jq -r '.author.login')

          echo "PR #$pr_number by $author"
          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT

          # Only fix PRs created by GitHub Actions (Claude automation)
          if [[ "$author" == "github-actions[bot]" || "$author" == *"claude"* ]]; then
            echo "should_fix=true" >> $GITHUB_OUTPUT
          else
            echo "Skipping - PR not created by Claude automation"
            echo "should_fix=false" >> $GITHUB_OUTPUT
          fi

  fix-build:
    needs: check-pr
    if: needs.check-pr.outputs.should_fix == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@anthropic.com"

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            The CI build failed for PR #${{ needs.check-pr.outputs.pr_number }} on branch ${{ github.event.workflow_run.head_branch }}.

            1. Analyze the project to understand the build and test process (see CLAUDE.md).
            2. Run `make check` and `make test` to reproduce the failure.
            3. Fix the issue.
            4. Verify the fix by running tests again.
            5. Push the changes to the same branch.

            This is an automated CI fix loop - focus on fixing the specific failure.
          claude_args: "--model claude-3-5-sonnet-latest --max-turns 20"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
