name: Release
'on':
  push:
    branches:
      - main
  merge_group: {}
concurrency:
  group: ${{ github.workflow }}-${{ (github.event_name == 'merge_group' || github.event_name == 'push' && github.event.sender.login != 'github-merge-queue[bot]') && 'push' || 'pr' }}
  cancel-in-progress: true
permissions: {}
defaults:
  run:
    shell: bash
env:
  CI: 'true'
jobs:
  # ============================================================================
  # ISSUE EXTRACTION - Find linked issue numbers for iteration logging
  # Handles batched merge queue PRs by extracting all PR numbers
  # ============================================================================
  extract-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      # JSON arrays to support batched merge queue PRs
      issues_json: ${{ steps.extract.outputs.issues_json }}
      prs_json: ${{ steps.extract.outputs.prs_json }}
      has_issues: ${{ steps.extract.outputs.has_issues }}
    steps:
      - uses: actions/checkout@v4
      - name: Extract issue numbers
        id: extract
        env:
          GH_TOKEN: ${{ github.token }}
          EVENT_NAME: ${{ github.event_name }}
          # shellcheck: disable=SC2153 - MERGE_GROUP_HEAD_REF is intentionally uppercase
          MERGE_GROUP_HEAD_REF: ${{ github.event.merge_group.head_ref }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          issues=()
          prs=()

          if [[ "$EVENT_NAME" == "merge_group" ]]; then
            # Extract ALL PR numbers from merge queue branch
            # Format: gh-readonly-queue/main/pr-123-abc123 or batched: pr-123-abc123-pr-456-def456
            echo "Parsing merge queue head_ref: $MERGE_GROUP_HEAD_REF"

            # Use grep to find all pr-N patterns
            pr_numbers=$(echo "$MERGE_GROUP_HEAD_REF" | grep -oE 'pr-[0-9]+' | grep -oE '[0-9]+' || true)

            for pr_num in $pr_numbers; do
              echo "Processing PR #$pr_num"
              prs+=("$pr_num")

              # Get PR details to find linked issue
              pr_data=$(gh pr view "$pr_num" --json body,headRefName 2>/dev/null || echo "{}")
              if [[ "$pr_data" != "{}" ]]; then
                head_ref=$(echo "$pr_data" | jq -r '.headRefName // empty')
                body=$(echo "$pr_data" | jq -r '.body // empty')

                # Check if it's a Claude PR by branch name
                if [[ "$head_ref" =~ ^claude/issue/([0-9]+)$ ]]; then
                  issue_num="${BASH_REMATCH[1]}"
                  issues+=("$issue_num")
                  echo "  Found issue $issue_num from Claude branch"
                # Fall back to parsing PR body for "Fixes #N"
                elif [[ "$body" =~ Fixes[[:space:]]*#([0-9]+) ]]; then
                  issue_num="${BASH_REMATCH[1]}"
                  issues+=("$issue_num")
                  echo "  Found issue $issue_num from PR body"
                else
                  echo "  No linked issue found for PR #$pr_num"
                fi
              fi
            done

          elif [[ "$EVENT_NAME" == "push" ]]; then
            # For push events, check commit message for issue references
            if [[ "$COMMIT_MSG" =~ Fixes[[:space:]]*#([0-9]+) ]]; then
              issues+=("${BASH_REMATCH[1]}")
              echo "Found issue ${BASH_REMATCH[1]} from commit message"
            elif [[ "$COMMIT_MSG" =~ \#([0-9]+) ]]; then
              issues+=("${BASH_REMATCH[1]}")
              echo "Found issue ${BASH_REMATCH[1]} from commit reference"
            fi

            # Try to find the merged PR
            merged_pr=$(gh pr list --state merged --limit 1 --json number,headRefName -q '.[0]' 2>/dev/null || echo "{}")
            if [[ -n "$merged_pr" && "$merged_pr" != "{}" ]]; then
              pr_num=$(echo "$merged_pr" | jq -r '.number')
              head_ref=$(echo "$merged_pr" | jq -r '.headRefName')
              prs+=("$pr_num")

              if [[ "$head_ref" =~ ^claude/issue/([0-9]+)$ ]]; then
                # Prefer issue from branch name (more reliable)
                issues=("${BASH_REMATCH[1]}")
                echo "Found issue ${BASH_REMATCH[1]} from merged PR branch"
              fi
            fi
          fi

          # Convert arrays to JSON (compact format for GITHUB_OUTPUT)
          issues_json=$(printf '%s\n' "${issues[@]}" | jq -R . | jq -sc 'unique')
          prs_json=$(printf '%s\n' "${prs[@]}" | jq -R . | jq -sc 'unique')
          has_issues=$([[ ${#issues[@]} -gt 0 ]] && echo "true" || echo "false")

          echo "issues_json=$issues_json" >> "$GITHUB_OUTPUT"
          echo "prs_json=$prs_json" >> "$GITHUB_OUTPUT"
          echo "has_issues=$has_issues" >> "$GITHUB_OUTPUT"

          echo "Summary: issues=$issues_json, prs=$prs_json, has_issues=$has_issues"

  # ============================================================================
  # LOG: ADDED TO MERGE QUEUE (merge_group event)
  # Calls executor directly with appendHistory action
  # ============================================================================
  log-queue-entry:
    if: github.event_name == 'merge_group' && needs.extract-issue.outputs.has_issues == 'true'
    needs: extract-issue
    runs-on: ubuntu-latest
    permissions:
      issues: write
    strategy:
      matrix:
        issue: ${{ fromJson(needs.extract-issue.outputs.issues_json) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Log queue entry (issue #${{ matrix.issue }})
        uses: ./.github/actions-ts/claude-state-executor
        with:
          github_code_token: ${{ secrets.NOPO_BOT_PAT }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}
          actions_json: |
            [{
              "type": "appendHistory",
              "issueNumber": ${{ matrix.issue }},
              "iteration": 0,
              "phase": "-",
              "message": "‚è≥ Merge queue",
              "runLink": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }]

  # ============================================================================
  # LOG: MERGED TO MAIN (push event - covers both merge queue and direct merges)
  # Calls executor directly with updateHistory action
  # ============================================================================
  log-merged:
    if: github.event_name == 'push' && needs.extract-issue.outputs.has_issues == 'true'
    needs: extract-issue
    runs-on: ubuntu-latest
    permissions:
      issues: write
    strategy:
      matrix:
        issue: ${{ fromJson(needs.extract-issue.outputs.issues_json) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Log merged (issue #${{ matrix.issue }})
        uses: ./.github/actions-ts/claude-state-executor
        with:
          github_code_token: ${{ secrets.NOPO_BOT_PAT }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}
          actions_json: |
            [{
              "type": "updateHistory",
              "issueNumber": ${{ matrix.issue }},
              "matchIteration": 0,
              "matchPhase": "-",
              "matchPattern": "‚è≥ Merge queue",
              "newMessage": "üö¢ Merge queue",
              "commitSha": "${{ github.sha }}",
              "runLink": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }]

  context:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      push: ${{ steps.push_deploy.outputs.push }}
      deploy: ${{ steps.push_deploy.outputs.deploy }}
    steps:
      - id: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: setup_node
        uses: ./.github/actions/setup-node
      - id: context
        name: Context
        uses: ./.github/actions/context
      - id: push_deploy
        name: Push / Deploy
        env:
          event_name: ${{ github.event_name }}
          actor: ${{ github.event.sender.login }}
          merge_actor: github-merge-queue[bot]
        run: |-
          push=false
          deploy=false

          # Push images on merge queue. This only runs on the target repo
          # so no need to check if it is a fork.
          if [[ "$event_name" == "merge_group" ]]; then
            push=true
            deploy=true
          # Push images on push events that were not sent by the merge queue bot
          # as merge queue commits are deployed before the PR is merged.
          elif [[ "$event_name" == "push" && "$actor" != "$merge_actor" ]]; then
            push=true
            deploy=true
          fi

          echo "event_name=$event_name"
          echo "push=$push" >> $GITHUB_OUTPUT
          echo "deploy=$deploy" >> $GITHUB_OUTPUT
          cat "$GITHUB_OUTPUT"
  discover_buildable:
    permissions:
      contents: read
    uses: ./.github/workflows/_services.yml
    with:
      filter: buildable
      ref: ${{ github.sha }}
  version:
    if: ${{ github.event_name == 'push' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
      pull-requests: write
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: setup_node
        uses: ./.github/actions/setup-node
      - id: setup_nopo
        uses: ./.github/actions/setup-nopo
      - id: build
        name: Build packages
        run: nopo compile packages root
      - id: publish_versions
        name: Create and publish versions
        uses: changesets/action@v1
        with:
          commit: 'chore: update versions'
          title: 'chore: update versions'
          publish: nopo publish root
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    needs:
      - context
  build:
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    uses: ./.github/workflows/_build.yml
    secrets: inherit
    with:
      push: ${{ needs.context.outputs.push == 'true' }}
      services: ${{ needs.discover_buildable.outputs.services }}
      # Multi-platform for production deployments
      platforms: linux/amd64,linux/arm64
      driver: docker-container
    needs:
      - context
      - discover_buildable
  test:
    permissions:
      contents: read
      packages: read
    uses: ./.github/workflows/_test.yml
    secrets: inherit
    with:
      tag: ${{ needs.build.outputs.tag }}
      services: ${{ needs.discover_buildable.outputs.services_json }}
    needs:
      - build
      - context
      - discover_buildable
  deploy_stage:
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    uses: ./.github/workflows/_deploy_gcp.yml
    secrets: inherit
    with:
      environment: stage
      version: ${{ needs.build.outputs.version }}
      digest: ${{ needs.build.outputs.digest }}
      services: ${{ needs.discover_buildable.outputs.services_json }}
    needs:
      - context
      - build
      - test
      - discover_buildable
  deploy_prod:
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    uses: ./.github/workflows/_deploy_gcp.yml
    secrets: inherit
    with:
      environment: prod
      version: ${{ needs.build.outputs.version }}
      digest: ${{ needs.build.outputs.digest }}
      services: ${{ needs.discover_buildable.outputs.services_json }}
    needs:
      - context
      - build
      - deploy_stage
      - test
      - discover_buildable

  # ============================================================================
  # LOG: DEPLOYED TO STAGE
  # Calls executor directly with appendHistory action
  # ============================================================================
  log-stage-deployed:
    if: always() && needs.deploy_stage.result == 'success' && needs.extract-issue.outputs.has_issues == 'true'
    needs:
      - extract-issue
      - deploy_stage
    runs-on: ubuntu-latest
    permissions:
      issues: write
    strategy:
      matrix:
        issue: ${{ fromJson(needs.extract-issue.outputs.issues_json) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Log stage deploy (issue #${{ matrix.issue }})
        uses: ./.github/actions-ts/claude-state-executor
        with:
          github_code_token: ${{ secrets.NOPO_BOT_PAT }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}
          actions_json: |
            [{
              "type": "appendHistory",
              "issueNumber": ${{ matrix.issue }},
              "iteration": 0,
              "phase": "-",
              "message": "üß™ Deployed to stage",
              "commitSha": "${{ github.sha }}",
              "runLink": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }]

  # ============================================================================
  # LOG: RELEASED TO PRODUCTION
  # Calls executor directly with appendHistory action
  # ============================================================================
  log-released:
    if: always() && needs.deploy_prod.result == 'success' && needs.extract-issue.outputs.has_issues == 'true'
    needs:
      - extract-issue
      - deploy_prod
    runs-on: ubuntu-latest
    permissions:
      issues: write
    strategy:
      matrix:
        issue: ${{ fromJson(needs.extract-issue.outputs.issues_json) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Log production release (issue #${{ matrix.issue }})
        uses: ./.github/actions-ts/claude-state-executor
        with:
          github_code_token: ${{ secrets.NOPO_BOT_PAT }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}
          actions_json: |
            [{
              "type": "appendHistory",
              "issueNumber": ${{ matrix.issue }},
              "iteration": 0,
              "phase": "-",
              "message": "üö¢ Released to production",
              "commitSha": "${{ github.sha }}",
              "runLink": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }]

  # ============================================================================
  # LOG: REMOVED FROM QUEUE (merge_group failure or cancellation)
  # Calls executor directly with updateHistory action
  # ============================================================================
  log-queue-failure:
    if: >-
      always() &&
      github.event_name == 'merge_group' &&
      needs.extract-issue.outputs.has_issues == 'true' &&
      (needs.build.result != 'success' || needs.test.result != 'success' || needs.deploy_stage.result != 'success' || needs.deploy_prod.result != 'success')
    needs:
      - extract-issue
      - build
      - test
      - deploy_stage
      - deploy_prod
    runs-on: ubuntu-latest
    permissions:
      issues: write
    strategy:
      matrix:
        issue: ${{ fromJson(needs.extract-issue.outputs.issues_json) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Log queue failure (issue #${{ matrix.issue }})
        uses: ./.github/actions-ts/claude-state-executor
        with:
          github_code_token: ${{ secrets.NOPO_BOT_PAT }}
          project_number: ${{ vars.PROJECT_NUMBER || '1' }}
          actions_json: |
            [{
              "type": "updateHistory",
              "issueNumber": ${{ matrix.issue }},
              "matchIteration": 0,
              "matchPhase": "-",
              "matchPattern": "‚è≥ Merge queue",
              "newMessage": "‚ùå Merge queue",
              "runLink": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }]

  checks:
    if: always()
    runs-on: ubuntu-latest
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: check
        name: Check
        uses: ./.github/actions/check
        with:
          json: ${{ toJson(needs) }}
    needs:
      - build
      - test
      - deploy_stage
      - deploy_prod
