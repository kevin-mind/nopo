name: Claude Respond

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

concurrency:
  group: claude-respond-${{ github.event.issue.number || github.event.pull_request.number }}-${{ github.event.comment.id }}
  cancel-in-progress: false

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: write
  id-token: write

jobs:
  # Check if this is a review request or @claude mention
  check-review-request:
    runs-on: ubuntu-latest
    if: |
      (contains(github.event.comment.body, '@claude') || contains(github.event.comment.body, '/review')) &&
      github.event.comment.user.type != 'Bot'
    outputs:
      is_review_request: ${{ steps.check.outputs.is_review }}
      is_pr: ${{ steps.check.outputs.is_pr }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Check comment type
        id: check
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # Check if this is a PR (issue_comment on a PR has pull_request in the issue object)
          if [[ "${{ github.event.issue.pull_request }}" != "" ]]; then
            echo "is_pr=true" >> $GITHUB_OUTPUT
            echo "pr_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            echo "is_pr=false" >> $GITHUB_OUTPUT
          fi

          # Check if comment contains /review command
          if echo "$COMMENT_BODY" | grep -E '(^|\s)/review(\s|$)' > /dev/null; then
            echo "is_review=true" >> $GITHUB_OUTPUT
          else
            echo "is_review=false" >> $GITHUB_OUTPUT
          fi

  # Trigger formal review workflow for "/review" on PRs
  trigger-review:
    needs: check-review-request
    if: |
      needs.check-review-request.outputs.is_review_request == 'true' &&
      needs.check-review-request.outputs.is_pr == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger review workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.check-review-request.outputs.pr_number }}
        run: |
          gh workflow run claude-review.yml -f pr_number="$PR_NUMBER" --repo "$GITHUB_REPOSITORY"
          echo "Triggered Claude review for PR #$PR_NUMBER"

          # Add a reaction to acknowledge
          gh api "/repos/$GITHUB_REPOSITORY/issues/comments/${{ github.event.comment.id }}/reactions" \
            -f content="+1" || true

  # General response for other @claude mentions
  respond:
    needs: check-review-request
    if: |
      needs.check-review-request.outputs.is_review_request != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check Claude comment count
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
        run: |
          # Count comments from claude[bot] on this issue/PR
          comments=$(gh api "/repos/$GITHUB_REPOSITORY/issues/$ISSUE_NUMBER/comments" --jq '[.[] | select(.user.login == "claude[bot]")] | length')

          echo "Claude has made $comments comments on issue #$ISSUE_NUMBER"

          if [[ "$comments" -gt 20 ]]; then
            echo "::error::Claude has made over 20 comments on this issue. Stopping to prevent spam."
            exit 1
          fi

      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          trigger_phrase: "@claude"
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 50"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
