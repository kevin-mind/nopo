name: Claude Respond

on:
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  respond:
    # Only run if comment mentions @claude-respond (response to a call)
    if: contains(github.event.comment.body, '@claude-respond')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@anthropic.com"

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Someone is RESPONDING to your previous review comment with @claude-respond.

            This is a reply to something you previously said. Understand their response:

            ## If they're ANSWERING your question:
            - Is the answer satisfying? Does it fully address your question?
            - If YES: Resolve the comment thread
            - If NO: Ask follow-up questions requesting more detail or clarification

            ## If they're RESPONDING to your change request:
            - Did they make the changes? (look for commit references)
              - If YES: Resolve the comment thread
            - Are they pushing back on your suggestion?
              - Evaluate their reasoning objectively
              - Could there be valid reasons NOT to make the change?
              - If their pushback is reasonable: Accept it gracefully and resolve the thread
              - If their pushback is not convincing: Reply with more compelling arguments, but stay collaborative

            ## If they made a commit with changes:
            - Review the commit to verify it addresses your feedback
            - If satisfied: Resolve the thread
            - If not quite right: Provide specific follow-up feedback

            IMPORTANT:
            - Be collaborative, not stubborn
            - Accept reasonable pushback gracefully
            - If you need to initiate a NEW review comment, tell them to use @claude-review instead
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 15"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
