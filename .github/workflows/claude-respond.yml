name: Claude Respond

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

concurrency:
  group: claude-respond-${{ github.event.issue.number || github.event.pull_request.number }}-${{ github.event.comment.id }}
  cancel-in-progress: false

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: write
  id-token: write

jobs:
  # Check if this is a special command or @claude mention
  check-command:
    runs-on: ubuntu-latest
    if: |
      (contains(github.event.comment.body, '@claude') ||
       contains(github.event.comment.body, '/review') ||
       contains(github.event.comment.body, '/implement')) &&
      github.event.comment.user.type != 'Bot'
    outputs:
      is_review: ${{ steps.check.outputs.is_review }}
      is_implement: ${{ steps.check.outputs.is_implement }}
      is_pr: ${{ steps.check.outputs.is_pr }}
      number: ${{ steps.check.outputs.number }}
    steps:
      - name: Check comment type
        id: check
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # Check if this is a PR (issue_comment on a PR has pull_request in the issue object)
          if [[ "${{ github.event.issue.pull_request }}" != "" ]]; then
            echo "is_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_pr=false" >> $GITHUB_OUTPUT
          fi
          echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT

          # Check for /review command
          if echo "$COMMENT_BODY" | grep -E '(^|\s)/review(\s|$)' > /dev/null; then
            echo "is_review=true" >> $GITHUB_OUTPUT
          else
            echo "is_review=false" >> $GITHUB_OUTPUT
          fi

          # Check for /implement command
          if echo "$COMMENT_BODY" | grep -E '(^|\s)/implement(\s|$)' > /dev/null; then
            echo "is_implement=true" >> $GITHUB_OUTPUT
          else
            echo "is_implement=false" >> $GITHUB_OUTPUT
          fi

  # Trigger review workflow for "/review" on PRs
  trigger-review:
    needs: check-command
    if: |
      needs.check-command.outputs.is_review == 'true' &&
      needs.check-command.outputs.is_pr == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger review workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ needs.check-command.outputs.number }}
        run: |
          gh workflow run claude-review.yml -f pr_number="$PR_NUMBER" --repo "$GITHUB_REPOSITORY"
          echo "Triggered Claude review for PR #$PR_NUMBER"

          # Add a reaction to acknowledge
          gh api "/repos/$GITHUB_REPOSITORY/issues/comments/${{ github.event.comment.id }}/reactions" \
            -f content="+1" || true

  # Trigger implement workflow for "/implement" on issues
  trigger-implement:
    needs: check-command
    if: |
      needs.check-command.outputs.is_implement == 'true' &&
      needs.check-command.outputs.is_pr == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger implement workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.check-command.outputs.number }}
        run: |
          gh workflow run claude-implement.yml -f issue_number="$ISSUE_NUMBER" --repo "$GITHUB_REPOSITORY"
          echo "Triggered Claude implementation for issue #$ISSUE_NUMBER"

          # Add a reaction to acknowledge
          gh api "/repos/$GITHUB_REPOSITORY/issues/comments/${{ github.event.comment.id }}/reactions" \
            -f content="+1" || true

  # General response for other @claude mentions
  respond:
    needs: check-command
    if: |
      needs.check-command.outputs.is_review != 'true' &&
      needs.check-command.outputs.is_implement != 'true' &&
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    steps:
      - name: Check Claude comment count
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
        run: |
          # Count comments from claude[bot] on this issue/PR
          comments=$(gh api "/repos/$GITHUB_REPOSITORY/issues/$ISSUE_NUMBER/comments" --jq '[.[] | select(.user.login == "claude[bot]")] | length')

          echo "Claude has made $comments comments on issue #$ISSUE_NUMBER"

          if [[ "$comments" -gt 20 ]]; then
            echo "::error::Claude has made over 20 comments on this issue. Stopping to prevent spam."
            exit 1
          fi

      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          trigger_phrase: "@claude"
          prompt: |
            IMPORTANT: You are responding to a question or request in a GitHub issue/PR comment.

            DO NOT implement code changes or make commits unless the user EXPLICITLY asks you to.

            If the user wants implementation, they should use the `/implement` command on an issue.
            If the user wants a code review, they should use the `/review` command on a PR.

            Focus on:
            - Answering questions
            - Providing explanations
            - Clarifying requirements
            - Suggesting approaches (without implementing)
            - Analyzing code or issues
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 50"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
