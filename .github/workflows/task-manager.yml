name: Task Manager
run-name: Task Manager - ${{ github.event_name == 'schedule' && 'Scheduled' || 'Manual' }}

on:
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no assignments)'
        type: boolean
        default: false
      monthly_budget:
        description: 'Monthly token budget (input + output tokens)'
        type: number
        default: 50000000
      daily_budget:
        description: 'Daily token budget (input + output tokens)'
        type: number
        default: 5000000

permissions:
  contents: read
  issues: write
  actions: read

defaults:
  run:
    shell: bash

# Only one task manager instance at a time
concurrency:
  group: task-manager
  cancel-in-progress: false

jobs:
  manage-queue:
    runs-on: ubuntu-latest
    outputs:
      monthly_usage: ${{ steps.budget.outputs.monthly_usage }}
      daily_usage: ${{ steps.budget.outputs.daily_usage }}
      monthly_budget: ${{ steps.budget.outputs.monthly_budget }}
      daily_budget: ${{ steps.budget.outputs.daily_budget }}
      under_budget: ${{ steps.budget.outputs.under_budget }}
      assigned_issue: ${{ steps.assign.outputs.issue_number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Claude Code usage from Anthropic API
        id: budget
        env:
          ANTHROPIC_ADMIN_API_KEY: ${{ secrets.ANTHROPIC_ADMIN_API_KEY }}
          MONTHLY_BUDGET: ${{ inputs.monthly_budget || 50000000 }}
          DAILY_BUDGET: ${{ inputs.daily_budget || 5000000 }}
        run: |
          echo "::group::Budget Configuration"
          echo "Monthly budget: $MONTHLY_BUDGET tokens"
          echo "Daily budget: $DAILY_BUDGET tokens"
          echo "::endgroup::"

          # Check if API key is available
          if [[ -z "$ANTHROPIC_ADMIN_API_KEY" ]]; then
            echo "::error::ANTHROPIC_ADMIN_API_KEY secret is not set"
            echo "Please add the Admin API key from https://console.anthropic.com/"
            exit 1
          fi

          # Calculate date range
          today=$(date -u +%Y-%m-%d)
          month_start=$(date -u +%Y-%m-01)

          echo "::group::Date Range"
          echo "Today: $today"
          echo "Month start: $month_start"
          echo "::endgroup::"

          # Function to fetch usage for a specific date
          fetch_usage() {
            local date=$1
            curl -s "https://api.anthropic.com/v1/organizations/usage_report/claude_code?starting_at=${date}&limit=1000" \
              -H "X-Api-Key: $ANTHROPIC_ADMIN_API_KEY" \
              -H "anthropic-version: 2023-06-01"
          }

          # Function to sum tokens from API response
          sum_tokens() {
            local response=$1
            echo "$response" | jq '
              [.data[]?.model_breakdown[]? |
                (.tokens.input // 0) + (.tokens.output // 0)
              ] | add // 0
            '
          }

          # Fetch today's usage
          echo "::group::Fetching Today's Usage"
          today_response=$(fetch_usage "$today")

          if echo "$today_response" | jq -e '.error' > /dev/null 2>&1; then
            error_msg=$(echo "$today_response" | jq -r '.error.message // .error // "Unknown error"')
            echo "::error::API error: $error_msg"
            exit 1
          fi

          daily_usage=$(sum_tokens "$today_response")
          echo "Today's usage: $daily_usage tokens"
          echo "::endgroup::"

          # Fetch monthly usage (iterate through each day)
          echo "::group::Fetching Monthly Usage"
          monthly_usage=0
          current_date="$month_start"

          while [[ "$current_date" < "$today" || "$current_date" == "$today" ]]; do
            echo "Fetching usage for $current_date..."
            day_response=$(fetch_usage "$current_date")

            if echo "$day_response" | jq -e '.error' > /dev/null 2>&1; then
              echo "Warning: Could not fetch data for $current_date"
            else
              day_tokens=$(sum_tokens "$day_response")
              monthly_usage=$((monthly_usage + day_tokens))
              echo "  $current_date: $day_tokens tokens (cumulative: $monthly_usage)"
            fi

            # Increment date
            current_date=$(date -u -d "$current_date + 1 day" +%Y-%m-%d)
          done

          echo "Total monthly usage: $monthly_usage tokens"
          echo "::endgroup::"

          # Calculate percentages
          monthly_pct=$(echo "scale=2; $monthly_usage * 100 / $MONTHLY_BUDGET" | bc)
          daily_pct=$(echo "scale=2; $daily_usage * 100 / $DAILY_BUDGET" | bc)

          echo "::group::Usage Summary"
          echo "Monthly: $monthly_usage / $MONTHLY_BUDGET tokens (${monthly_pct}%)"
          echo "Daily: $daily_usage / $DAILY_BUDGET tokens (${daily_pct}%)"
          echo "::endgroup::"

          # Determine if under budget
          if [[ $monthly_usage -lt $MONTHLY_BUDGET && $daily_usage -lt $DAILY_BUDGET ]]; then
            under_budget="true"
            echo "::notice::Under budget - eligible to assign new work"
          else
            under_budget="false"
            if [[ $monthly_usage -ge $MONTHLY_BUDGET ]]; then
              echo "::warning::Monthly budget exceeded ($monthly_usage >= $MONTHLY_BUDGET)"
            fi
            if [[ $daily_usage -ge $DAILY_BUDGET ]]; then
              echo "::warning::Daily budget exceeded ($daily_usage >= $DAILY_BUDGET)"
            fi
          fi

          # Set outputs
          echo "monthly_usage=$monthly_usage" >> $GITHUB_OUTPUT
          echo "daily_usage=$daily_usage" >> $GITHUB_OUTPUT
          echo "monthly_budget=$MONTHLY_BUDGET" >> $GITHUB_OUTPUT
          echo "daily_budget=$DAILY_BUDGET" >> $GITHUB_OUTPUT
          echo "under_budget=$under_budget" >> $GITHUB_OUTPUT

          # Save detailed data for artifacts
          echo "$today_response" > /tmp/today-usage.json

          cat > /tmp/budget-data.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "monthly": {
              "usage": $monthly_usage,
              "budget": $MONTHLY_BUDGET,
              "percentage": $monthly_pct
            },
            "daily": {
              "usage": $daily_usage,
              "budget": $DAILY_BUDGET,
              "percentage": $daily_pct
            },
            "under_budget": $under_budget
          }
          EOF

      - name: Find ready unassigned issue
        id: find_issue
        if: steps.budget.outputs.under_budget == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Searching for Ready issues"

          repo_name="${GITHUB_REPOSITORY#*/}"
          owner="${GITHUB_REPOSITORY%/*}"

          # Query issues with project status via GraphQL
          result=$(gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                issues(first: 50, states: OPEN, orderBy: {field: CREATED_AT, direction: ASC}) {
                  nodes {
                    number
                    title
                    assignees(first: 1) { totalCount }
                    labels(first: 10) {
                      nodes { name }
                    }
                    projectItems(first: 5) {
                      nodes {
                        fieldValueByName(name: "Status") {
                          ... on ProjectV2ItemFieldSingleSelectValue { name }
                        }
                      }
                    }
                  }
                }
              }
            }
          ' -f owner="$owner" -f repo="$repo_name")

          # Find first unassigned issue with Status == "Ready"
          issue=$(echo "$result" | jq -c '
            [.data.repository.issues.nodes[] |
             select(.assignees.totalCount == 0) |
             select(.projectItems.nodes | any(.fieldValueByName.name == "Ready")) |
             {number: .number, title: .title}
            ] | first // null
          ')

          if [[ -n "$issue" && "$issue" != "null" ]]; then
            issue_number=$(echo "$issue" | jq -r '.number')
            issue_title=$(echo "$issue" | jq -r '.title')
            echo "Found Ready issue: #$issue_number - $issue_title"
            echo "issue_number=$issue_number" >> $GITHUB_OUTPUT
            echo "issue_title=$issue_title" >> $GITHUB_OUTPUT
          else
            echo "No Ready unassigned issues found"
            echo "issue_number=" >> $GITHUB_OUTPUT
          fi

          echo "::endgroup::"

      - name: Assign nopo-bot to issue
        id: assign
        if: steps.find_issue.outputs.issue_number != '' && inputs.dry_run != true
        env:
          # Use PAT_TOKEN to trigger the Claude workflow
          # GITHUB_TOKEN actions don't trigger new workflows
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          ISSUE_NUMBER: ${{ steps.find_issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.find_issue.outputs.issue_title }}
        run: |
          echo "::group::Assigning nopo-bot to issue #$ISSUE_NUMBER"

          gh issue edit "$ISSUE_NUMBER" --add-assignee "nopo-bot" --repo "$GITHUB_REPOSITORY"

          echo "::notice::Assigned nopo-bot to issue #$ISSUE_NUMBER: $ISSUE_TITLE"
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          echo "::endgroup::"

      - name: Dry run - would assign
        if: steps.find_issue.outputs.issue_number != '' && inputs.dry_run == true
        env:
          ISSUE_NUMBER: ${{ steps.find_issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.find_issue.outputs.issue_title }}
        run: |
          echo "::notice::[DRY RUN] Would assign nopo-bot to issue #$ISSUE_NUMBER: $ISSUE_TITLE"

      - name: Generate burn down chart
        id: chart
        run: |
          # Generate an SVG burn down chart
          monthly_usage=${{ steps.budget.outputs.monthly_usage }}
          monthly_budget=${{ steps.budget.outputs.monthly_budget }}
          daily_usage=${{ steps.budget.outputs.daily_usage }}
          daily_budget=${{ steps.budget.outputs.daily_budget }}

          # Handle empty values
          monthly_usage=${monthly_usage:-0}
          daily_usage=${daily_usage:-0}

          # Calculate percentages
          monthly_pct=$(echo "scale=2; $monthly_usage * 100 / $monthly_budget" | bc)
          daily_pct=$(echo "scale=2; $daily_usage * 100 / $daily_budget" | bc)

          # Clamp to 100%
          monthly_bar=$(echo "scale=0; if ($monthly_pct > 100) 100 else $monthly_pct / 1" | bc)
          daily_bar=$(echo "scale=0; if ($daily_pct > 100) 100 else $daily_pct / 1" | bc)

          # Calculate bar widths (max 300px)
          monthly_width=$((monthly_bar * 3))
          daily_width=$((daily_bar * 3))

          # Determine bar colors
          if [[ $monthly_bar -lt 50 ]]; then
            monthly_color="#22c55e"  # green
          elif [[ $monthly_bar -lt 80 ]]; then
            monthly_color="#f59e0b"  # amber
          else
            monthly_color="#ef4444"  # red
          fi

          if [[ $daily_bar -lt 50 ]]; then
            daily_color="#22c55e"  # green
          elif [[ $daily_bar -lt 80 ]]; then
            daily_color="#f59e0b"  # amber
          else
            daily_color="#ef4444"  # red
          fi

          # Format numbers with commas
          format_number() {
            echo "$1" | sed ':a;s/\B[0-9]\{3\}\>$/,&/;ta'
          }

          monthly_usage_fmt=$(format_number $monthly_usage)
          monthly_budget_fmt=$(format_number $monthly_budget)
          daily_usage_fmt=$(format_number $daily_usage)
          daily_budget_fmt=$(format_number $daily_budget)

          # Generate SVG
          cat > /tmp/burn-down-chart.svg << EOF
          <svg xmlns="http://www.w3.org/2000/svg" width="400" height="200" viewBox="0 0 400 200">
            <style>
              text { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
              .title { font-size: 16px; font-weight: bold; fill: #1f2937; }
              .label { font-size: 12px; fill: #6b7280; }
              .value { font-size: 11px; fill: #374151; }
              .timestamp { font-size: 10px; fill: #9ca3af; }
            </style>

            <!-- Background -->
            <rect width="400" height="200" fill="#f9fafb" rx="8"/>

            <!-- Title -->
            <text x="20" y="30" class="title">Claude Code Token Usage</text>
            <text x="20" y="48" class="timestamp">Generated: $(date -u +"%Y-%m-%d %H:%M UTC")</text>

            <!-- Monthly Budget -->
            <text x="20" y="80" class="label">Monthly Budget</text>
            <rect x="20" y="88" width="300" height="20" fill="#e5e7eb" rx="4"/>
            <rect x="20" y="88" width="$monthly_width" height="20" fill="$monthly_color" rx="4"/>
            <text x="330" y="102" class="value">${monthly_pct}%</text>
            <text x="20" y="120" class="value">${monthly_usage_fmt} / ${monthly_budget_fmt} tokens</text>

            <!-- Daily Budget -->
            <text x="20" y="145" class="label">Daily Budget</text>
            <rect x="20" y="153" width="300" height="20" fill="#e5e7eb" rx="4"/>
            <rect x="20" y="153" width="$daily_width" height="20" fill="$daily_color" rx="4"/>
            <text x="330" y="167" class="value">${daily_pct}%</text>
            <text x="20" y="185" class="value">${daily_usage_fmt} / ${daily_budget_fmt} tokens</text>
          </svg>
          EOF

          echo "Chart generated at /tmp/burn-down-chart.svg"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: task-manager-data
          path: |
            /tmp/budget-data.json
            /tmp/today-usage.json
            /tmp/burn-down-chart.svg
          retention-days: 30

      - name: Summary
        env:
          MONTHLY_USAGE: ${{ steps.budget.outputs.monthly_usage }}
          MONTHLY_BUDGET: ${{ steps.budget.outputs.monthly_budget }}
          DAILY_USAGE: ${{ steps.budget.outputs.daily_usage }}
          DAILY_BUDGET: ${{ steps.budget.outputs.daily_budget }}
          UNDER_BUDGET: ${{ steps.budget.outputs.under_budget }}
          ASSIGNED_ISSUE: ${{ steps.assign.outputs.issue_number }}
          FOUND_ISSUE: ${{ steps.find_issue.outputs.issue_number }}
          FOUND_TITLE: ${{ steps.find_issue.outputs.issue_title }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          # Handle empty values
          MONTHLY_USAGE=${MONTHLY_USAGE:-0}
          DAILY_USAGE=${DAILY_USAGE:-0}

          # Calculate percentages
          monthly_pct=$(echo "scale=1; $MONTHLY_USAGE * 100 / $MONTHLY_BUDGET" | bc)
          daily_pct=$(echo "scale=1; $DAILY_USAGE * 100 / $DAILY_BUDGET" | bc)

          # Determine status emoji
          if [[ "$UNDER_BUDGET" == "true" ]]; then
            status_emoji=":white_check_mark:"
            status_text="Under budget"
          else
            status_emoji=":warning:"
            status_text="Over budget"
          fi

          # Write summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Task Manager Summary

          ### Budget Status: $status_emoji $status_text

          | Metric | Usage | Budget | Percentage |
          |--------|-------|--------|------------|
          | Monthly | $(printf "%'d" $MONTHLY_USAGE) tokens | $(printf "%'d" $MONTHLY_BUDGET) tokens | ${monthly_pct}% |
          | Daily | $(printf "%'d" $DAILY_USAGE) tokens | $(printf "%'d" $DAILY_BUDGET) tokens | ${daily_pct}% |

          > Data source: [Anthropic Claude Code Usage API](https://platform.claude.com/docs/en/api/admin/usage_report/retrieve_claude_code)

          EOF

          if [[ -n "$FOUND_ISSUE" ]]; then
            if [[ "$DRY_RUN" == "true" ]]; then
              cat >> $GITHUB_STEP_SUMMARY << EOF
          ### :eyes: Dry Run

          Would have assigned **nopo-bot** to issue [#$FOUND_ISSUE](${{ github.server_url }}/${{ github.repository }}/issues/$FOUND_ISSUE): $FOUND_TITLE

          EOF
            elif [[ -n "$ASSIGNED_ISSUE" ]]; then
              cat >> $GITHUB_STEP_SUMMARY << EOF
          ### :robot: Assignment

          Assigned **nopo-bot** to issue [#$ASSIGNED_ISSUE](${{ github.server_url }}/${{ github.repository }}/issues/$ASSIGNED_ISSUE): $FOUND_TITLE

          EOF
            fi
          elif [[ "$UNDER_BUDGET" == "true" ]]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ### :inbox_tray: Queue Empty

          No unassigned issues with "Ready" status found.

          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ### :pause_button: Paused

          Over budget - not assigning new work.

          EOF
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ---

          :bar_chart: [Download burn down chart](artifacts)

          EOF
