name: Task Manager
run-name: Task Manager - ${{ github.event_name == 'schedule' && 'Scheduled' || 'Manual' }}

on:
  schedule:
    # Run every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no assignments)'
        type: boolean
        default: false
      five_hour_limit:
        description: 'Five-hour utilization limit (%)'
        type: number
        default: 80
      seven_day_limit:
        description: 'Seven-day utilization limit (%)'
        type: number
        default: 80

permissions:
  contents: read
  issues: write
  actions: read

defaults:
  run:
    shell: bash

# Only one task manager instance at a time
concurrency:
  group: task-manager
  cancel-in-progress: false

jobs:
  manage-queue:
    runs-on: ubuntu-latest
    outputs:
      five_hour_usage: ${{ steps.usage.outputs.five_hour_usage }}
      seven_day_usage: ${{ steps.usage.outputs.seven_day_usage }}
      under_limit: ${{ steps.usage.outputs.under_limit }}
      assigned_issue: ${{ steps.assign.outputs.issue_number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Claude Code usage from OAuth API
        id: usage
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          FIVE_HOUR_LIMIT: ${{ inputs.five_hour_limit || 80 }}
          SEVEN_DAY_LIMIT: ${{ inputs.seven_day_limit || 80 }}
        run: |
          echo "::group::Usage Limits Configuration"
          echo "Five-hour limit: ${FIVE_HOUR_LIMIT}%"
          echo "Seven-day limit: ${SEVEN_DAY_LIMIT}%"
          echo "::endgroup::"

          # Check if OAuth token is available
          if [[ -z "$CLAUDE_CODE_OAUTH_TOKEN" ]]; then
            echo "::error::CLAUDE_CODE_OAUTH_TOKEN secret is not set"
            exit 1
          fi

          # Fetch usage from OAuth API
          echo "::group::Fetching Usage Data"
          response=$(curl -s "https://api.anthropic.com/api/oauth/usage" \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $CLAUDE_CODE_OAUTH_TOKEN" \
            -H "anthropic-beta: oauth-2025-04-20")

          # Check for errors
          if echo "$response" | jq -e '.error' > /dev/null 2>&1; then
            error_msg=$(echo "$response" | jq -r '.error.message // .error // "Unknown error"')
            echo "::error::API error: $error_msg"
            echo "Response: $response"
            exit 1
          fi

          echo "Raw response:"
          echo "$response" | jq .
          echo "::endgroup::"

          # Extract usage percentages (multiply by 100 to get percentage)
          five_hour_raw=$(echo "$response" | jq -r '.five_hour.utilization // 0')
          seven_day_raw=$(echo "$response" | jq -r '.seven_day.utilization // 0')
          seven_day_opus_raw=$(echo "$response" | jq -r '.seven_day_opus.utilization // 0')

          # Convert to percentage (API returns 0-1 range)
          five_hour_pct=$(echo "scale=1; $five_hour_raw * 100" | bc)
          seven_day_pct=$(echo "scale=1; $seven_day_raw * 100" | bc)
          seven_day_opus_pct=$(echo "scale=1; $seven_day_opus_raw * 100" | bc)

          # Get reset times
          five_hour_reset=$(echo "$response" | jq -r '.five_hour.resets_at // "N/A"')
          seven_day_reset=$(echo "$response" | jq -r '.seven_day.resets_at // "N/A"')

          echo "::group::Usage Summary"
          echo "Five-hour usage: ${five_hour_pct}% (resets: $five_hour_reset)"
          echo "Seven-day usage: ${seven_day_pct}% (resets: $seven_day_reset)"
          echo "Seven-day Opus: ${seven_day_opus_pct}%"
          echo "::endgroup::"

          # Determine if under limit (compare integers to avoid bc issues)
          five_hour_int=${five_hour_pct%.*}
          seven_day_int=${seven_day_pct%.*}
          five_hour_int=${five_hour_int:-0}
          seven_day_int=${seven_day_int:-0}

          if [[ $five_hour_int -lt $FIVE_HOUR_LIMIT && $seven_day_int -lt $SEVEN_DAY_LIMIT ]]; then
            under_limit="true"
            echo "::notice::Under usage limits - eligible to assign new work"
          else
            under_limit="false"
            if [[ $five_hour_int -ge $FIVE_HOUR_LIMIT ]]; then
              echo "::warning::Five-hour limit reached (${five_hour_pct}% >= ${FIVE_HOUR_LIMIT}%)"
            fi
            if [[ $seven_day_int -ge $SEVEN_DAY_LIMIT ]]; then
              echo "::warning::Seven-day limit reached (${seven_day_pct}% >= ${SEVEN_DAY_LIMIT}%)"
            fi
          fi

          # Set outputs
          echo "five_hour_usage=$five_hour_pct" >> $GITHUB_OUTPUT
          echo "seven_day_usage=$seven_day_pct" >> $GITHUB_OUTPUT
          echo "seven_day_opus_usage=$seven_day_opus_pct" >> $GITHUB_OUTPUT
          echo "five_hour_reset=$five_hour_reset" >> $GITHUB_OUTPUT
          echo "seven_day_reset=$seven_day_reset" >> $GITHUB_OUTPUT
          echo "under_limit=$under_limit" >> $GITHUB_OUTPUT

          # Save response for artifacts
          echo "$response" > /tmp/usage-response.json

      - name: Find ready unassigned issue
        id: find_issue
        if: steps.usage.outputs.under_limit == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Searching for Ready issues"

          repo_name="${GITHUB_REPOSITORY#*/}"
          owner="${GITHUB_REPOSITORY%/*}"

          # Query issues with project status via GraphQL
          result=$(gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                issues(first: 50, states: OPEN, orderBy: {field: CREATED_AT, direction: ASC}) {
                  nodes {
                    number
                    title
                    assignees(first: 1) { totalCount }
                    labels(first: 10) {
                      nodes { name }
                    }
                    projectItems(first: 5) {
                      nodes {
                        fieldValueByName(name: "Status") {
                          ... on ProjectV2ItemFieldSingleSelectValue { name }
                        }
                      }
                    }
                  }
                }
              }
            }
          ' -f owner="$owner" -f repo="$repo_name")

          # Find first unassigned issue with Status == "Ready"
          issue=$(echo "$result" | jq -c '
            [.data.repository.issues.nodes[] |
             select(.assignees.totalCount == 0) |
             select(.projectItems.nodes | any(.fieldValueByName.name == "Ready")) |
             {number: .number, title: .title}
            ] | first // null
          ')

          if [[ -n "$issue" && "$issue" != "null" ]]; then
            issue_number=$(echo "$issue" | jq -r '.number')
            issue_title=$(echo "$issue" | jq -r '.title')
            echo "Found Ready issue: #$issue_number - $issue_title"
            echo "issue_number=$issue_number" >> $GITHUB_OUTPUT
            echo "issue_title=$issue_title" >> $GITHUB_OUTPUT
          else
            echo "No Ready unassigned issues found"
            echo "issue_number=" >> $GITHUB_OUTPUT
          fi

          echo "::endgroup::"

      - name: Assign nopo-bot to issue
        id: assign
        if: steps.find_issue.outputs.issue_number != '' && inputs.dry_run != true
        env:
          # Use PAT_TOKEN to trigger the Claude workflow
          # GITHUB_TOKEN actions don't trigger new workflows
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          ISSUE_NUMBER: ${{ steps.find_issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.find_issue.outputs.issue_title }}
        run: |
          echo "::group::Assigning nopo-bot to issue #$ISSUE_NUMBER"

          gh issue edit "$ISSUE_NUMBER" --add-assignee "nopo-bot" --repo "$GITHUB_REPOSITORY"

          echo "::notice::Assigned nopo-bot to issue #$ISSUE_NUMBER: $ISSUE_TITLE"
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          echo "::endgroup::"

      - name: Dry run - would assign
        if: steps.find_issue.outputs.issue_number != '' && inputs.dry_run == true
        env:
          ISSUE_NUMBER: ${{ steps.find_issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.find_issue.outputs.issue_title }}
        run: |
          echo "::notice::[DRY RUN] Would assign nopo-bot to issue #$ISSUE_NUMBER: $ISSUE_TITLE"

      - name: Generate usage chart
        id: chart
        run: |
          five_hour=${{ steps.usage.outputs.five_hour_usage }}
          seven_day=${{ steps.usage.outputs.seven_day_usage }}
          seven_day_opus=${{ steps.usage.outputs.seven_day_opus_usage }}

          # Handle empty values
          five_hour=${five_hour:-0}
          seven_day=${seven_day:-0}
          seven_day_opus=${seven_day_opus:-0}

          # Calculate bar widths (max 300px, clamped to 100%)
          five_hour_bar=$(echo "scale=0; if ($five_hour > 100) 100 else $five_hour / 1" | bc)
          seven_day_bar=$(echo "scale=0; if ($seven_day > 100) 100 else $seven_day / 1" | bc)

          five_hour_width=$((five_hour_bar * 3))
          seven_day_width=$((seven_day_bar * 3))

          # Determine bar colors
          get_color() {
            local pct=$1
            if [[ $pct -lt 50 ]]; then
              echo "#22c55e"  # green
            elif [[ $pct -lt 80 ]]; then
              echo "#f59e0b"  # amber
            else
              echo "#ef4444"  # red
            fi
          }

          five_hour_color=$(get_color $five_hour_bar)
          seven_day_color=$(get_color $seven_day_bar)

          # Generate SVG
          cat > /tmp/usage-chart.svg << EOF
          <svg xmlns="http://www.w3.org/2000/svg" width="400" height="200" viewBox="0 0 400 200">
            <style>
              text { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
              .title { font-size: 16px; font-weight: bold; fill: #1f2937; }
              .label { font-size: 12px; fill: #6b7280; }
              .value { font-size: 11px; fill: #374151; }
              .timestamp { font-size: 10px; fill: #9ca3af; }
            </style>

            <!-- Background -->
            <rect width="400" height="200" fill="#f9fafb" rx="8"/>

            <!-- Title -->
            <text x="20" y="30" class="title">Claude Max Usage</text>
            <text x="20" y="48" class="timestamp">Generated: $(date -u +"%Y-%m-%d %H:%M UTC")</text>

            <!-- Five Hour Usage -->
            <text x="20" y="80" class="label">5-Hour Window</text>
            <rect x="20" y="88" width="300" height="20" fill="#e5e7eb" rx="4"/>
            <rect x="20" y="88" width="$five_hour_width" height="20" fill="$five_hour_color" rx="4"/>
            <text x="330" y="102" class="value">${five_hour}%</text>

            <!-- Seven Day Usage -->
            <text x="20" y="135" class="label">7-Day Window</text>
            <rect x="20" y="143" width="300" height="20" fill="#e5e7eb" rx="4"/>
            <rect x="20" y="143" width="$seven_day_width" height="20" fill="$seven_day_color" rx="4"/>
            <text x="330" y="157" class="value">${seven_day}%</text>

            <!-- Opus info -->
            <text x="20" y="185" class="timestamp">Opus 7-day: ${seven_day_opus}%</text>
          </svg>
          EOF

          echo "Chart generated at /tmp/usage-chart.svg"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: task-manager-data
          path: |
            /tmp/usage-response.json
            /tmp/usage-chart.svg
          retention-days: 30

      - name: Summary
        env:
          FIVE_HOUR: ${{ steps.usage.outputs.five_hour_usage }}
          SEVEN_DAY: ${{ steps.usage.outputs.seven_day_usage }}
          SEVEN_DAY_OPUS: ${{ steps.usage.outputs.seven_day_opus_usage }}
          FIVE_HOUR_RESET: ${{ steps.usage.outputs.five_hour_reset }}
          SEVEN_DAY_RESET: ${{ steps.usage.outputs.seven_day_reset }}
          FIVE_HOUR_LIMIT: ${{ inputs.five_hour_limit || 80 }}
          SEVEN_DAY_LIMIT: ${{ inputs.seven_day_limit || 80 }}
          UNDER_LIMIT: ${{ steps.usage.outputs.under_limit }}
          ASSIGNED_ISSUE: ${{ steps.assign.outputs.issue_number }}
          FOUND_ISSUE: ${{ steps.find_issue.outputs.issue_number }}
          FOUND_TITLE: ${{ steps.find_issue.outputs.issue_title }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          # Handle empty values
          FIVE_HOUR=${FIVE_HOUR:-0}
          SEVEN_DAY=${SEVEN_DAY:-0}

          # Determine status emoji
          if [[ "$UNDER_LIMIT" == "true" ]]; then
            status_emoji=":white_check_mark:"
            status_text="Under limits"
          else
            status_emoji=":warning:"
            status_text="At capacity"
          fi

          # Write summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Task Manager Summary

          ### Status: $status_emoji $status_text

          | Window | Usage | Limit | Resets |
          |--------|-------|-------|--------|
          | 5-Hour | ${FIVE_HOUR}% | ${FIVE_HOUR_LIMIT}% | $FIVE_HOUR_RESET |
          | 7-Day | ${SEVEN_DAY}% | ${SEVEN_DAY_LIMIT}% | $SEVEN_DAY_RESET |

          > Opus 7-day: ${SEVEN_DAY_OPUS}%

          EOF

          if [[ -n "$FOUND_ISSUE" ]]; then
            if [[ "$DRY_RUN" == "true" ]]; then
              cat >> $GITHUB_STEP_SUMMARY << EOF
          ### :eyes: Dry Run

          Would have assigned **nopo-bot** to issue [#$FOUND_ISSUE](${{ github.server_url }}/${{ github.repository }}/issues/$FOUND_ISSUE): $FOUND_TITLE

          EOF
            elif [[ -n "$ASSIGNED_ISSUE" ]]; then
              cat >> $GITHUB_STEP_SUMMARY << EOF
          ### :robot: Assignment

          Assigned **nopo-bot** to issue [#$ASSIGNED_ISSUE](${{ github.server_url }}/${{ github.repository }}/issues/$ASSIGNED_ISSUE): $FOUND_TITLE

          EOF
            fi
          elif [[ "$UNDER_LIMIT" == "true" ]]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ### :inbox_tray: Queue Empty

          No unassigned issues with "Ready" status found.

          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ### :pause_button: Paused

          Usage limits reached - not assigning new work.

          EOF
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ---

          :bar_chart: [Download usage chart](artifacts)

          EOF
