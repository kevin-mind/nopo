name: Task Manager
run-name: Task Manager - ${{ github.event_name == 'schedule' && 'Scheduled' || 'Manual' }}

on:
  schedule:
    # Run every hour between 0:00-6:00 UTC
    - cron: '0 0-6 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no assignments)'
        type: boolean
        default: false

permissions:
  contents: read
  issues: write

defaults:
  run:
    shell: bash

# Only one task manager instance at a time
concurrency:
  group: task-manager
  cancel-in-progress: false

jobs:
  manage-queue:
    runs-on: ubuntu-latest
    outputs:
      assigned_issue: ${{ steps.assign.outputs.issue_number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find ready unassigned issue
        id: find_issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Searching for Ready issues"

          repo_name="${GITHUB_REPOSITORY#*/}"
          owner="${GITHUB_REPOSITORY%/*}"

          # Query issues with project status via GraphQL
          result=$(gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                issues(first: 50, states: OPEN, orderBy: {field: CREATED_AT, direction: ASC}) {
                  nodes {
                    number
                    title
                    assignees(first: 1) { totalCount }
                    labels(first: 10) {
                      nodes { name }
                    }
                    projectItems(first: 5) {
                      nodes {
                        fieldValueByName(name: "Status") {
                          ... on ProjectV2ItemFieldSingleSelectValue { name }
                        }
                      }
                    }
                  }
                }
              }
            }
          ' -f owner="$owner" -f repo="$repo_name")

          # Find first unassigned issue with Status == "Ready"
          issue=$(echo "$result" | jq -c '
            [.data.repository.issues.nodes[] |
             select(.assignees.totalCount == 0) |
             select(.projectItems.nodes | any(.fieldValueByName.name == "Ready")) |
             {number: .number, title: .title}
            ] | first // null
          ')

          if [[ -n "$issue" && "$issue" != "null" ]]; then
            issue_number=$(echo "$issue" | jq -r '.number')
            issue_title=$(echo "$issue" | jq -r '.title')
            echo "Found Ready issue: #$issue_number - $issue_title"
            echo "issue_number=$issue_number" >> $GITHUB_OUTPUT
            echo "issue_title=$issue_title" >> $GITHUB_OUTPUT
          else
            echo "No Ready unassigned issues found"
            echo "issue_number=" >> $GITHUB_OUTPUT
          fi

          echo "::endgroup::"

      - name: Assign nopo-bot to issue
        id: assign
        if: steps.find_issue.outputs.issue_number != '' && inputs.dry_run != true
        env:
          # Use PAT_TOKEN to trigger the Claude workflow
          # GITHUB_TOKEN actions don't trigger new workflows
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          ISSUE_NUMBER: ${{ steps.find_issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.find_issue.outputs.issue_title }}
        run: |
          echo "::group::Assigning nopo-bot to issue #$ISSUE_NUMBER"

          gh issue edit "$ISSUE_NUMBER" --add-assignee "nopo-bot" --repo "$GITHUB_REPOSITORY"

          echo "::notice::Assigned nopo-bot to issue #$ISSUE_NUMBER: $ISSUE_TITLE"
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          echo "::endgroup::"

      - name: Dry run - would assign
        if: steps.find_issue.outputs.issue_number != '' && inputs.dry_run == true
        env:
          ISSUE_NUMBER: ${{ steps.find_issue.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.find_issue.outputs.issue_title }}
        run: |
          echo "::notice::[DRY RUN] Would assign nopo-bot to issue #$ISSUE_NUMBER: $ISSUE_TITLE"

      - name: Summary
        env:
          ASSIGNED_ISSUE: ${{ steps.assign.outputs.issue_number }}
          FOUND_ISSUE: ${{ steps.find_issue.outputs.issue_number }}
          FOUND_TITLE: ${{ steps.find_issue.outputs.issue_title }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Task Manager Summary

          EOF

          if [[ -n "$FOUND_ISSUE" ]]; then
            if [[ "$DRY_RUN" == "true" ]]; then
              cat >> $GITHUB_STEP_SUMMARY << EOF
          ### :eyes: Dry Run

          Would have assigned **nopo-bot** to issue [#$FOUND_ISSUE](${{ github.server_url }}/${{ github.repository }}/issues/$FOUND_ISSUE): $FOUND_TITLE

          EOF
            elif [[ -n "$ASSIGNED_ISSUE" ]]; then
              cat >> $GITHUB_STEP_SUMMARY << EOF
          ### :robot: Assignment

          Assigned **nopo-bot** to issue [#$ASSIGNED_ISSUE](${{ github.server_url }}/${{ github.repository }}/issues/$ASSIGNED_ISSUE): $FOUND_TITLE

          EOF
            fi
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ### :inbox_tray: Queue Empty

          No unassigned issues with "Ready" status found.

          EOF
          fi
