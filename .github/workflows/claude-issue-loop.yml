name: Claude Issue Loop

on:
  issues:
    types: [opened, edited, assigned]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

concurrency:
  group: claude-issue-${{ github.event.issue.number || github.event.pull_request.number }}-${{ github.event.action }}
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  #############################################################################
  # TRIAGE JOBS (triggered by issue opened/edited without 'triaged' label)
  #############################################################################

  triage:
    runs-on: ubuntu-latest
    if: |
      (github.event.action == 'opened' || github.event.action == 'edited') &&
      github.event_name == 'issues' &&
      !contains(github.event.issue.labels.*.name, 'triaged')
    concurrency:
      group: claude-triage-${{ github.event.issue.number }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - name: Add triage started comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "ðŸ‘€ **nopo-bot** is triaging this issue...

          [View job]($RUN_URL)"

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          prompt: |
            You are triaging issue #${{ github.event.issue.number }}: "${{ github.event.issue.title }}"

            Issue body:
            ${{ github.event.issue.body }}

            ## Issue Structure
            Issues follow this structure (from task.yml template):
            - **Description**: Brief TLDR of what needs to be done
            - **Details**: Implementation details, affected files, technical requirements
            - **Questions**: Open questions that need answers (checkboxes)
            - **Todo**: Specific tasks to complete (checkboxes)

            ## Your Tasks

            ### 1. ADD LABELS
            Add appropriate labels based on issue type:
            - 'bug', 'enhancement', 'documentation', 'refactor', 'test', 'chore'
            - Priority labels if urgency is indicated

            ### 2. SEARCH FOR RELATED CONTENT
            - Use `gh issue list` to find similar/related issues
            - Link to related issues in a comment
            - Check if this might be a duplicate

            ### 3. UPDATE THE ISSUE BODY
            Use `gh issue edit ${{ github.event.issue.number }} --body "..."` to improve the issue:

            **Description**: Improve clarity if needed, make it a concise TLDR

            **Details**: Expand with technical context:
            - Reference specific files/functions that will be affected
            - Link to relevant internal docs (files in `decisions/`, `nopo/docs/`, READMEs)
            - Link to external documentation (libraries, APIs, standards)
            - Add code snippets or examples if helpful

            **Questions**:
            - If questions exist, research and answer them (check the box and add answer)
            - Add new questions if you identify uncertainties

            **Todo**:
            - Break down vague tasks into specific, actionable items
            - Add missing tasks you identify from analyzing the codebase
            - Each todo should be completable in a single commit

            ### 4. VALIDATE COMPLETENESS
            - If critical info is missing, add 'needs-info' label
            - Ask clarifying questions in a comment

            ## Commands
            ```bash
            # View current issue
            gh issue view ${{ github.event.issue.number }}

            # Update issue body (use heredoc for multiline)
            gh issue edit ${{ github.event.issue.number }} --body "$(cat <<'EOF'
            ... new body content ...
            EOF
            )"

            # Add labels
            gh issue edit ${{ github.event.issue.number }} --add-label "enhancement"
            ```

            IMPORTANT:
            - DO NOT assign the issue to anyone
            - Focus on making the issue clear and actionable for implementation
            - Preserve the issue structure (Description, Details, Questions, Todo sections)
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 30"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add triaged label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh issue edit ${{ github.event.issue.number }} --add-label "triaged"

  #############################################################################
  # IMPLEMENT JOBS (triggered by nopo-bot assigned to issue)
  #############################################################################

  implement-check:
    runs-on: ubuntu-latest
    if: |
      github.event.action == 'assigned' &&
      github.event_name == 'issues' &&
      github.event.assignee.login == 'nopo-bot'
    outputs:
      should_implement: ${{ steps.check-pr.outputs.should_implement }}
      issue_title: ${{ github.event.issue.title }}
      issue_body: ${{ steps.issue.outputs.body }}
    steps:
      - uses: actions/checkout@v4

      - name: Check triaged label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          has_triaged=$(gh issue view "$ISSUE_NUMBER" --json labels --jq '.labels[].name' | grep -c "^triaged$" || true)

          if [[ "$has_triaged" -eq 0 ]]; then
            gh issue comment "$ISSUE_NUMBER" --body "âš ï¸ Cannot start implementation - issue is missing the \`triaged\` label.

          Please wait for triage to complete or manually add the \`triaged\` label, then re-assign nopo-bot."
            gh issue edit "$ISSUE_NUMBER" --remove-assignee "nopo-bot"
            echo "::error::Issue #$ISSUE_NUMBER is missing 'triaged' label"
            exit 1
          fi

      - name: Check project status is Ready
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Get project item status for this issue
          result=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $number) {
                  projectItems(first: 10) {
                    nodes {
                      fieldValueByName(name: "Status") {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                        }
                      }
                    }
                  }
                }
              }
            }
          ' -f owner="${GITHUB_REPOSITORY_OWNER}" -f repo="${GITHUB_REPOSITORY#*/}" -F number="$ISSUE_NUMBER" 2>/dev/null || echo '{}')

          status=$(echo "$result" | jq -r '.data.repository.issue.projectItems.nodes[0].fieldValueByName.name // empty')

          if [[ -z "$status" ]]; then
            echo "Issue not linked to a project - skipping status check"
          elif [[ "$status" != "Ready" ]]; then
            gh issue comment "$ISSUE_NUMBER" --body "âš ï¸ Cannot start implementation - issue status is **$status**, not **Ready**.

          Please move the issue to **Ready** status in the project board, then re-assign nopo-bot."
            gh issue edit "$ISSUE_NUMBER" --remove-assignee "nopo-bot"
            echo "::error::Issue #$ISSUE_NUMBER status is '$status', not 'Ready'"
            exit 1
          fi

      - name: Get issue body
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Store body in file to handle multiline
          gh issue view "$ISSUE_NUMBER" --json body --jq '.body' > /tmp/issue_body.txt
          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/issue_body.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Add implementation started comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "ðŸ‘€ **nopo-bot** is implementing this issue...

          [View job]($RUN_URL)"

      - name: Check if PR already exists
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Check if there's already a PR for this issue
          existing_pr=$(gh pr list --repo "$GITHUB_REPOSITORY" --search "Fixes #$ISSUE_NUMBER in:body" --json number --jq '.[0].number' || true)

          if [[ -n "$existing_pr" && "$existing_pr" != "null" ]]; then
            echo "PR #$existing_pr already exists for issue #$ISSUE_NUMBER"
            echo "should_implement=false" >> $GITHUB_OUTPUT
          else
            echo "No existing PR found - proceeding with implementation"
            echo "should_implement=true" >> $GITHUB_OUTPUT
          fi

  implement-update-project:
    needs: implement-check
    if: needs.implement-check.outputs.should_implement == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update project status to In Progress
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Get project item from issue
          result=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $number) {
                  projectItems(first: 10) {
                    nodes {
                      id
                      project { id }
                    }
                  }
                }
              }
            }
          ' -f owner="${GITHUB_REPOSITORY_OWNER}" -f repo="${GITHUB_REPOSITORY#*/}" -F number="$ISSUE_NUMBER")

          item_id=$(echo "$result" | jq -r '.data.repository.issue.projectItems.nodes[0].id // empty')
          project_id=$(echo "$result" | jq -r '.data.repository.issue.projectItems.nodes[0].project.id // empty')

          if [[ -z "$item_id" || -z "$project_id" ]]; then
            echo "Issue not linked to a project - skipping status update"
            exit 0
          fi

          # Get Status field and In Progress option IDs
          fields=$(gh api graphql -f query='
            query($projectId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options { id name }
                      }
                    }
                  }
                }
              }
            }
          ' -f projectId="$project_id")

          echo "Available fields and options:"
          echo "$fields" | jq '.data.node.fields.nodes[] | select(.options != null) | {name: .name, options: [.options[].name]}'

          field_id=$(echo "$fields" | jq -r '.data.node.fields.nodes[] | select(.name == "Status") | .id')
          option_id=$(echo "$fields" | jq -r '.data.node.fields.nodes[] | select(.name == "Status") | .options[] | select(.name == "In progress") | .id')

          if [[ -z "$field_id" || -z "$option_id" ]]; then
            echo "Could not find Status field or In Progress option"
            exit 0
          fi

          # Update to In Progress status
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(
                input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { singleSelectOptionId: $optionId }
                }
              ) { projectV2Item { id } }
            }
          ' -f projectId="$project_id" -f itemId="$item_id" -f fieldId="$field_id" -f optionId="$option_id"

          echo "Updated project item to In Progress status"

  implement:
    needs: [implement-check, implement-update-project]
    if: always() && needs.implement-check.outputs.should_implement == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@anthropic.com"

      - name: Create or checkout branch
        id: branch
        env:
          BRANCH_NAME: claude/issue/${{ github.event.issue.number }}
        run: |
          git fetch origin
          if git show-ref --verify --quiet refs/remotes/origin/$BRANCH_NAME; then
            git checkout $BRANCH_NAME
            git pull origin $BRANCH_NAME
          else
            git checkout -b $BRANCH_NAME
          fi
          echo "name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          assignee_trigger: "nopo-bot"
          settings: ".claude/settings.json"
          prompt: |
            Implement issue #${{ github.event.issue.number }}: "${{ needs.implement-check.outputs.issue_title }}"

            Issue body:
            ${{ needs.implement-check.outputs.issue_body }}

            You are on branch `${{ steps.branch.outputs.name }}`.

            INSTRUCTIONS:

            1. IMPLEMENT:
               - Follow the guidelines in CLAUDE.md strictly
               - Address all items in the Todo section
               - Keep changes focused and minimal

            2. VERIFY:
               - Run `make check` to validate linting and types
               - Run `make test` to run tests
               - Fix any failures before proceeding

            3. COMMIT AND PUSH:
               - Commit your changes with a descriptive message
               - Push the branch to origin

            4. CREATE DRAFT PR:
               - Use `gh pr create --draft` to create a DRAFT pull request
               - The PR body MUST contain "Fixes #${{ github.event.issue.number }}"
               - Include a detailed description of changes
               - Request review from `nopo-bot` using `--reviewer nopo-bot`

            IMPORTANT:
            - The "Fixes #N" pattern is REQUIRED for automatic issue linking and closure
            - Create as DRAFT so CI can run first - it will be marked ready automatically when CI passes
            - Always request nopo-bot as reviewer to trigger the review workflow
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 30"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  #############################################################################
  # COMMENT JOBS (triggered by @claude mention in issue/PR comments)
  #############################################################################

  comment:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      contains(github.event.comment.body, '@claude') &&
      github.event.comment.user.type != 'Bot'
    steps:
      - name: Add eyes reaction
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api "/repos/$GITHUB_REPOSITORY/issues/comments/${{ github.event.comment.id }}/reactions" \
            -f content="eyes" || true

      - name: Add working on it comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "ðŸ‘€ **nopo-bot** is responding to your request...

          [View job]($RUN_URL)"

      - name: Check Claude comment count
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
        run: |
          # Count comments from claude[bot] on this issue/PR
          comments=$(gh api "/repos/$GITHUB_REPOSITORY/issues/$ISSUE_NUMBER/comments" --jq '[.[] | select(.user.login == "claude[bot]")] | length')

          echo "Claude has made $comments comments on issue #$ISSUE_NUMBER"

          if [[ "$comments" -gt 20 ]]; then
            echo "::error::Claude has made over 20 comments on this issue. Stopping to prevent spam."
            exit 1
          fi

      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          trigger_phrase: "@claude"
          prompt: |
            You are responding to a question or request in a GitHub issue/PR comment.

            DO NOT implement code changes or make commits unless explicitly asked.

            To trigger automation, users should:
            - Assign `nopo-bot` to an issue for implementation
            - Request `nopo-bot` as PR reviewer for code review

            Focus on:
            - Answering questions
            - Providing explanations
            - Clarifying requirements
            - Suggesting approaches (without implementing)
            - Analyzing code or issues
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 30"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add reaction on completion
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SUCCESS: ${{ job.status == 'success' }}
        run: |
          if [[ "$SUCCESS" == "true" ]]; then
            reaction="+1"
          else
            reaction="-1"
          fi
          gh api "/repos/$GITHUB_REPOSITORY/issues/comments/${{ github.event.comment.id }}/reactions" \
            -f content="$reaction" || true
