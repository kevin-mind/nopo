name: Discussion Handler

# Handles discussion events dispatched from discussion-dispatcher.yml
# Uses repository_dispatch which IS supported by claude-code-action

on:
  repository_dispatch:
    types: [discussion_event]

permissions:
  contents: read
  discussions: write
  issues: write
  id-token: write

jobs:
  #############################################################################
  # PREPARE - Get discussion ID and add reactions
  #############################################################################

  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    outputs:
      discussion_id: ${{ steps.get_id.outputs.discussion_id }}
      action_type: ${{ github.event.client_payload.action_type }}
    steps:
      - name: Get discussion ID
        id: get_id
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_NUMBER: ${{ github.event.client_payload.discussion_number }}
        run: |
          discussion_data=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                discussion(number: $number) {
                  id
                }
              }
            }
          ' -f owner="${GITHUB_REPOSITORY%/*}" -f repo="${GITHUB_REPOSITORY#*/}" -F number="$DISCUSSION_NUMBER")

          discussion_id=$(echo "$discussion_data" | jq -r '.data.repository.discussion.id')
          echo "discussion_id=$discussion_id" >> $GITHUB_OUTPUT

      - name: Add eyes reaction if responding
        if: github.event.client_payload.action_type == 'respond'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |
          gh api graphql -f query='
            mutation($subjectId: ID!) {
              addReaction(input: {
                subjectId: $subjectId
                content: EYES
              }) {
                reaction { id }
              }
            }
          ' -f subjectId="$COMMENT_ID"

  #############################################################################
  # SUMMARIZE - Triggered by /summarize command
  #############################################################################

  summarize:
    needs: prepare
    if: github.event.client_payload.action_type == 'summarize'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        id: claude
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          show_full_output: true
          prompt: |
            You are summarizing Discussion #${{ github.event.client_payload.discussion_number }}.

            Fetch the full discussion content, analyze all comments, and organize into Key Findings, Questions Answered, Open Items, and Next Steps.

            ## IMPORTANT: Write Summary to File

            After completing your analysis, you MUST write your summary to /tmp/discussion-summary.md:
            ```bash
            cat > /tmp/discussion-summary.md << 'SUMMARY_EOF'
            ## ðŸ“‹ Discussion Summary

            <your organized summary with Key Findings, Questions Answered, Open Items, Next Steps>
            SUMMARY_EOF
            ```

            The workflow will post this file as a comment to the discussion.
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 50"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post summary comment
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
        run: |
          if [[ ! -f /tmp/discussion-summary.md ]]; then
            echo "No summary file found"
            exit 1
          fi

          gh api graphql -f query='
            mutation($discussionId: ID!, $body: String!) {
              addDiscussionComment(input: {
                discussionId: $discussionId
                body: $body
              }) {
                comment { id }
              }
            }
          ' -f discussionId="$DISCUSSION_ID" -F body=@/tmp/discussion-summary.md

  #############################################################################
  # RESPOND - Answer human comments
  #############################################################################

  respond:
    needs: prepare
    if: github.event.client_payload.action_type == 'respond'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        id: claude
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          show_full_output: true
          prompt: |
            You are responding to a user's question on Discussion #${{ github.event.client_payload.discussion_number }}.

            **User's Question:** ${{ github.event.client_payload.comment_body }}
            **Author:** @${{ github.event.client_payload.comment_author }}

            ## Your Task

            Research the question thoroughly:
            1. Search the codebase (grep, glob, read) to find relevant code
            2. Search GitHub (`gh issue list`, `gh pr list`) for related discussions
            3. Check documentation (decisions/, AGENTS.md, README.md)
            4. Web search if helpful for understanding external concepts

            Then provide a clear, helpful answer with:
            - Relevant code snippets with file paths (e.g., `src/file.ts:42`)
            - Citations from your research
            - Clear, actionable guidance
            - If they're asking for implementation, suggest: "Use `/plan` to create issues, then assign nopo-bot"

            ## IMPORTANT: Write Response to File

            After completing your research, you MUST write your answer to /tmp/discussion-response.md:
            ```bash
            cat > /tmp/discussion-response.md << 'RESPONSE_EOF'
            <your detailed answer with code examples and citations>
            RESPONSE_EOF
            ```

            The workflow will post this file as a reply to the discussion.
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 100"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post response comment
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
          REPLY_TO_ID: ${{ github.event.client_payload.comment_id }}
        run: |
          if [[ ! -f /tmp/discussion-response.md ]]; then
            echo "No response file found"
            exit 1
          fi

          gh api graphql -f query='
            mutation($discussionId: ID!, $replyToId: ID!, $body: String!) {
              addDiscussionComment(input: {
                discussionId: $discussionId
                replyToId: $replyToId
                body: $body
              }) {
                comment { id }
              }
            }
          ' -f discussionId="$DISCUSSION_ID" -f replyToId="$REPLY_TO_ID" -F body=@/tmp/discussion-response.md

      - name: Add success reaction
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |
          gh api graphql -f query='
            mutation($subjectId: ID!) {
              addReaction(input: {
                subjectId: $subjectId
                content: THUMBS_UP
              }) {
                reaction { id }
              }
            }
          ' -f subjectId="$COMMENT_ID"

      - name: Handle failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # Add thumbs down
          gh api graphql -f query='
            mutation($subjectId: ID!) {
              addReaction(input: {
                subjectId: $subjectId
                content: THUMBS_DOWN
              }) {
                reaction { id }
              }
            }
          ' -f subjectId="$COMMENT_ID" || true

          # Post error as reply
          gh api graphql -f query='
            mutation($discussionId: ID!, $replyToId: ID!, $body: String!) {
              addDiscussionComment(input: {
                discussionId: $discussionId
                replyToId: $replyToId
                body: $body
              }) {
                comment { id }
              }
            }
          ' -f discussionId="$DISCUSSION_ID" -f replyToId="$COMMENT_ID" -f body="âš ï¸ **Failed to process your question**

          See [workflow run]($RUN_URL) for details."

  #############################################################################
  # RESEARCH - Triggered by new discussion creation
  #############################################################################

  research:
    needs: prepare
    if: github.event.client_payload.action_type == 'research'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        id: claude
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          show_full_output: true
          prompt: |
            A new discussion was created: **${{ github.event.client_payload.discussion_title }}**

            **Discussion body:**
            ${{ github.event.client_payload.discussion_body }}

            ## Your Task

            Perform vigorous research on this topic:
            1. Search the codebase (grep, glob, read) to find relevant code and patterns
            2. Search GitHub (`gh issue list`, `gh pr list`) for related discussions
            3. Check documentation (decisions/, AGENTS.md, README.md)
            4. Web search for external concepts or best practices (if needed)

            Organize your findings into major research areas (e.g., Architecture, Implementation Patterns, Related Work, Code Examples).

            ## IMPORTANT: Write Research to File

            After completing your research, you MUST write your findings to /tmp/discussion-research.md:
            ```bash
            cat > /tmp/discussion-research.md << 'RESEARCH_EOF'
            ## Research Findings

            ### <Topic 1>
            <findings with code examples and citations>

            ### <Topic 2>
            <findings with code examples and citations>
            RESEARCH_EOF
            ```

            The workflow will post this file as a comment to the discussion.
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 100"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post research comment
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
        run: |
          if [[ ! -f /tmp/discussion-research.md ]]; then
            echo "No research file found"
            exit 1
          fi

          gh api graphql -f query='
            mutation($discussionId: ID!, $body: String!) {
              addDiscussionComment(input: {
                discussionId: $discussionId
                body: $body
              }) {
                comment { id }
              }
            }
          ' -f discussionId="$DISCUSSION_ID" -F body=@/tmp/discussion-research.md

  #############################################################################
  # PLAN - Create GitHub issues from discussion
  #############################################################################

  plan:
    needs: prepare
    if: github.event.client_payload.action_type == 'plan'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        id: claude
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          show_full_output: true
          prompt: |
            A user requested a plan for Discussion #${{ github.event.client_payload.discussion_number }}.

            ## Your Task

            1. Fetch the full discussion content using gh api graphql

            2. Search the codebase to understand current architecture and identify where changes are needed

            3. Extract actionable items and create GitHub issues for each:
            ```bash
            gh issue create \
              --title "Your Issue Title" \
              --body "Related to discussion: #${{ github.event.client_payload.discussion_number }}

            ## Context
            [Context from discussion]

            ## Tasks
            - [ ] Task 1
            - [ ] Task 2" \
              --label "discussion:${{ github.event.client_payload.discussion_number }}"
            ```

            ## IMPORTANT: Write Summary to File

            After creating issues, you MUST write a summary to /tmp/discussion-plan-summary.md:
            ```bash
            cat > /tmp/discussion-plan-summary.md << 'PLAN_EOF'
            ## ðŸ“‹ Created Issues

            - #123 - Issue title here
            - #124 - Another issue title

            Assign nopo-bot to any of these issues to have me implement them.
            PLAN_EOF
            ```

            The workflow will post this file as a reply to the discussion.
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 100"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post plan summary comment
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
          REPLY_TO_ID: ${{ github.event.client_payload.comment_id }}
        run: |
          if [[ ! -f /tmp/discussion-plan-summary.md ]]; then
            echo "No plan summary file found"
            exit 1
          fi

          gh api graphql -f query='
            mutation($discussionId: ID!, $replyToId: ID!, $body: String!) {
              addDiscussionComment(input: {
                discussionId: $discussionId
                replyToId: $replyToId
                body: $body
              }) {
                comment { id }
              }
            }
          ' -f discussionId="$DISCUSSION_ID" -f replyToId="$REPLY_TO_ID" -F body=@/tmp/discussion-plan-summary.md

  #############################################################################
  # COMPLETE - Mark discussion thread as complete
  #############################################################################

  complete:
    needs: prepare
    if: github.event.client_payload.action_type == 'complete'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    steps:
      - name: Add rocket reaction
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |
          gh api graphql -f query='
            mutation($subjectId: ID!) {
              addReaction(input: {
                subjectId: $subjectId
                content: ROCKET
              }) {
                reaction { id }
              }
            }
          ' -f subjectId="$COMMENT_ID"

      - name: Post completion message
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
        run: |
          gh api graphql -f query='
            mutation($discussionId: ID!, $body: String!) {
              addDiscussionComment(input: {
                discussionId: $discussionId
                body: $body
              }) {
                comment { id }
              }
            }
          ' -f discussionId="$DISCUSSION_ID" -f body="âœ… **This discussion thread has been marked as complete.**

          If you have additional questions, feel free to post a new comment!"
