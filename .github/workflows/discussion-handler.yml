name: Discussion Handler

# Handles discussion events dispatched from discussion-dispatcher.yml
# Uses repository_dispatch which IS supported by claude-code-action

on:
  repository_dispatch:
    types: [discussion_event]

permissions:
  contents: read
  discussions: write
  issues: write
  id-token: write

jobs:
  #############################################################################
  # PREPARE - Get discussion ID and add reactions
  #############################################################################

  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    outputs:
      discussion_id: ${{ steps.get_id.outputs.discussion_id }}
      action_type: ${{ github.event.client_payload.action_type }}
    steps:
      - name: Get discussion ID
        id: get_id
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_NUMBER: ${{ github.event.client_payload.discussion_number }}
        run: |
          discussion_data=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                discussion(number: $number) {
                  id
                }
              }
            }
          ' -f owner="${GITHUB_REPOSITORY%/*}" -f repo="${GITHUB_REPOSITORY#*/}" -F number="$DISCUSSION_NUMBER")

          discussion_id=$(echo "$discussion_data" | jq -r '.data.repository.discussion.id')
          echo "discussion_id=$discussion_id" >> $GITHUB_OUTPUT

      - name: Add eyes reaction if responding
        if: github.event.client_payload.action_type == 'respond'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |
          gh api graphql -f query='
            mutation($subjectId: ID!) {
              addReaction(input: {
                subjectId: $subjectId
                content: EYES
              }) {
                reaction { id }
              }
            }
          ' -f subjectId="$COMMENT_ID"

  #############################################################################
  # SUMMARIZE - Triggered by /summarize command
  #############################################################################

  summarize:
    needs: prepare
    if: github.event.client_payload.action_type == 'summarize'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          prompt: |
            **YOUR PRIMARY OBJECTIVE: Post a comprehensive summary comment to Discussion #${{ github.event.client_payload.discussion_number }}**

            You MUST complete ALL of these steps:

            ## STEP 1: Fetch the full discussion content

            Run this command to get all discussion content:
            ```bash
            gh api graphql -f query='
              query {
                repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") {
                  discussion(number: ${{ github.event.client_payload.discussion_number }}) {
                    title
                    body
                    comments(first: 100) {
                      nodes {
                        body
                        author { login }
                        replies(first: 100) {
                          nodes {
                            body
                            author { login }
                          }
                        }
                      }
                    }
                  }
                }
              }
            '
            ```

            ## STEP 2: Analyze and organize the content

            Read through all comments and organize into:
            - **Key Findings**: Main discoveries and insights
            - **Questions Answered**: Q&A pairs from the discussion
            - **Open Items**: Unresolved questions or pending topics
            - **Next Steps**: Recommended actions

            ## STEP 3: POST THE SUMMARY TO THE DISCUSSION (REQUIRED!)

            You MUST post your summary as a comment. Use this EXACT command:
            ```bash
            gh api graphql -f query='
              mutation($discussionId: ID!, $body: String!) {
                addDiscussionComment(input: {
                  discussionId: $discussionId
                  body: $body
                }) {
                  comment { id }
                }
              }
            ' -f discussionId="${{ needs.prepare.outputs.discussion_id }}" -f body="YOUR_SUMMARY_HERE"
            ```

            Replace YOUR_SUMMARY_HERE with your actual summary using this format:
            ```markdown
            ## üìã Discussion Summary

            ### Key Findings
            - Finding 1
            - Finding 2

            ### Questions Answered
            - Q: Question 1
              A: Answer 1

            ### Open Items
            - Open question 1

            ### Next Steps
            - Recommended action 1
            ```

            **CRITICAL: You have NOT completed this task until you successfully post the summary comment to the discussion using the gh api graphql mutation above.**
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 50"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  #############################################################################
  # RESPOND - Answer human comments
  #############################################################################

  respond:
    needs: prepare
    if: github.event.client_payload.action_type == 'respond'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          prompt: |
            **YOUR PRIMARY OBJECTIVE: Post a helpful answer as a reply to the user's comment on Discussion #${{ github.event.client_payload.discussion_number }}**

            **User's Question:** ${{ github.event.client_payload.comment_body }}
            **Author:** @${{ github.event.client_payload.comment_author }}

            You MUST complete ALL of these steps:

            ## STEP 1: Research the question thoroughly

            Use these tools to gather information:
            1. **Search the codebase**: Use grep, glob, and read to find relevant code
            2. **Search GitHub**: Use `gh issue list`, `gh pr list` to find related discussions
            3. **Check documentation**: Read files in decisions/, AGENTS.md, README.md
            4. **Web search**: If needed for external concepts or technologies

            ## STEP 2: POST YOUR ANSWER AS A REPLY (REQUIRED!)

            You MUST post your answer as a reply to the user's comment. Use this EXACT command:
            ```bash
            gh api graphql -f query='
              mutation($replyToId: ID!, $body: String!) {
                addDiscussionComment(input: {
                  replyToId: $replyToId
                  body: $body
                }) {
                  comment { id }
                }
              }
            ' -f replyToId="${{ github.event.client_payload.comment_id }}" -f body="YOUR_ANSWER_HERE"
            ```

            Replace YOUR_ANSWER_HERE with your detailed answer. Your answer MUST:
            - Include relevant code snippets with file paths (e.g., `src/file.ts:42`)
            - Cite sources from your research
            - Be clear and actionable
            - If they're asking for implementation help, suggest: "Use `/plan` to create issues, then assign nopo-bot"

            **CRITICAL: You have NOT completed this task until you successfully post your answer as a reply using the gh api graphql mutation above.**
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 100"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add success reaction
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |
          gh api graphql -f query='
            mutation($subjectId: ID!) {
              addReaction(input: {
                subjectId: $subjectId
                content: THUMBS_UP
              }) {
                reaction { id }
              }
            }
          ' -f subjectId="$COMMENT_ID"

      - name: Handle failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # Add thumbs down
          gh api graphql -f query='
            mutation($subjectId: ID!) {
              addReaction(input: {
                subjectId: $subjectId
                content: THUMBS_DOWN
              }) {
                reaction { id }
              }
            }
          ' -f subjectId="$COMMENT_ID" || true

          # Post error as reply
          gh api graphql -f query='
            mutation($replyToId: ID!, $body: String!) {
              addDiscussionComment(input: {
                replyToId: $replyToId
                body: $body
              }) {
                comment { id }
              }
            }
          ' -f replyToId="$COMMENT_ID" -f body="‚ö†Ô∏è **Failed to process your question**

          See [workflow run]($RUN_URL) for details."

  #############################################################################
  # RESEARCH - Triggered by new discussion creation
  #############################################################################

  research:
    needs: prepare
    if: github.event.client_payload.action_type == 'research'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          prompt: |
            **YOUR PRIMARY OBJECTIVE: Research the new discussion topic and post multiple research threads as top-level comments**

            **Discussion Title:** ${{ github.event.client_payload.discussion_title }}
            **Discussion Body:** ${{ github.event.client_payload.discussion_body }}

            You MUST complete ALL of these steps:

            ## STEP 1: Perform vigorous research

            Investigate this topic thoroughly using:
            1. **Codebase search**: Use grep, glob, and read to find relevant code and patterns
            2. **GitHub search**: Use `gh issue list`, `gh pr list` to find related discussions
            3. **Documentation**: Read decisions/, AGENTS.md, README.md for context
            4. **Web search**: For external concepts or best practices (if needed)

            ## STEP 2: POST MULTIPLE RESEARCH THREADS (REQUIRED!)

            You MUST create multiple top-level comments, one for each major research area you discover.

            For EACH research area, use this command to post a top-level comment:
            ```bash
            gh api graphql -f query='
              mutation($discussionId: ID!, $body: String!) {
                addDiscussionComment(input: {
                  discussionId: $discussionId
                  body: $body
                }) {
                  comment { id }
                }
              }
            ' -f discussionId="${{ needs.prepare.outputs.discussion_id }}" -f body="YOUR_RESEARCH_FINDINGS_HERE"
            ```

            Example research areas might include:
            - Architecture findings
            - Implementation patterns
            - Related issues/PRs
            - Documentation gaps
            - Code examples

            Each comment should:
            - Start with "## Research: [Topic Name]"
            - Include code snippets with file paths (e.g., `src/file.ts:42`)
            - Cite sources
            - Be focused on a single topic

            **CRITICAL: You have NOT completed this task until you successfully post AT LEAST 2-3 research thread comments to the discussion using the gh api graphql mutation above.**
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 100"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  #############################################################################
  # PLAN - Create GitHub issues from discussion
  #############################################################################

  plan:
    needs: prepare
    if: github.event.client_payload.action_type == 'plan'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          prompt: |
            **YOUR PRIMARY OBJECTIVE: Analyze Discussion #${{ github.event.client_payload.discussion_number }}, create GitHub issues, and post a summary**

            You MUST complete ALL of these steps:

            ## STEP 1: Fetch the full discussion content

            Run this command to get all discussion content:
            ```bash
            gh api graphql -f query='
              query {
                repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") {
                  discussion(number: ${{ github.event.client_payload.discussion_number }}) {
                    title
                    body
                    comments(first: 100) {
                      nodes {
                        body
                        author { login }
                        replies(first: 100) {
                          nodes {
                            body
                            author { login }
                          }
                        }
                      }
                    }
                  }
                }
              }
            '
            ```

            ## STEP 2: Analyze codebase

            Search the codebase to understand:
            - Current architecture
            - Where changes need to be made
            - Existing patterns to follow

            ## STEP 3: CREATE GITHUB ISSUES (REQUIRED!)

            Extract actionable items from the discussion and create GitHub issues.

            For EACH issue you create, use this command:
            ```bash
            gh issue create \
              --title "Your Issue Title" \
              --body "Related to discussion: #${{ github.event.client_payload.discussion_number }}

            ## Context
            [Context from discussion]

            ## Tasks
            - [ ] Task 1
            - [ ] Task 2" \
              --label "discussion:${{ github.event.client_payload.discussion_number }}"
            ```

            ## STEP 4: POST SUMMARY TO DISCUSSION (REQUIRED!)

            After creating all issues, post a summary as a reply using this EXACT command:
            ```bash
            gh api graphql -f query='
              mutation($replyToId: ID!, $body: String!) {
                addDiscussionComment(input: {
                  replyToId: $replyToId
                  body: $body
                }) {
                  comment { id }
                }
              }
            ' -f replyToId="${{ github.event.client_payload.comment_id }}" -f body="YOUR_SUMMARY_HERE"
            ```

            Replace YOUR_SUMMARY_HERE with a summary listing all created issues:
            ```markdown
            ## üìã Created Issues

            I've created the following issues based on this discussion:

            - #123 - Issue title 1
            - #124 - Issue title 2

            Assign nopo-bot to any of these issues to have me implement them.
            ```

            **CRITICAL: You have NOT completed this task until you:
            1. Create at least 1 GitHub issue with the discussion label
            2. Post a summary comment to the discussion listing all created issues**
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 100"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  #############################################################################
  # COMPLETE - Mark discussion thread as complete
  #############################################################################

  complete:
    needs: prepare
    if: github.event.client_payload.action_type == 'complete'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    steps:
      - name: Add rocket reaction
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |
          gh api graphql -f query='
            mutation($subjectId: ID!) {
              addReaction(input: {
                subjectId: $subjectId
                content: ROCKET
              }) {
                reaction { id }
              }
            }
          ' -f subjectId="$COMMENT_ID"

      - name: Post completion message
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
        run: |
          gh api graphql -f query='
            mutation($discussionId: ID!, $body: String!) {
              addDiscussionComment(input: {
                discussionId: $discussionId
                body: $body
              }) {
                comment { id }
              }
            }
          ' -f discussionId="$DISCUSSION_ID" -f body="‚úÖ **This discussion thread has been marked as complete.**

          If you have additional questions, feel free to post a new comment!"
