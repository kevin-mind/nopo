name: Discussion Handler
'on':
  repository_dispatch:
    types:
      - discussion_event
permissions:
  contents: write
  discussions: write
  issues: write
  id-token: write
jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    outputs:
      discussion_id: ${{ steps.get_id.outputs.discussion_id }}
      discussion_body: ${{ steps.get_id.outputs.discussion_body }}
      action_type: ${{ github.event.client_payload.action_type }}
    steps:
      - id: get_id
        name: Get discussion ID and body
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_NUMBER: ${{ github.event.client_payload.discussion_number }}
        run: |2-
            discussion_data=$(gh api graphql -f query='
              query($owner: String!, $repo: String!, $number: Int!) {
            repository(owner: $owner, name: $repo) {
              discussion(number: $number) {
                id
                body
              }
            }
          }
            ' -f owner="${GITHUB_REPOSITORY%/*}" -f repo="${GITHUB_REPOSITORY#*/}" -F number="$DISCUSSION_NUMBER")

            discussion_id=$(echo "$discussion_data" | jq -r '.data.repository.discussion.id')
            echo "discussion_id=$discussion_id" >> $GITHUB_OUTPUT

            # Store body in a file to handle multiline content safely
            echo "$discussion_data" | jq -r '.data.repository.discussion.body' > /tmp/discussion-original-body.txt
      - id: upload_body
        name: Upload original body
        uses: actions/upload-artifact@v4
        with:
          name: discussion-original-body
          path: /tmp/discussion-original-body.txt
          retention-days: 1
      - id: add_eyes
        name: Add eyes reaction if responding
        if: github.event.client_payload.action_type == 'respond'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |2-
            gh api graphql -f query='
              mutation($subjectId: ID!) {
            addReaction(input: {
              subjectId: $subjectId
              content: EYES
            }) {
              reaction { id }
            }
          }
            ' -f subjectId="$COMMENT_ID"
  summarize:
    if: github.event.client_payload.action_type == 'summarize'
    uses: ./.github/workflows/_claude.yml
    with:
      job: discussion-summarize
      discussion_number: ${{ github.event.client_payload.discussion_number }}
    secrets: inherit
    needs:
      - prepare
  summarize-post:
    if: always() && github.event.client_payload.action_type == 'summarize'
    runs-on: ubuntu-latest
    permissions:
      discussions: write
    steps:
      - id: download_artifact
        name: Download Claude output
        uses: actions/download-artifact@v4
        with:
          name: claude-discussion-output
          path: /tmp
      - id: post_summary
        name: Post summary comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
        run: |
          if [[ ! -f /tmp/discussion-summary.md ]]; then
            echo "No summary file found"
            exit 1
          fi

          gh api graphql -f query='
            mutation($discussionId: ID!, $body: String!) {
              addDiscussionComment(input: {
                discussionId: $discussionId
                body: $body
              }) {
                comment { id }
              }
            }
          ' -f discussionId="$DISCUSSION_ID" -F body=@/tmp/discussion-summary.md
    needs:
      - prepare
      - summarize
  respond:
    if: github.event.client_payload.action_type == 'respond'
    uses: ./.github/workflows/_claude.yml
    with:
      job: discussion-respond
      discussion_number: ${{ github.event.client_payload.discussion_number }}
      comment_body: ${{ github.event.client_payload.comment_body }}
      comment_author: ${{ github.event.client_payload.comment_author }}
    secrets: inherit
    needs:
      - prepare
  respond-post:
    if: always() && github.event.client_payload.action_type == 'respond'
    runs-on: ubuntu-latest
    permissions:
      discussions: write
    steps:
      - id: download_artifact
        name: Download Claude output
        uses: actions/download-artifact@v4
        with:
          name: claude-discussion-output
          path: /tmp
        continue-on-error: true
      - id: find_root
        name: Find thread root comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |
          # Query the comment to see if it has a parent (replyTo)
          comment_data=$(gh api graphql -f query='
            query($commentId: ID!) {
              node(id: $commentId) {
                ... on DiscussionComment {
                  id
                  replyTo {
                    id
                    replyTo {
                      id
                    }
                  }
                }
              }
            }
          ' -f commentId="$COMMENT_ID")

          # Extract the root comment ID (walk up the replyTo chain)
          root_id=$(echo "$comment_data" | jq -r '
            .data.node
            | if .replyTo.replyTo.id then .replyTo.replyTo.id
              elif .replyTo.id then .replyTo.id
              else .id
              end
          ')

          echo "Original comment: $COMMENT_ID"
          echo "Root comment: $root_id"
          echo "root_comment_id=$root_id" >> $GITHUB_OUTPUT
      - id: post_response
        name: Post response comment
        if: needs.respond.result == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
          REPLY_TO_ID: ${{ steps.find_root.outputs.root_comment_id }}
        run: |
          if [[ ! -f /tmp/discussion-response.md ]]; then
            echo "No response file found"
            exit 1
          fi

          gh api graphql -f query='
            mutation($discussionId: ID!, $replyToId: ID!, $body: String!) {
              addDiscussionComment(input: {
                discussionId: $discussionId
                replyToId: $replyToId
                body: $body
              }) {
                comment { id }
              }
            }
          ' -f discussionId="$DISCUSSION_ID" -f replyToId="$REPLY_TO_ID" -F body=@/tmp/discussion-response.md
      - id: add_success
        name: Add success reaction
        if: needs.respond.result == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |
          gh api graphql -f query='
            mutation($subjectId: ID!) {
              addReaction(input: {
                subjectId: $subjectId
                content: THUMBS_UP
              }) {
                reaction { id }
              }
            }
          ' -f subjectId="$COMMENT_ID"
      - id: handle_failure
        name: Handle failure
        if: needs.respond.result == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
          ROOT_COMMENT_ID: ${{ steps.find_root.outputs.root_comment_id }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # Add thumbs down to the original comment
          gh api graphql -f query='
            mutation($subjectId: ID!) {
              addReaction(input: {
                subjectId: $subjectId
                content: THUMBS_DOWN
              }) {
                reaction { id }
              }
            }
          ' -f subjectId="$COMMENT_ID" || true

          # Post error as reply to the root comment in the thread
          gh api graphql -f query='
            mutation($discussionId: ID!, $replyToId: ID!, $body: String!) {
              addDiscussionComment(input: {
                discussionId: $discussionId
                replyToId: $replyToId
                body: $body
              }) {
                comment { id }
              }
            }
          ' -f discussionId="$DISCUSSION_ID" -f replyToId="${ROOT_COMMENT_ID:-$COMMENT_ID}" -f body="⚠️ **Failed to process your question**

          See [workflow run]($RUN_URL) for details."
    needs:
      - prepare
      - respond
  research:
    if: github.event.client_payload.action_type == 'research'
    uses: ./.github/workflows/_claude.yml
    with:
      job: discussion-research
      discussion_title: ${{ github.event.client_payload.discussion_title }}
      discussion_body: ${{ github.event.client_payload.discussion_body }}
    secrets: inherit
    needs:
      - prepare
  research-post:
    if: always() && github.event.client_payload.action_type == 'research'
    runs-on: ubuntu-latest
    permissions:
      discussions: write
    steps:
      - id: download_artifact
        name: Download Claude output
        uses: actions/download-artifact@v4
        with:
          name: claude-discussion-output
          path: /tmp
      - id: debug_files
        name: Debug - List created files
        run: |
          echo "=== Files in /tmp ==="
          ls -la /tmp/research-thread-*.md 2>/dev/null || echo "No research-thread files found"
          ls -la /tmp/discussion-*.md 2>/dev/null || echo "No discussion files found"
          echo ""
          echo "=== Content of research thread files ==="
          for file in /tmp/research-thread-*.md; do
            if [[ -f "$file" ]]; then
              echo "--- $file ---"
              head -20 "$file"
              echo ""
            fi
          done
      - id: post_threads
        name: Post research thread comments
        if: needs.research.result == 'success'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
        run: |
          # Check if files exist
          if ! ls /tmp/research-thread-*.md 1> /dev/null 2>&1; then
            echo "ERROR: No research thread files found!"
            echo "The Claude agent should have created files like /tmp/research-thread-1.md"
            exit 1
          fi

          # Count files
          file_count=$(ls /tmp/research-thread-*.md 2>/dev/null | wc -l)
          echo "Found $file_count research thread files"

          # Post each research thread and collect comment IDs
          for file in /tmp/research-thread-*.md; do
            if [[ -f "$file" ]]; then
              echo "Posting research thread: $file"

              # Post comment and capture the comment ID
              comment_result=$(gh api graphql -f query='
                mutation($discussionId: ID!, $body: String!) {
                  addDiscussionComment(input: {
                    discussionId: $discussionId
                    body: $body
                  }) {
                    comment { id }
                  }
                }
              ' -f discussionId="$DISCUSSION_ID" -F body=@"$file")

              comment_id=$(echo "$comment_result" | jq -r '.data.addDiscussionComment.comment.id')
              echo "Posted comment: $comment_id"

              # Small delay between posts
              sleep 2
            fi
          done

          echo "Successfully posted $file_count research threads"
          echo "Comments posted with PAT - webhooks will trigger dispatcher automatically"
    needs:
      - prepare
      - research
  plan:
    if: github.event.client_payload.action_type == 'plan'
    uses: ./.github/workflows/_claude.yml
    with:
      job: discussion-plan
      discussion_number: ${{ github.event.client_payload.discussion_number }}
    secrets: inherit
    needs:
      - prepare
  plan-post:
    if: always() && github.event.client_payload.action_type == 'plan'
    runs-on: ubuntu-latest
    permissions:
      discussions: write
    steps:
      - id: download_artifact
        name: Download Claude output
        uses: actions/download-artifact@v4
        with:
          name: claude-discussion-output
          path: /tmp
        continue-on-error: true
      - id: find_root
        name: Find thread root comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |
          # Query the comment to see if it has a parent (replyTo)
          comment_data=$(gh api graphql -f query='
            query($commentId: ID!) {
              node(id: $commentId) {
                ... on DiscussionComment {
                  id
                  replyTo {
                    id
                    replyTo {
                      id
                    }
                  }
                }
              }
            }
          ' -f commentId="$COMMENT_ID")

          # Extract the root comment ID (walk up the replyTo chain)
          root_id=$(echo "$comment_data" | jq -r '
            .data.node
            | if .replyTo.replyTo.id then .replyTo.replyTo.id
              elif .replyTo.id then .replyTo.id
              else .id
              end
          ')

          echo "Original comment: $COMMENT_ID"
          echo "Root comment: $root_id"
          echo "root_comment_id=$root_id" >> $GITHUB_OUTPUT
      - id: post_plan
        name: Post plan summary comment
        if: needs.plan.result == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
          REPLY_TO_ID: ${{ steps.find_root.outputs.root_comment_id }}
        run: |
          if [[ ! -f /tmp/discussion-plan-summary.md ]]; then
            echo "No plan summary file found"
            exit 1
          fi

          gh api graphql -f query='
            mutation($discussionId: ID!, $replyToId: ID!, $body: String!) {
              addDiscussionComment(input: {
                discussionId: $discussionId
                replyToId: $replyToId
                body: $body
              }) {
                comment { id }
              }
            }
          ' -f discussionId="$DISCUSSION_ID" -f replyToId="$REPLY_TO_ID" -F body=@/tmp/discussion-plan-summary.md
    needs:
      - prepare
      - plan
  complete:
    if: github.event.client_payload.action_type == 'complete'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    steps:
      - id: add_rocket
        name: Add rocket reaction
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |-
          gh api graphql -f query='
            mutation($subjectId: ID!) {
              addReaction(input: {
                subjectId: $subjectId
                content: ROCKET
              }) {
                reaction { id }
              }
            }
          ' -f subjectId="$COMMENT_ID"
      - id: post_completion
        name: Post completion message
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
        run: |2-
            gh api graphql -f query='
              mutation($discussionId: ID!, $body: String!) {
            addDiscussionComment(input: {
              discussionId: $discussionId
              body: $body
            }) {
              comment { id }
            }
          }
            ' -f discussionId="$DISCUSSION_ID" -f body="✅ **This discussion thread has been marked as complete.**

            If you have additional questions, feel free to post a new comment!"
    needs:
      - prepare
  update-description:
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    permissions:
      discussions: write
    steps:
      - id: download_updated_body
        name: Download updated body (try all sources)
        uses: actions/download-artifact@v4
        with:
          pattern: discussion-updated-body-*
          merge-multiple: true
          path: /tmp/updated-bodies
        continue-on-error: true
      - id: apply_updated_body
        name: Find and apply updated body
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
        run: |2-
            # Find any updated body file
            if [[ -d /tmp/updated-bodies ]]; then
              updated_file=$(find /tmp/updated-bodies -name "*.md" -type f | head -1)
            fi

            if [[ -z "$updated_file" || ! -f "$updated_file" ]]; then
              echo "No updated body file found, skipping description update"
              exit 0
            fi

            echo "Found updated body: $updated_file"

            gh api graphql -f query='
              mutation($discussionId: ID!, $body: String!) {
            updateDiscussion(input: {
              discussionId: $discussionId
              body: $body
            }) {
              discussion { id }
            }
          }
            ' -f discussionId="$DISCUSSION_ID" -F body=@"$updated_file"

            echo "✅ Discussion description updated"
    needs:
      - prepare
      - summarize
      - summarize-post
      - respond
      - respond-post
      - research
      - research-post
      - plan
      - plan-post
