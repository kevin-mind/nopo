name: Discussion Handler
'on':
  repository_dispatch:
    types:
      - discussion_event
permissions:
  contents: write
  discussions: write
  issues: write
  id-token: write
jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    outputs:
      discussion_id: ${{ steps.get_id.outputs.discussion_id }}
      discussion_body: ${{ steps.get_id.outputs.discussion_body }}
      action_type: ${{ github.event.client_payload.action_type }}
    steps:
      - id: get_id
        name: Get discussion ID and body
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_NUMBER: ${{ github.event.client_payload.discussion_number }}
        run: |2-
            discussion_data=$(gh api graphql -f query='
              query($owner: String!, $repo: String!, $number: Int!) {
            repository(owner: $owner, name: $repo) {
              discussion(number: $number) {
                id
                body
              }
            }
          }
            ' -f owner="${GITHUB_REPOSITORY%/*}" -f repo="${GITHUB_REPOSITORY#*/}" -F number="$DISCUSSION_NUMBER")

            discussion_id=$(echo "$discussion_data" | jq -r '.data.repository.discussion.id')
            echo "discussion_id=$discussion_id" >> $GITHUB_OUTPUT

            # Store body in a file to handle multiline content safely
            echo "$discussion_data" | jq -r '.data.repository.discussion.body' > /tmp/discussion-original-body.txt
      - id: upload_body
        name: Upload original body
        uses: actions/upload-artifact@v4
        with:
          name: discussion-original-body
          path: /tmp/discussion-original-body.txt
          retention-days: 1
      - id: add_eyes
        name: Add eyes reaction if responding
        if: github.event.client_payload.action_type == 'respond'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |2-
            gh api graphql -f query='
              mutation($subjectId: ID!) {
            addReaction(input: {
              subjectId: $subjectId
              content: EYES
            }) {
              reaction { id }
            }
          }
            ' -f subjectId="$COMMENT_ID"
  summarize:
    if: github.event.client_payload.action_type == 'summarize'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: download_body
        name: Download original body
        uses: actions/download-artifact@v4
        with:
          name: discussion-original-body
          path: /tmp
      - id: build_summarize_replacements
        uses: ./.github/actions-ts/prompt-replacements
        with:
          pairs: |
            DISCUSSION_NUMBER=${{ github.event.client_payload.discussion_number }}
      - id: claude
        uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/discussion-summarize.txt
          prompt_replacements: ${{ steps.build_summarize_replacements.outputs.json }}
          max_turns: '50'
          show_full_output: 'true'
      - id: post_summary
        name: Post summary comment
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
        run: |2-
            if [[ ! -f /tmp/discussion-summary.md ]]; then
              echo "No summary file found"
              exit 1
            fi

            gh api graphql -f query='
              mutation($discussionId: ID!, $body: String!) {
            addDiscussionComment(input: {
              discussionId: $discussionId
              body: $body
            }) {
              comment { id }
            }
          }
            ' -f discussionId="$DISCUSSION_ID" -F body=@/tmp/discussion-summary.md
      - id: upload_updated_body
        name: Upload updated body
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: discussion-updated-body-summarize
          path: /tmp/discussion-updated-body.md
          if-no-files-found: ignore
    needs:
      - prepare
  respond:
    if: github.event.client_payload.action_type == 'respond'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: download_body
        name: Download original body
        uses: actions/download-artifact@v4
        with:
          name: discussion-original-body
          path: /tmp
      - id: build_respond_replacements
        uses: ./.github/actions-ts/prompt-replacements
        with:
          pairs: |
            DISCUSSION_NUMBER=${{ github.event.client_payload.discussion_number }}
            COMMENT_BODY=${{ github.event.client_payload.comment_body }}
            COMMENT_AUTHOR=${{ github.event.client_payload.comment_author }}
      - id: claude
        uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/discussion-respond.txt
          prompt_replacements: ${{ steps.build_respond_replacements.outputs.json }}
          max_turns: '100'
          show_full_output: 'true'
      - id: find_root
        name: Find thread root comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |2-
            # Query the comment to see if it has a parent (replyTo)
            comment_data=$(gh api graphql -f query='
              query($commentId: ID!) {
            node(id: $commentId) {
              ... on DiscussionComment {
                id
                replyTo {
                  id
                  replyTo {
                    id
                  }
                }
              }
            }
          }
            ' -f commentId="$COMMENT_ID")

            # Extract the root comment ID (walk up the replyTo chain)
            root_id=$(echo "$comment_data" | jq -r '
              .data.node
              | if .replyTo.replyTo.id then .replyTo.replyTo.id
                elif .replyTo.id then .replyTo.id
                else .id
                end
            ')

            echo "Original comment: $COMMENT_ID"
            echo "Root comment: $root_id"
            echo "root_comment_id=$root_id" >> $GITHUB_OUTPUT
      - id: post_response
        name: Post response comment
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
          REPLY_TO_ID: ${{ steps.find_root.outputs.root_comment_id }}
        run: |2-
            if [[ ! -f /tmp/discussion-response.md ]]; then
              echo "No response file found"
              exit 1
            fi

            gh api graphql -f query='
              mutation($discussionId: ID!, $replyToId: ID!, $body: String!) {
            addDiscussionComment(input: {
              discussionId: $discussionId
              replyToId: $replyToId
              body: $body
            }) {
              comment { id }
            }
          }
            ' -f discussionId="$DISCUSSION_ID" -f replyToId="$REPLY_TO_ID" -F body=@/tmp/discussion-response.md
      - id: upload_updated_body
        name: Upload updated body
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: discussion-updated-body-respond
          path: /tmp/discussion-updated-body.md
          if-no-files-found: ignore
      - id: add_success
        name: Add success reaction
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |-
          gh api graphql -f query='
            mutation($subjectId: ID!) {
              addReaction(input: {
                subjectId: $subjectId
                content: THUMBS_UP
              }) {
                reaction { id }
              }
            }
          ' -f subjectId="$COMMENT_ID"
      - id: handle_failure
        name: Handle failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
          ROOT_COMMENT_ID: ${{ steps.find_root.outputs.root_comment_id }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |2-
            # Add thumbs down to the original comment
            gh api graphql -f query='
              mutation($subjectId: ID!) {
                addReaction(input: {
                  subjectId: $subjectId
                  content: THUMBS_DOWN
                }) {
                  reaction { id }
                }
              }
            ' -f subjectId="$COMMENT_ID" || true

            # Post error as reply to the root comment in the thread
            gh api graphql -f query='
              mutation($discussionId: ID!, $replyToId: ID!, $body: String!) {
            addDiscussionComment(input: {
              discussionId: $discussionId
              replyToId: $replyToId
              body: $body
            }) {
              comment { id }
            }
          }
            ' -f discussionId="$DISCUSSION_ID" -f replyToId="${ROOT_COMMENT_ID:-$COMMENT_ID}" -f body="⚠️ **Failed to process your question**

            See [workflow run]($RUN_URL) for details."
    needs:
      - prepare
  research:
    if: github.event.client_payload.action_type == 'research'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: download_body
        name: Download original body
        uses: actions/download-artifact@v4
        with:
          name: discussion-original-body
          path: /tmp
      - id: build_research_replacements
        uses: ./.github/actions-ts/prompt-replacements
        with:
          pairs: |
            DISCUSSION_TITLE=${{ github.event.client_payload.discussion_title }}
            DISCUSSION_BODY=${{ github.event.client_payload.discussion_body }}
      - id: claude
        uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/discussion-research.txt
          prompt_replacements: ${{ steps.build_research_replacements.outputs.json }}
          max_turns: '30'
          show_full_output: 'true'
      - id: debug_files
        name: Debug - List created files
        if: always()
        run: |-
          echo "=== Files in /tmp ==="
          ls -la /tmp/research-thread-*.md 2>/dev/null || echo "No research-thread files found"
          ls -la /tmp/discussion-*.md 2>/dev/null || echo "No discussion files found"
          echo ""
          echo "=== Content of research thread files ==="
          for file in /tmp/research-thread-*.md; do
            if [[ -f "$file" ]]; then
              echo "--- $file ---"
              head -20 "$file"
              echo ""
            fi
          done
      - id: post_threads
        name: Post research thread comments
        if: always()
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
        run: |2-
            # Check if files exist
            if ! ls /tmp/research-thread-*.md 1> /dev/null 2>&1; then
              echo "ERROR: No research thread files found!"
              echo "The Claude agent should have created files like /tmp/research-thread-1.md"
              exit 1
            fi

            # Count files
            file_count=$(ls /tmp/research-thread-*.md 2>/dev/null | wc -l)
            echo "Found $file_count research thread files"

            # Post each research thread and collect comment IDs
            comment_ids=""
            comment_bodies=""

            for file in /tmp/research-thread-*.md; do
              if [[ -f "$file" ]]; then
                echo "Posting research thread: $file"

                # Post comment and capture the comment ID
                comment_result=$(gh api graphql -f query='
                  mutation($discussionId: ID!, $body: String!) {
            addDiscussionComment(input: {
              discussionId: $discussionId
              body: $body
            }) {
              comment { id }
            }
          }
                ' -f discussionId="$DISCUSSION_ID" -F body=@"$file")

                comment_id=$(echo "$comment_result" | jq -r '.data.addDiscussionComment.comment.id')
                echo "Posted comment: $comment_id"

                # Store comment data for dispatch step
                # Use base64 to safely encode the body
                encoded_body=$(cat "$file" | base64 -w 0)
                echo "${comment_id}:${encoded_body}" >> /tmp/posted_comments.txt

                # Small delay between posts
                sleep 2
              fi
            done

            echo "Successfully posted $file_count research threads"
            echo "Comments posted with PAT - webhooks will trigger dispatcher automatically"
      - id: upload_updated_body
        name: Upload updated body
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: discussion-updated-body-research
          path: /tmp/discussion-updated-body.md
          if-no-files-found: ignore
    needs:
      - prepare
  plan:
    if: github.event.client_payload.action_type == 'plan'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      issues: write
      id-token: write
    steps:
      - id: checkout
        uses: actions/checkout@v4
      - id: download_body
        name: Download original body
        uses: actions/download-artifact@v4
        with:
          name: discussion-original-body
          path: /tmp
      - id: build_plan_replacements
        uses: ./.github/actions-ts/prompt-replacements
        with:
          pairs: |
            DISCUSSION_NUMBER=${{ github.event.client_payload.discussion_number }}
      - id: claude
        uses: ./.github/actions/run-claude
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt_file: .github/prompts/discussion-plan.txt
          prompt_replacements: ${{ steps.build_plan_replacements.outputs.json }}
          max_turns: '100'
          show_full_output: 'true'
      - id: find_root
        name: Find thread root comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |2-
            # Query the comment to see if it has a parent (replyTo)
            comment_data=$(gh api graphql -f query='
              query($commentId: ID!) {
            node(id: $commentId) {
              ... on DiscussionComment {
                id
                replyTo {
                  id
                  replyTo {
                    id
                  }
                }
              }
            }
          }
            ' -f commentId="$COMMENT_ID")

            # Extract the root comment ID (walk up the replyTo chain)
            root_id=$(echo "$comment_data" | jq -r '
              .data.node
              | if .replyTo.replyTo.id then .replyTo.replyTo.id
                elif .replyTo.id then .replyTo.id
                else .id
                end
            ')

            echo "Original comment: $COMMENT_ID"
            echo "Root comment: $root_id"
            echo "root_comment_id=$root_id" >> $GITHUB_OUTPUT
      - id: post_plan
        name: Post plan summary comment
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
          REPLY_TO_ID: ${{ steps.find_root.outputs.root_comment_id }}
        run: |2-
            if [[ ! -f /tmp/discussion-plan-summary.md ]]; then
              echo "No plan summary file found"
              exit 1
            fi

            gh api graphql -f query='
              mutation($discussionId: ID!, $replyToId: ID!, $body: String!) {
            addDiscussionComment(input: {
              discussionId: $discussionId
              replyToId: $replyToId
              body: $body
            }) {
              comment { id }
            }
          }
            ' -f discussionId="$DISCUSSION_ID" -f replyToId="$REPLY_TO_ID" -F body=@/tmp/discussion-plan-summary.md
      - id: upload_updated_body
        name: Upload updated body
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: discussion-updated-body-plan
          path: /tmp/discussion-updated-body.md
          if-no-files-found: ignore
    needs:
      - prepare
  complete:
    if: github.event.client_payload.action_type == 'complete'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    steps:
      - id: add_rocket
        name: Add rocket reaction
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |-
          gh api graphql -f query='
            mutation($subjectId: ID!) {
              addReaction(input: {
                subjectId: $subjectId
                content: ROCKET
              }) {
                reaction { id }
              }
            }
          ' -f subjectId="$COMMENT_ID"
      - id: post_completion
        name: Post completion message
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
        run: |2-
            gh api graphql -f query='
              mutation($discussionId: ID!, $body: String!) {
            addDiscussionComment(input: {
              discussionId: $discussionId
              body: $body
            }) {
              comment { id }
            }
          }
            ' -f discussionId="$DISCUSSION_ID" -f body="✅ **This discussion thread has been marked as complete.**

            If you have additional questions, feel free to post a new comment!"
    needs:
      - prepare
  update-description:
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    permissions:
      discussions: write
    steps:
      - id: download_updated_body
        name: Download updated body (try all sources)
        uses: actions/download-artifact@v4
        with:
          pattern: discussion-updated-body-*
          merge-multiple: true
          path: /tmp/updated-bodies
        continue-on-error: true
      - id: apply_updated_body
        name: Find and apply updated body
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
        run: |2-
            # Find any updated body file
            if [[ -d /tmp/updated-bodies ]]; then
              updated_file=$(find /tmp/updated-bodies -name "*.md" -type f | head -1)
            fi

            if [[ -z "$updated_file" || ! -f "$updated_file" ]]; then
              echo "No updated body file found, skipping description update"
              exit 0
            fi

            echo "Found updated body: $updated_file"

            gh api graphql -f query='
              mutation($discussionId: ID!, $body: String!) {
            updateDiscussion(input: {
              discussionId: $discussionId
              body: $body
            }) {
              discussion { id }
            }
          }
            ' -f discussionId="$DISCUSSION_ID" -F body=@"$updated_file"

            echo "✅ Discussion description updated"
    needs:
      - prepare
      - summarize
      - respond
      - research
      - plan
