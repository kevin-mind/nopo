name: Discussion Handler

# Handles discussion events dispatched from discussion-dispatcher.yml
# Uses repository_dispatch which IS supported by claude-code-action

on:
  repository_dispatch:
    types: [discussion_event]

permissions:
  contents: read
  discussions: write
  issues: write
  id-token: write

jobs:
  #############################################################################
  # PREPARE - Get discussion ID and add reactions
  #############################################################################

  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    outputs:
      discussion_id: ${{ steps.get_id.outputs.discussion_id }}
      action_type: ${{ github.event.client_payload.action_type }}
    steps:
      - name: Get discussion ID
        id: get_id
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_NUMBER: ${{ github.event.client_payload.discussion_number }}
        run: |
          discussion_data=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                discussion(number: $number) {
                  id
                }
              }
            }
          ' -f owner="${GITHUB_REPOSITORY%/*}" -f repo="${GITHUB_REPOSITORY#*/}" -F number="$DISCUSSION_NUMBER")

          discussion_id=$(echo "$discussion_data" | jq -r '.data.repository.discussion.id')
          echo "discussion_id=$discussion_id" >> $GITHUB_OUTPUT

      - name: Add eyes reaction if responding
        if: github.event.client_payload.action_type == 'respond'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |
          gh api graphql -f query='
            mutation($subjectId: ID!) {
              addReaction(input: {
                subjectId: $subjectId
                content: EYES
              }) {
                reaction { id }
              }
            }
          ' -f subjectId="$COMMENT_ID"

  #############################################################################
  # SUMMARIZE - Triggered by /summarize command
  #############################################################################

  summarize:
    needs: prepare
    if: github.event.client_payload.action_type == 'summarize'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          prompt: |
            You are summarizing Discussion #${{ github.event.client_payload.discussion_number }}.

            ## Your Task

            1. Fetch the full discussion content using:
            ```bash
            gh api graphql -f query='
              query {
                repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") {
                  discussion(number: ${{ github.event.client_payload.discussion_number }}) {
                    title
                    body
                    comments(first: 100) {
                      nodes {
                        body
                        author { login }
                        replies(first: 100) {
                          nodes {
                            body
                            author { login }
                          }
                        }
                      }
                    }
                  }
                }
              }
            '
            ```

            2. Analyze all comments and organize into:
            - **Key Findings**: Main discoveries and insights
            - **Questions Answered**: Q&A pairs from the discussion
            - **Open Items**: Unresolved questions or pending topics
            - **Next Steps**: Recommended actions

            ## IMPORTANT: Always Post Your Summary

            After analyzing the discussion, you MUST post a comprehensive summary as a comment:
            ```
            gh api graphql -f query='
              mutation($discussionId: ID!, $body: String!) {
                addDiscussionComment(input: {
                  discussionId: $discussionId
                  body: $body
                }) {
                  comment { id }
                }
              }
            ' -f discussionId="${{ needs.prepare.outputs.discussion_id }}" -f body="## üìã Discussion Summary

            <organized summary with Key Findings, Questions Answered, Open Items, Next Steps>"
            ```

            NEVER leave the discussion without posting the summary - the summary must be visible as a comment.
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 50"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  #############################################################################
  # RESPOND - Answer human comments
  #############################################################################

  respond:
    needs: prepare
    if: github.event.client_payload.action_type == 'respond'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          prompt: |
            You are responding to a user's question on Discussion #${{ github.event.client_payload.discussion_number }}.

            **User's Question:** ${{ github.event.client_payload.comment_body }}
            **Author:** @${{ github.event.client_payload.comment_author }}

            ## Your Task

            Research the question thoroughly:
            1. Search the codebase (grep, glob, read) to find relevant code
            2. Search GitHub (`gh issue list`, `gh pr list`) for related discussions
            3. Check documentation (decisions/, AGENTS.md, README.md)
            4. Web search if helpful for understanding external concepts

            Then provide a clear, helpful answer with:
            - Relevant code snippets with file paths (e.g., `src/file.ts:42`)
            - Citations from your research
            - Clear, actionable guidance
            - If they're asking for implementation, suggest: "Use `/plan` to create issues, then assign nopo-bot"

            ## IMPORTANT: Always Post Your Response

            After completing your research, you MUST post your answer as a reply using this command:
            ```
            gh api graphql -f query='
              mutation($replyToId: ID!, $body: String!) {
                addDiscussionComment(input: {
                  replyToId: $replyToId
                  body: $body
                }) {
                  comment { id }
                }
              }
            ' -f replyToId="${{ github.event.client_payload.comment_id }}" -f body="<your detailed answer with code examples and citations>"
            ```

            NEVER leave the discussion without a visible response - your analysis must be posted as a reply comment.
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 100"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add success reaction
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |
          gh api graphql -f query='
            mutation($subjectId: ID!) {
              addReaction(input: {
                subjectId: $subjectId
                content: THUMBS_UP
              }) {
                reaction { id }
              }
            }
          ' -f subjectId="$COMMENT_ID"

      - name: Handle failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # Add thumbs down
          gh api graphql -f query='
            mutation($subjectId: ID!) {
              addReaction(input: {
                subjectId: $subjectId
                content: THUMBS_DOWN
              }) {
                reaction { id }
              }
            }
          ' -f subjectId="$COMMENT_ID" || true

          # Post error as reply
          gh api graphql -f query='
            mutation($replyToId: ID!, $body: String!) {
              addDiscussionComment(input: {
                replyToId: $replyToId
                body: $body
              }) {
                comment { id }
              }
            }
          ' -f replyToId="$COMMENT_ID" -f body="‚ö†Ô∏è **Failed to process your question**

          See [workflow run]($RUN_URL) for details."

  #############################################################################
  # RESEARCH - Triggered by new discussion creation
  #############################################################################

  research:
    needs: prepare
    if: github.event.client_payload.action_type == 'research'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          prompt: |
            A new discussion was created: **${{ github.event.client_payload.discussion_title }}**

            **Discussion body:**
            ${{ github.event.client_payload.discussion_body }}

            ## Your Task

            Perform vigorous research on this topic:
            1. Search the codebase (grep, glob, read) to find relevant code and patterns
            2. Search GitHub (`gh issue list`, `gh pr list`) for related discussions
            3. Check documentation (decisions/, AGENTS.md, README.md)
            4. Web search for external concepts or best practices (if needed)

            Identify major research areas and create one top-level comment for each area (e.g., Architecture, Implementation Patterns, Related Work, Code Examples).

            ## IMPORTANT: Always Post Multiple Research Threads

            For EACH major research area you identify, post a separate top-level comment:
            ```
            gh api graphql -f query='
              mutation($discussionId: ID!, $body: String!) {
                addDiscussionComment(input: {
                  discussionId: $discussionId
                  body: $body
                }) {
                  comment { id }
                }
              }
            ' -f discussionId="${{ needs.prepare.outputs.discussion_id }}" -f body="## Research: <Topic Name>

            <your detailed research findings with code snippets (file.ts:42) and citations>"
            ```

            Post at least 2-3 research threads. Each should be focused on a single topic.

            NEVER leave the discussion without posting research findings - your analysis must be visible as multiple top-level comments.
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 100"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  #############################################################################
  # PLAN - Create GitHub issues from discussion
  #############################################################################

  plan:
    needs: prepare
    if: github.event.client_payload.action_type == 'plan'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          settings: ".claude/settings.json"
          prompt: |
            A user requested a plan for Discussion #${{ github.event.client_payload.discussion_number }}.

            ## Your Task

            1. Fetch the full discussion content:
            ```bash
            gh api graphql -f query='
              query {
                repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") {
                  discussion(number: ${{ github.event.client_payload.discussion_number }}) {
                    title
                    body
                    comments(first: 100) {
                      nodes {
                        body
                        author { login }
                        replies(first: 100) {
                          nodes {
                            body
                            author { login }
                          }
                        }
                      }
                    }
                  }
                }
              }
            '
            ```

            2. Search the codebase to understand current architecture and identify where changes are needed

            3. Extract actionable items and create GitHub issues for each:
            ```bash
            gh issue create \
              --title "Your Issue Title" \
              --body "Related to discussion: #${{ github.event.client_payload.discussion_number }}

            ## Context
            [Context from discussion]

            ## Tasks
            - [ ] Task 1
            - [ ] Task 2" \
              --label "discussion:${{ github.event.client_payload.discussion_number }}"
            ```

            ## IMPORTANT: Always Post Summary

            After creating issues, post a summary as a reply to the /plan command:
            ```
            gh api graphql -f query='
              mutation($replyToId: ID!, $body: String!) {
                addDiscussionComment(input: {
                  replyToId: $replyToId
                  body: $body
                }) {
                  comment { id }
                }
              }
            ' -f replyToId="${{ github.event.client_payload.comment_id }}" -f body="## üìã Created Issues

            I've created the following issues based on this discussion:

            - #<number> - <title>

            Assign nopo-bot to any of these issues to have me implement them."
            ```

            NEVER leave the discussion without posting the summary - it must be visible as a reply comment.
          claude_args: "--model claude-opus-4-5-20251101 --max-turns 100"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  #############################################################################
  # COMPLETE - Mark discussion thread as complete
  #############################################################################

  complete:
    needs: prepare
    if: github.event.client_payload.action_type == 'complete'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write
      id-token: write
    steps:
      - name: Add rocket reaction
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_ID: ${{ github.event.client_payload.comment_id }}
        run: |
          gh api graphql -f query='
            mutation($subjectId: ID!) {
              addReaction(input: {
                subjectId: $subjectId
                content: ROCKET
              }) {
                reaction { id }
              }
            }
          ' -f subjectId="$COMMENT_ID"

      - name: Post completion message
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCUSSION_ID: ${{ needs.prepare.outputs.discussion_id }}
        run: |
          gh api graphql -f query='
            mutation($discussionId: ID!, $body: String!) {
              addDiscussionComment(input: {
                discussionId: $discussionId
                body: $body
              }) {
                comment { id }
              }
            }
          ' -f discussionId="$DISCUSSION_ID" -f body="‚úÖ **This discussion thread has been marked as complete.**

          If you have additional questions, feel free to post a new comment!"
