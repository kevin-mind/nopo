name: Claude CI Pass Handler

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

concurrency:
  group: claude-ci-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: write

jobs:
  move-to-review:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Find PR and linked issue
        id: find
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          # Find PR for this branch
          pr=$(gh pr list --repo "$GITHUB_REPOSITORY" --head "$HEAD_BRANCH" --json number,body,author --jq '.[0]')

          if [[ -z "$pr" ]]; then
            echo "No PR found for branch $HEAD_BRANCH"
            echo "has_pr=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          pr_number=$(echo "$pr" | jq -r '.number')
          pr_body=$(echo "$pr" | jq -r '.body')
          author=$(echo "$pr" | jq -r '.author.login')

          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT

          # Only process PRs created by Claude automation
          if [[ "$author" != "claude[bot]" ]]; then
            echo "Skipping - PR not created by Claude automation"
            echo "has_pr=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_pr=true" >> $GITHUB_OUTPUT

          # Extract linked issue from "Fixes #N" pattern
          issue_number=$(echo "$pr_body" | grep -oP 'Fixes #\K\d+' | head -1 || true)

          if [[ -z "$issue_number" ]]; then
            echo "No linked issue found in PR body"
            echo "has_issue=false" >> $GITHUB_OUTPUT
          else
            echo "Found linked issue #$issue_number"
            echo "has_issue=true" >> $GITHUB_OUTPUT
            echo "issue_number=$issue_number" >> $GITHUB_OUTPUT
          fi

      - name: Check for unresolved comments
        if: steps.find.outputs.has_pr == 'true'
        id: comments
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.find.outputs.pr_number }}
        run: |
          # Get all review threads and check for unresolved ones
          unresolved=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $pr: Int!) {
              repository(owner: $owner, name: $repo) {
                pullRequest(number: $pr) {
                  reviewThreads(first: 100) {
                    nodes {
                      isResolved
                      isOutdated
                    }
                  }
                }
              }
            }
          ' -f owner="${GITHUB_REPOSITORY_OWNER}" -f repo="${GITHUB_REPOSITORY#*/}" -F pr="$PR_NUMBER")

          # Count unresolved threads (excluding outdated ones)
          unresolved_count=$(echo "$unresolved" | jq '[.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false and .isOutdated == false)] | length')

          echo "Unresolved comment threads: $unresolved_count"

          if [[ "$unresolved_count" -gt 0 ]]; then
            echo "has_unresolved=true" >> $GITHUB_OUTPUT
            echo "unresolved_count=$unresolved_count" >> $GITHUB_OUTPUT
          else
            echo "has_unresolved=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if unresolved comments
        if: steps.comments.outputs.has_unresolved == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.find.outputs.pr_number }}
          UNRESOLVED_COUNT: ${{ steps.comments.outputs.unresolved_count }}
        run: |
          echo "Skipping move to Review - $UNRESOLVED_COUNT unresolved comment thread(s)"

          # Add a comment to the PR
          gh pr comment "$PR_NUMBER" --body "⏸️ **CI passed but not moving to Review**

          There are **$UNRESOLVED_COUNT unresolved comment thread(s)** on this PR.

          Please resolve all comments before the PR can move to Review status."

      - name: Update project status to Review
        if: steps.find.outputs.has_issue == 'true' && steps.comments.outputs.has_unresolved != 'true'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.find.outputs.issue_number }}
        run: |
          # Get the issue's project item
          issue_data=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $number) {
                  id
                  projectItems(first: 10) {
                    nodes {
                      id
                      project { id }
                    }
                  }
                }
              }
            }
          ' -f owner="${GITHUB_REPOSITORY_OWNER}" -f repo="${GITHUB_REPOSITORY#*/}" -F number="$ISSUE_NUMBER")

          item_id=$(echo "$issue_data" | jq -r '.data.repository.issue.projectItems.nodes[0].id // empty')
          project_id=$(echo "$issue_data" | jq -r '.data.repository.issue.projectItems.nodes[0].project.id // empty')

          if [[ -z "$item_id" || "$item_id" == "null" ]]; then
            echo "Issue #$ISSUE_NUMBER not linked to any project"
            exit 0
          fi

          echo "Found project item: $item_id in project: $project_id"

          # Get Status field and Review option IDs
          fields=$(gh api graphql -f query='
            query($projectId: ID!) {
              node(id: $projectId) {
                ... on ProjectV2 {
                  fields(first: 20) {
                    nodes {
                      ... on ProjectV2SingleSelectField {
                        id
                        name
                        options { id name }
                      }
                    }
                  }
                }
              }
            }
          ' -f projectId="$project_id")

          echo "Available fields and options:"
          echo "$fields" | jq '.data.node.fields.nodes[] | select(.options != null) | {name: .name, options: [.options[].name]}'

          field_id=$(echo "$fields" | jq -r '.data.node.fields.nodes[] | select(.name == "Status") | .id')
          option_id=$(echo "$fields" | jq -r '.data.node.fields.nodes[] | select(.name == "Status") | .options[] | select(.name == "In review") | .id')

          if [[ -z "$field_id" || -z "$option_id" ]]; then
            echo "Could not find Status field or Review option"
            echo "Looking for field 'Status' and option 'Review'"
            exit 0
          fi

          # Update to Review status
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(
                input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { singleSelectOptionId: $optionId }
                }
              ) { projectV2Item { id } }
            }
          ' -f projectId="$project_id" -f itemId="$item_id" -f fieldId="$field_id" -f optionId="$option_id"

          echo "Updated issue #$ISSUE_NUMBER to Review status"

      - name: Convert PR to ready and trigger Claude review
        if: steps.find.outputs.has_pr == 'true' && steps.comments.outputs.has_unresolved != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.find.outputs.pr_number }}
        run: |
          # Convert from draft to ready for review
          gh pr ready "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" || true
          echo "Marked PR #$PR_NUMBER as ready for review"

          # Add the review-ready label
          gh pr edit "$PR_NUMBER" --add-label "review-ready" || true
          echo "Added review-ready label to PR #$PR_NUMBER"

          # Trigger Claude review workflow
          gh workflow run claude-review.yml -f pr_number="$PR_NUMBER" --repo "$GITHUB_REPOSITORY"
          echo "Triggered Claude review for PR #$PR_NUMBER"
