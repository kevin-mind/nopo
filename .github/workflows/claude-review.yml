name: Claude Review

on:
  pull_request:
    types: [opened, synchronize, labeled]

permissions:
  contents: read
  pull-requests: write
  issues: read
  id-token: write

jobs:
  extract-issue:
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.extract.outputs.issue_number }}
      issue_body: ${{ steps.extract.outputs.issue_body }}
      has_issue: ${{ steps.extract.outputs.has_issue }}
    steps:
      - name: Extract linked issue
        id: extract
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Extract linked issue from "Fixes #N" pattern
          issue_number=$(echo "$PR_BODY" | grep -oP 'Fixes #\K\d+' | head -1 || true)

          if [[ -n "$issue_number" ]]; then
            echo "has_issue=true" >> $GITHUB_OUTPUT
            echo "issue_number=$issue_number" >> $GITHUB_OUTPUT

            # Get issue body
            issue_body=$(gh issue view "$issue_number" --json body --jq '.body')
            echo "issue_body<<EOF" >> $GITHUB_OUTPUT
            echo "$issue_body" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_issue=false" >> $GITHUB_OUTPUT
          fi

  review-with-issue:
    needs: extract-issue
    if: needs.extract-issue.outputs.has_issue == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Review this pull request and validate against the linked issue.

            ## Linked Issue #${{ needs.extract-issue.outputs.issue_number }}

            ${{ needs.extract-issue.outputs.issue_body }}

            ## Validation Checklist
            1. CHECK ALL TODO ITEMS in the issue are addressed by this PR
            2. VERIFY code follows CLAUDE.md guidelines
            3. ENSURE tests cover the requirements
            4. CHECK for any regressions or breaking changes
            5. VALIDATE the PR description accurately reflects changes

            ## Review Instructions

            Perform a thorough code review checking:
            - Code quality and best practices
            - Potential bugs or issues
            - Test coverage adequacy

            After review:
            - If ALL requirements are met and code is good: APPROVE the PR
            - If changes are needed: REQUEST CHANGES with specific feedback
            - If questions need answers: Leave COMMENTS asking for clarification

            IMPORTANT: You may APPROVE the PR but you must NOT merge it.
            A human will review and merge the PR.
          claude_args: "--model claude-opus-4-5-20251101"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  review-without-issue:
    needs: extract-issue
    if: needs.extract-issue.outputs.has_issue != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Review this pull request. No linked issue found - performing standard code review.

            ## Review Instructions

            Perform a thorough code review checking:
            - Code quality and best practices
            - Potential bugs or issues
            - Test coverage adequacy

            After review:
            - If code is good: APPROVE the PR
            - If changes are needed: REQUEST CHANGES with specific feedback
            - If questions need answers: Leave COMMENTS asking for clarification

            IMPORTANT: You may APPROVE the PR but you must NOT merge it.
            A human will review and merge the PR.
          claude_args: "--model claude-opus-4-5-20251101"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
