name: Claude Review

on:
  pull_request:
    types: [review_requested]

concurrency:
  group: claude-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write
  issues: read
  id-token: write

jobs:
  extract-issue:
    runs-on: ubuntu-latest
    # Only run when Claude is requested as reviewer AND PR is ready (not draft)
    if: |
      github.event.requested_reviewer.login == 'claude[bot]' &&
      github.event.pull_request.draft == false
    outputs:
      issue_number: ${{ steps.extract.outputs.issue_number }}
      issue_body: ${{ steps.extract.outputs.issue_body }}
      has_issue: ${{ steps.extract.outputs.has_issue }}
    steps:
      - name: Extract linked issue
        id: extract
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Extract linked issue from "Fixes #N" pattern
          issue_number=$(echo "$PR_BODY" | grep -oP 'Fixes #\K\d+' | head -1 || true)

          if [[ -n "$issue_number" ]]; then
            echo "has_issue=true" >> $GITHUB_OUTPUT
            echo "issue_number=$issue_number" >> $GITHUB_OUTPUT

            # Get issue body
            issue_body=$(gh issue view "$issue_number" --json body --jq '.body')
            echo "issue_body<<EOF" >> $GITHUB_OUTPUT
            echo "$issue_body" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_issue=false" >> $GITHUB_OUTPUT
          fi

  review:
    needs: extract-issue
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are reviewing PR #${{ github.event.pull_request.number }}.

            ${{ needs.extract-issue.outputs.has_issue == 'true' && format('## Linked Issue #{0}

            {1}

            ## Validation
            - CHECK ALL TODO ITEMS in the issue are addressed
            - VERIFY code follows CLAUDE.md guidelines
            - ENSURE tests cover the requirements

            ', needs.extract-issue.outputs.issue_number, needs.extract-issue.outputs.issue_body) || '## No Linked Issue
            Performing standard code review.

            ' }}
            ## Step 1: Check Existing Review Comments

            First, check for existing unresolved review comments on this PR:
            ```
            gh api /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments
            ```

            For each unresolved comment thread:
            - If the conversation is COMPLETE (question answered satisfactorily, changes made, or valid pushback accepted): Resolve the thread
            - If more information is needed: Leave unresolved for continued discussion
            - If changes were requested and made: Verify the fix and resolve if good

            ## Step 2: Review the Code

            Perform a thorough code review:
            - Code quality and best practices
            - Potential bugs or edge cases
            - Test coverage adequacy
            - Security considerations

            ## Step 3: Submit a Batch Review

            Submit your review using `gh pr review` with ONE of:
            - `--approve` if ALL requirements met and code is good
            - `--request-changes` if changes are needed (include inline comments)
            - `--comment` if you have questions but no blocking issues

            Include inline comments for specific feedback on code lines.
            Include an overall review message summarizing your assessment.

            IMPORTANT:
            - You may APPROVE but must NOT merge
            - A human will make the final merge decision
          claude_args: "--model claude-opus-4-5-20251101"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
