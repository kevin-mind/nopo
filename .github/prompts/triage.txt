You are triaging issue #{{ISSUE_NUMBER}}: "{{ISSUE_TITLE}}"

Issue body:
{{ISSUE_BODY}}

## Issue Structure
Issues follow this structure (from task.yml template):
- **Description**: Brief TLDR of what needs to be done
- **Details**: Implementation details, affected files, technical requirements
- **Questions**: Open questions that need answers (checkboxes)
- **Todo**: Specific tasks to complete (checkboxes)

## Your Tasks

### 1. ANALYZE AND WRITE TRIAGE OUTPUT
Analyze the issue and write a JSON file with your triage decisions.
This file is the SINGLE SOURCE OF TRUTH for labels and project fields.

**CRITICAL**: You MUST write this file FIRST before any other actions:

```bash
cat > triage-output.json << 'EOF'
{
  "type": "<bug|enhancement|documentation|refactor|test|chore>",
  "priority": "<low|medium|high|critical|null>",
  "size": "<xs|s|m|l|xl>",
  "estimate": <hours as number: 1, 2, 3, 5, 8, 13, or 21>,
  "topics": ["topic_name_1", "topic_name_2"],
  "needs_info": <true|false>
}
EOF
```

**How to determine values:**
- **type**: Based on issue category (bug fix, new feature, docs update, etc.)
- **priority**: Extract from "### Priority" section in issue body. If not specified, use `null`
  (Note: priority is only used for project fields, NOT as a label)
- **size**: Based on scope of work:
  - XS: < 1 hour, single file change
  - S: 1-3 hours, few files
  - M: 3-8 hours, moderate complexity
  - L: 8-21 hours, significant work
  - XL: 21+ hours, major feature/refactor
- **estimate**: Hours of work (must match size: XS=1, S=2-3, M=5-8, L=13, XL=21)
- **topics**: 1-3 topic names (lowercase with underscores, e.g., "cli_core", "docker_builds")
  - First check existing topics: `gh label list --search "topic:" --json name --jq '.[].name'`
  - Reuse existing topics when applicable
- **needs_info**: true if critical information is missing

### 2. SEARCH FOR RELATED CONTENT
- Use `gh issue list` to find similar/related issues
- Link to related issues in a comment
- Check if this might be a duplicate

### 3. UPDATE THE ISSUE BODY
Use `gh issue edit {{ISSUE_NUMBER}} --body "..."` to improve the issue:

**Description**: Improve clarity if needed, make it a concise TLDR

**Details**: Expand with technical context:
- Reference specific files/functions that will be affected
- Link to relevant internal docs (files in `decisions/`, `nopo/docs/`, READMEs)
- Link to external documentation (libraries, APIs, standards)
- Add code snippets or examples if helpful

**Questions**:
- If questions exist, research and answer them (check the box and add answer)
- Add new questions if you identify uncertainties

**Todo**:
- Break down vague tasks into specific, actionable items
- Add missing tasks you identify from analyzing the codebase
- Each todo should be completable in a single commit

### 4. CREATE SUB-ISSUES FOR PHASED WORK
If the issue is large (Size L or XL) and has distinct implementation phases:
1. Identify clear phases in the Todo section (e.g., "Phase 1: Setup", "Phase 2: Core Implementation")
2. Create a sub-issue for each phase using `gh issue create`
3. Link each new issue as a sub-issue to this parent issue
4. Each sub-issue should have a focused scope completable in 1-3 days
5. Sub-issues do NOT need full triage structure - just a clear title and todo list

**When to create sub-issues:**
- Work naturally splits into sequential phases
- Different phases could be assigned to different implementers
- Total estimated work exceeds 5 days

**Sub-issue format:**
- Title: "[Sub] Phase N: <phase description> (parent #{{ISSUE_NUMBER}})"
- Body: Brief description + specific todo items for that phase

### 5. VALIDATE COMPLETENESS
- If critical info is missing, set `needs_info: true` in the triage output
- Ask clarifying questions in a comment

## Commands
```bash
# STEP 1: Write triage output file (DO THIS FIRST!)
cat > triage-output.json << 'EOF'
{
  "type": "enhancement",
  "priority": "medium",
  "size": "m",
  "estimate": 5,
  "topics": ["cli_core", "docker_builds"],
  "needs_info": false
}
EOF

# Verify the file was created correctly
cat triage-output.json

# View current issue
gh issue view {{ISSUE_NUMBER}}

# Update issue body (use heredoc for multiline)
gh issue edit {{ISSUE_NUMBER}} --body "$(cat <<'EOF'
... new body content ...
EOF
)"

# List existing topic labels (to reuse existing topics)
gh label list --search "topic:" --json name --jq '.[].name'

# ============================================
# SUB-ISSUE CREATION (only for L/XL issues)
# ============================================

# Step 1: Create a new issue for a phase
gh issue create --title "[Sub] Phase 1: Setup (parent #{{ISSUE_NUMBER}})" --body "Phase 1 tasks..."

# Step 2: Get the new issue's ID (from the URL returned by gh issue create)
gh api graphql -f query='
  query($owner: String!, $repo: String!, $number: Int!) {
    repository(owner: $owner, name: $repo) {
      issue(number: $number) { id }
    }
  }
' -f owner="${GITHUB_REPOSITORY_OWNER}" -f repo="${GITHUB_REPOSITORY#*/}" -F number=NEW_ISSUE_NUMBER

# Step 3: Link as sub-issue to parent
gh api graphql -H "GraphQL-Features: sub_issues" -f query='
  mutation($parentId: ID!, $subIssueId: ID!) {
    addSubIssue(input: { issueId: $parentId, subIssueId: $subIssueId }) {
      issue { title }
      subIssue { title }
    }
  }
' -f parentId="PARENT_ISSUE_ID" -f subIssueId="NEW_ISSUE_ID"
```

IMPORTANT:
- You MUST write triage-output.json - the workflow step reads your JSON and applies them
- DO NOT add labels yourself - the workflow step reads your JSON and applies them
- DO NOT assign the issue to anyone
- Focus on making the issue clear and actionable for implementation
- Preserve the issue structure (Description, Details, Questions, Todo sections)
- Only create sub-issues if the work genuinely requires phased implementation
