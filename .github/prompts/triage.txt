You are triaging issue #{{ISSUE_NUMBER}}: "{{ISSUE_TITLE}}"

Issue body:
{{ISSUE_BODY}}

## Issue Structure
Issues follow this structure (from task.yml template):
- **Description**: Brief TLDR of what needs to be done
- **Details**: Implementation details, affected files, technical requirements
- **Questions**: Open questions that need answers (checkboxes)
- **Phases**: For M/L/XL issues, break into phases (## Phase 1: Title, ## Phase 2: Title, etc.)
  - Each phase has its own todos and ships as a separate PR
  - For XS/S issues, a single "## Todo" section is fine

## Your Tasks

### 1. ANALYZE AND WRITE TRIAGE OUTPUT
Analyze the issue and write a JSON file with your triage decisions.
This file is the SINGLE SOURCE OF TRUTH for labels and project fields.

**CRITICAL**: You MUST write this file FIRST before any other actions:

```bash
cat > triage-output.json << 'EOF'
{
  "type": "<bug|enhancement|documentation|refactor|test|chore>",
  "priority": "<low|medium|high|critical|null>",
  "size": "<xs|s|m|l|xl>",
  "estimate": <hours as number: 1, 2, 3, 5, 8, 13, or 21>,
  "topics": ["topic_name_1", "topic_name_2"],
  "needs_info": <true|false>
}
EOF
```

**How to determine values:**
- **type**: Based on issue category (bug fix, new feature, docs update, etc.)
- **priority**: Extract from "### Priority" section in issue body. If not specified, use `null`
  (Note: priority is only used for project fields, NOT as a label)
- **size**: Based on scope of work:
  - XS: < 1 hour, single file change
  - S: 1-3 hours, few files
  - M: 3-8 hours, moderate complexity
  - L: 8-21 hours, significant work
  - XL: 21+ hours, major feature/refactor
- **estimate**: Hours of work (must match size: XS=1, S=2-3, M=5-8, L=13, XL=21)
- **topics**: 1-3 topic names (lowercase with underscores, e.g., "cli_core", "docker_builds")
  - First check existing topics: `gh label list --search "topic:" --json name --jq '.[].name'`
  - Reuse existing topics when applicable
- **needs_info**: true if critical information is missing

### 2. SEARCH FOR RELATED CONTENT
- Use `gh issue list` to find similar/related issues
- Link to related issues in a comment
- Check if this might be a duplicate

### 3. UPDATE THE ISSUE BODY
Use `gh issue edit {{ISSUE_NUMBER}} --body "..."` to improve the issue:

**Description**: Improve clarity if needed, make it a concise TLDR

**Details**: Expand with technical context:
- Reference specific files/functions that will be affected
- Link to relevant internal docs (files in `decisions/`, `nopo/docs/`, READMEs)
- Link to external documentation (libraries, APIs, standards)
- Add code snippets or examples if helpful

**Questions**:
- If questions exist, research and answer them (check the box and add answer)
- Add new questions if you identify uncertainties

**Todo - PHASE-BASED STRUCTURE**:
Break work into **phases** (up to 5) where each phase is independently shippable.
This enables incremental PRs - Claude ships one PR per phase, merges, then continues.

**Phase structure format** (REQUIRED for M/L/XL issues):
```markdown
## Phase 1: <Phase Title>
- [ ] Specific task 1
- [ ] Specific task 2

## Phase 2: <Phase Title>
- [ ] Specific task 3
- [ ] Specific task 4
```

**Phase design principles:**
- Each phase should be **independently shippable** (no broken states after merge)
- Phase 1 often: schema changes, interfaces, types, config
- Middle phases: core implementation, one feature at a time
- Final phase: integration, cleanup, documentation
- 2-5 phases is ideal; single-phase is fine for XS/S issues

**Good phase breakdown example:**
```markdown
## Phase 1: Database Schema
- [ ] Add new migration for user_preferences table
- [ ] Create UserPreference model

## Phase 2: API Endpoints
- [ ] Add GET /api/preferences endpoint
- [ ] Add PUT /api/preferences endpoint
- [ ] Add unit tests for endpoints

## Phase 3: Frontend Integration
- [ ] Add preferences page component
- [ ] Wire up API calls
- [ ] Add E2E test for preferences flow
```

**Bad phase breakdown (avoid):**
- Phases that can't be merged independently
- Too granular (10+ phases)
- Phases without clear completion criteria

**If work cannot fit in 5 phases:**
If the issue is too large to break into 5 or fewer phases, DO NOT create sub-issues.
Instead, post a comment suggesting the user split the work into smaller, focused issues:

```markdown
This issue is too large to implement in 5 phases. I recommend splitting it into smaller issues:

1. **Issue 1: <suggested title>** - <brief scope>
2. **Issue 2: <suggested title>** - <brief scope>
3. **Issue 3: <suggested title>** - <brief scope>

Each of these can then be triaged and implemented independently with their own phase structure.
Please close this issue and create the smaller issues, or narrow the scope of this issue.
```

Set `needs_info: true` in the triage output when suggesting a split.

### 4. VALIDATE COMPLETENESS
- If critical info is missing, set `needs_info: true` in the triage output
- Ask clarifying questions in a comment

## Commands
```bash
# STEP 1: Write triage output file (DO THIS FIRST!)
cat > triage-output.json << 'EOF'
{
  "type": "enhancement",
  "priority": "medium",
  "size": "m",
  "estimate": 5,
  "topics": ["cli_core", "docker_builds"],
  "needs_info": false
}
EOF

# Verify the file was created correctly
cat triage-output.json

# View current issue
gh issue view {{ISSUE_NUMBER}}

# Update issue body with PHASES (use heredoc for multiline)
gh issue edit {{ISSUE_NUMBER}} --body "$(cat <<'EOF'
## Description
Brief TLDR of the issue.

## Details
Technical context, affected files, links to docs.

## Questions
- [x] Question 1? Answer here.

## Phase 1: Schema & Setup
- [ ] Task 1 for phase 1
- [ ] Task 2 for phase 1

## Phase 2: Core Implementation
- [ ] Task 1 for phase 2
- [ ] Task 2 for phase 2

## Phase 3: Integration & Polish
- [ ] Task 1 for phase 3
- [ ] Task 2 for phase 3
EOF
)"

# List existing topic labels (to reuse existing topics)
gh label list --search "topic:" --json name --jq '.[].name'

# Post a comment (for suggesting splits or asking questions)
gh issue comment {{ISSUE_NUMBER}} --body "Your comment here..."
```

IMPORTANT:
- You MUST write triage-output.json - the workflow step reads your JSON and applies them
- DO NOT add labels yourself - the workflow step reads your JSON and applies them
- DO NOT assign the issue to anyone
- DO NOT create sub-issues - if work is too large, suggest the user split into smaller issues
- Focus on making the issue clear and actionable for implementation
- Use PHASES (## Phase N: Title) for M/L/XL issues - each phase ships as a separate PR
- Keep phases independently shippable - no broken states between phases
- Maximum 5 phases; if more needed, suggest splitting the issue
- XS/S issues can use a single "## Todo" section instead of phases
