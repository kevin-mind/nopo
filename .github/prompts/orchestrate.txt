Orchestrate sub-issues for main issue #{{ISSUE_NUMBER}}: "{{ISSUE_TITLE}}"

## Main Issue Overview
{{ISSUE_BODY}}

## Sub-Issues
Current sub-issues: {{SUB_ISSUES}}

## Instructions

You are the orchestrator for this main issue which has been broken into sub-issues (phases).
Your job is to manage the progression of work across sub-issues.

### 1. Check Current State

Read the main issue state from the issue body:
```bash
gh issue view {{ISSUE_NUMBER}} --json body -q '.body'
```

Look for the `CLAUDE_MAIN_STATE` block to understand:
- Which sub-issues exist
- Current sub-issue being worked on
- Status of each sub-issue (pending, in_progress, merged)
- Whether all work is complete

### 2. Determine Next Action

**If no sub-issue is currently in progress:**
- Find the first sub-issue with status `pending`
- Assign `nopo-bot` to that sub-issue to start work

**If a sub-issue is currently in progress:**
- Check if its PR has been merged
- If merged, update status to `merged` and find next pending sub-issue
- Assign `nopo-bot` to the next sub-issue

**If all sub-issues are merged:**
- Mark the main issue as complete
- Close the main issue with a completion comment

### 3. Update Main Issue State

After any state change, update the main issue body with the new state:

```bash
# Read current body
gh issue view {{ISSUE_NUMBER}} --json body -q '.body' > /tmp/issue_body.md

# Update the CLAUDE_MAIN_STATE block with new values
# Then save back:
gh issue edit {{ISSUE_NUMBER}} --body-file /tmp/issue_body.md
```

### 4. Assign Next Sub-Issue

To assign nopo-bot to a sub-issue:
```bash
gh issue edit <SUB_ISSUE_NUMBER> --add-assignee nopo-bot
```

This will trigger the iteration loop for that sub-issue.

### 5. Check Sub-Issue PR Status

To check if a sub-issue's PR has been merged:
```bash
# Get PRs that mention the sub-issue
gh pr list --search "in:body Fixes #<SUB_ISSUE_NUMBER>" --state merged --json number
```

Or check if the sub-issue is closed:
```bash
gh issue view <SUB_ISSUE_NUMBER> --json state -q '.state'
```

## Commands Reference

```bash
# View main issue
gh issue view {{ISSUE_NUMBER}}

# View sub-issue
gh issue view <SUB_ISSUE_NUMBER>

# Assign nopo-bot to sub-issue
gh issue edit <SUB_ISSUE_NUMBER> --add-assignee nopo-bot

# Check if PR merged
gh pr list --search "in:body Fixes #<SUB_ISSUE_NUMBER>" --state merged --json number

# Update main issue body
gh issue edit {{ISSUE_NUMBER}} --body-file /tmp/issue_body.md

# Close main issue as complete
gh issue close {{ISSUE_NUMBER}} --comment "All phases complete!"
```

## State Format

The CLAUDE_MAIN_STATE block in the main issue body:
```yaml
<!-- CLAUDE_MAIN_STATE
orchestration_iteration: <number>
sub_issues: [123, 124, 125]
current_sub_issue: 124
sub_issue_status: {"123": "merged", "124": "in_progress", "125": "pending"}
complete: false
-->
```

## Important Notes

- Do NOT start work on sub-issues directly - assign nopo-bot and let iteration handle it
- Each sub-issue has its own branch and PR
- Sub-issue PRs link to both the sub-issue AND the main issue
- When a sub-issue's PR is merged, it closes the sub-issue automatically
- The main issue stays open until ALL sub-issues are complete
- Always update the phases table in the main issue body when statuses change

## Phases Table Format

Update the phases table when statuses change:
```markdown
## Phases

| # | Sub-Issue | Status |
|---|-----------|--------|
| 1 | #123 | merged |
| 2 | #124 | in_progress |
| 3 | #125 | pending |
```

Status values:
- `pending` - Not started
- `in_progress` - nopo-bot assigned, work happening
- `merged` - PR merged, phase complete
