Implement issue #{{ISSUE_NUMBER}}: "{{ISSUE_TITLE}}"

## Current Iteration State
- **Iteration**: {{ITERATION}}
- **Previous CI Result**: {{LAST_CI_RESULT}}
- **Consecutive Failures**: {{CONSECUTIVE_FAILURES}}
- **Branch**: `{{BRANCH_NAME}}`

{{ISSUE_BODY}}

{{EXISTING_BRANCH_SECTION}}

## Instructions

This is iteration {{ITERATION}} of the implementation loop. Your goal: make **incremental progress** toward completing the issue. **Do NOT try to complete everything at once.**

### CRITICAL: Incremental Progress Only

**You must NOT attempt to complete all Todo items in a single iteration.** Each iteration should:
- Complete **ONE small, focused change** (one Todo item or a small logical unit)
- **Verify locally using nopo commands** before pushing
- Let CI run and trigger the next iteration

This iterative approach allows for:
- Early detection of issues
- Easier debugging when things fail
- Better tracking of progress

### 1. Understand Current State

First, analyze:
- `git status` and `git log -3` to see branch state
- Previous CI result above (if any)
- Which Todo items are checked vs unchecked

### 2. Determine What to Do

**If previous CI failed (LAST_CI_RESULT = failure)**:
- Focus on fixing the CI errors first
- Run `make check` and `make test` to reproduce the failure locally
- Fix the issues, verify locally, then commit

**If previous CI passed OR this is the first iteration**:
- Pick the **next single unchecked Todo item** in the issue
- Focus on completing **just that one item**
- Do NOT try to complete multiple items at once

**If all Todos appear done and CI passed**:
- Verify all requirements are met
- Ensure tests exist and pass
- The workflow will handle marking complete

### 3. Implementation Guidelines

1. **Read each file before editing** - the Edit tool requires this
2. **If an edit fails, re-read the file** - it may already be modified
3. **Never repeat a failed edit** - if text not found, the change is likely done
4. Follow CLAUDE.md guidelines strictly
5. Keep changes **small and focused** - one logical change per iteration

### 4. Verify Locally BEFORE Committing (CRITICAL)

**ALWAYS run these commands before committing and after each significant code change:**
```bash
make check    # Lint + type check all code
make test     # Run all tests
make fix      # Auto-fix formatting issues (also runs on pre-commit hook)
```

**STOP AND FIX if any command fails.** Do NOT commit broken code.

**Workflow:**
1. Make your code change
2. Run `make check` - fix any errors
3. Run `make test` - fix any failures
4. Then commit (pre-commit hook runs `make fix` automatically)
5. Push only after local verification passes

This is critical because:
- CI failures waste time and iteration count
- Local verification catches issues faster
- Each failed CI counts toward the retry limit (max 5)
- The pre-commit hook will run `make fix` automatically

### 5. Update Todo Progress

After completing a Todo item, update the issue body to check it off:

```bash
# Read current issue body, update the checkbox, and save
gh issue view {{ISSUE_NUMBER}} --json body -q '.body' > /tmp/issue_body.md
# Edit /tmp/issue_body.md to change `- [ ] <item>` to `- [x] <item>`
gh issue edit {{ISSUE_NUMBER}} --body-file /tmp/issue_body.md
```

This helps track progress and shows what's been accomplished.

### 6. Commit and Push

- Commit with a descriptive message referencing the issue
- Push to origin
- The workflow will handle the rest (CI, next iteration trigger)

### 7. Create PR (First Iteration Only)

If no PR exists yet:
```bash
gh pr create --draft --reviewer nopo-bot \
  --title "{{ISSUE_TITLE}}" \
  --body "Fixes #{{ISSUE_NUMBER}}"
```

## Important Notes

- Focus on ONE logical change per iteration
- The workflow will automatically trigger the next iteration after CI completes
- You do NOT need to update the iteration state block - the workflow handles it
- **DO update Todo checkboxes** after completing each item (see section 5)
- `make check` and `make test` are mandatory verification steps, NOT separate Todo items
- If you're blocked and can't make progress, commit a comment explaining why
- If you notice conflicts with other open PRs, note them in the PR description
