Implement issue #{{ISSUE_NUMBER}}: "{{ISSUE_TITLE}}"

## Current State
- **Iteration**: {{ITERATION}}
- **Previous CI Result**: {{LAST_CI_RESULT}}
- **Consecutive Failures**: {{CONSECUTIVE_FAILURES}}
- **Branch**: `{{BRANCH_NAME}}`
{{PARENT_CONTEXT}}

## Previous Agent Notes

{{AGENT_NOTES}}

---

{{ISSUE_BODY}}

{{EXISTING_BRANCH_SECTION}}

## Instructions

This is iteration {{ITERATION}}. Make **incremental progress** - do NOT try to complete everything at once.

### 1. Assess Current State

```bash
git status && git log --oneline -3
```

Check which todos are done vs pending.

### 2. Determine Action

**If CI failed** (`LAST_CI_RESULT = failure`):
- Run `make check && make test` to reproduce locally
- Fix the issues, verify, commit

**If CI passed or first iteration**:
- Pick the **next unchecked todo**
- Complete **just that one item**

**If next todo has `[Manual]` prefix**:
- These require human action (testing, verification, etc.)
- **EXIT IMMEDIATELY** - do not attempt to complete it
- Output: "Waiting for human to complete manual todo: [todo text]"
- A human will complete the task, check it off, and re-trigger the workflow

**If all todos done and CI passed**:
- Workflow handles marking PR ready and requesting review

### 3. Implementation

1. Read files before editing
2. Follow CLAUDE.md guidelines
3. Keep changes small and focused

### 4. Verify Before Committing

```bash
make check && make test
```

**STOP if any command fails.** Fix before committing.

### 5. Update Todo Progress

After completing a todo, update the issue:
```bash
gh issue view {{ISSUE_NUMBER}} --json body -q '.body' > /tmp/issue_body.md
# Edit to change `- [ ] item` to `- [x] item`
gh issue edit {{ISSUE_NUMBER}} --body-file /tmp/issue_body.md
```

### 6. Commit and Push

Commit with descriptive message, push to origin. Workflow handles the rest.

### 7. Create PR (First Iteration Only)

If no PR exists:
{{PR_CREATE_COMMAND}}

## Notes

- Focus on ONE logical change per iteration
- Workflow triggers next iteration after CI
- Update todo checkboxes after completing each
- If blocked, commit a comment explaining why

### Save Notes for Future Iterations

Before finishing, save any important discoveries or decisions for future iterations by writing to `/tmp/claude-notes.json`:

```json
{
  "issue_number": {{ISSUE_NUMBER}},
  "run_id": 0,
  "timestamp": "",
  "agent": "iterate",
  "phase": {{ITERATION}},
  "notes": [
    "Note 1: Implementation detail or discovery",
    "Note 2: Trade-off or decision made"
  ]
}
```

Good notes include:
- Implementation details not obvious from code
- Trade-offs and why a specific approach was chosen
- Roadblocks encountered and how resolved
- Relevant discoveries about the codebase
- Known issues or concerns for future work
