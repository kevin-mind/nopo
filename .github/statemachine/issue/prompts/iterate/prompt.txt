Implement issue #{{ISSUE_NUMBER}}: "{{ISSUE_TITLE}}"

## Current State
- **Iteration**: {{ITERATION}}
- **Previous CI Result**: {{LAST_CI_RESULT}}
- **Consecutive Failures**: {{CONSECUTIVE_FAILURES}}
- **Branch**: `{{BRANCH_NAME}}`
{{PARENT_CONTEXT}}

## Previous Agent Notes

{{AGENT_NOTES}}

---

{{ISSUE_BODY}}

{{EXISTING_BRANCH_SECTION}}

## Instructions

This is iteration {{ITERATION}}. Make **incremental progress** - do NOT try to complete everything at once.

### 1. Assess Current State

```bash
git status && git log --oneline -3
```

Check which todos are done vs pending.

### 1.5. Check for Conflicts with Main

**Before doing any work**, check if your branch has conflicts with main:

```bash
git fetch origin main
git merge-base --is-ancestor origin/main HEAD && echo "Up to date" || echo "Behind main"
```

**If behind main**, try to rebase:

```bash
git rebase origin/main
```

**If rebase fails with conflicts**:
1. Check the conflict severity: `git diff --name-only --diff-filter=U`
2. If conflicts are in files YOU modified, try to resolve them
3. If conflicts are in files you didn't touch or are too complex:
   - Abort the rebase: `git rebase --abort`
   - Set status to `blocked` with `blocked_reason: "Merge conflicts with main that require human intervention. Conflicting files: [list them]"`
   - **Do NOT waste iterations on unresolvable conflicts**

**Simple conflicts** (your changes + main changes in different parts of same file):
- Resolve by keeping both changes appropriately
- `git add <file>` and `git rebase --continue`

**Complex conflicts** (overlapping changes, structural refactors, deleted files):
- These need human judgment - set status to `blocked` immediately

### 2. Determine Action

**If CI failed** (`LAST_CI_RESULT = failure`):
- Run `make check && make test` to reproduce locally
- Fix the issues, verify, commit

**If CI passed or first iteration**:
- Review unchecked todos (those without `[x]`)
- Implement what makes sense for this iteration
- Return `status: "completed_todo"` with the todos you completed
- You don't need to complete everything in one iteration - make reasonable progress

**If next unchecked todo has `[Manual]` prefix**:
- These require human action (testing, verification, etc.)
- **EXIT IMMEDIATELY** - do not attempt to complete it
- Set status to `waiting_manual` with the todo text in `manual_todo`
- A human will complete the task, check it off, and re-trigger the workflow

**If all non-manual todos are checked off and CI passed**:
- Set status to `all_done`
- Workflow handles marking PR ready and requesting review

### 3. Implementation

**IMPORTANT: Use Task Tool Delegation for All Code Changes**

You MUST delegate all implementation and fix work to the full-stack-engineer sub-agent. Never directly edit or write code files yourself.

**How to delegate:**

1. **Before implementing or fixing**, invoke the full-stack-engineer sub-agent using the Task tool:

   ```
   Use Task tool with:
   - subagent_type: "full-stack-engineer"
   - description: Brief summary (3-5 words) of what needs to be done
   - prompt: Provide full context including:
     * Issue #{{ISSUE_NUMBER}}: {{ISSUE_TITLE}}
     * Current iteration: {{ITERATION}}
     * Specific todo(s) to complete
     * Relevant files and context
     * Any CI failures to fix
   ```

2. **Your responsibilities** (read-only operations):
   - Assess current state (git status, git log, git diff)
   - Run validation (make check, make test)
   - View PR status (gh pr view, gh pr list)
   - Read files to understand context
   - Analyze CI failures
   - Coordinate sub-agent work

3. **Sub-agent responsibilities** (write operations):
   - Read files before editing
   - Implement features and fixes
   - Edit and write code files
   - Commit changes with descriptive messages
   - Follow CLAUDE.md guidelines
   - Keep changes small and focused

**Example delegation:**

When you need to implement a feature or fix a bug, use:

```
Task tool:
  subagent_type: full-stack-engineer
  description: "Implement login validation"
  prompt: |
    Implement issue #{{ISSUE_NUMBER}}: {{ISSUE_TITLE}}

    Current state: Iteration {{ITERATION}}, {{LAST_CI_RESULT}}

    Complete this todo:
    - Add login form validation with email format check

    Context:
    - Login form is in apps/web/src/components/LoginForm.tsx
    - Validation utilities are in apps/web/src/utils/validation.ts

    Requirements:
    - Read files before editing
    - Follow CLAUDE.md patterns
    - Run 'make check && make test' before committing
    - Commit with descriptive message
```

After the sub-agent completes, verify the changes and proceed to step 4 (Verify Before Committing).

### 4. Verify Before Committing

```bash
make check && make test
```

**STOP if any command fails.** Fix before committing.

### 5. Commit and Push

Commit with descriptive message, push to origin. Workflow handles the rest.

### 6. Create PR (First Iteration Only)

If no PR exists:
{{PR_CREATE_COMMAND}}

## Output

Return structured JSON with:

- **status**: What happened this iteration
  - `completed_todo` - A todo item is satisfied (code exists OR you just implemented it)
  - `waiting_manual` - Next unchecked todo has `[Manual]` prefix
  - `blocked` - Cannot proceed (explain in blocked_reason)
  - `all_done` - All non-manual todos are checked off, ready for review

- **todos_completed**: List of todos that are now satisfied (if status=completed_todo)
  - Copy the todo text EXACTLY as it appears in the issue (without the `- [ ]` prefix)
  - Example: ["Add login form validation", "Add error handling for invalid input"]
  - The executor will check these off in the issue body

- **manual_todo**: The **exact text** of the manual todo (if status=waiting_manual)
  - Only use this when the NEXT unchecked todo has `[Manual]` prefix

- **blocked_reason**: Explanation if status=blocked

- **agent_notes**: Important discoveries for future iterations (stored in history)

The executor will:
- Check off todos_completed in the issue body (matches fuzzy, so slight differences OK)
- Store agent_notes in iteration history
- Handle PR ready state transitions based on status
