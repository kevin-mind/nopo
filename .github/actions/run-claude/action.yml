name: Run Claude
description: Load prompt and run Claude Code via npx

inputs:
  # Prompt inputs (one of prompt, prompt_file, or prompt_dir is required)
  prompt:
    description: Direct prompt string
    required: false
    default: ""
  prompt_file:
    description: Path to the prompt file (relative to repository root) - legacy
    required: false
    default: ""
  prompt_dir:
    description: "Prompt directory name (resolved to .github/prompts/{name}/) - new style with optional outputs.json schema"
    required: false
    default: ""
  prompt_replacements:
    description: "JSON object of template replacements for prompt (e.g., '{\"ISSUE_NUMBER\": \"123\"}')"
    required: false
    default: "{}"

  # Required tokens
  github_token:
    description: GitHub token for API calls
    required: true
  claude_code_oauth_token:
    description: OAuth token for Claude Code
    required: true

  # Claude configuration
  model:
    description: Claude model to use
    required: false
    default: "claude-opus-4-5-20251101"
  max_turns:
    description: Maximum number of API round-trips
    required: false
    default: "50"
  settings:
    description: Path to settings file
    required: false
    default: ".claude/settings.json"
  mcp_config:
    description: Path to MCP configuration file
    required: false
    default: ".mcp.json"

outputs:
  success:
    description: Whether Claude completed successfully
    value: ${{ steps.result.outputs.success }}
  structured_output:
    description: Structured JSON output if outputs.json schema was used
    value: ${{ steps.claude.outputs.structured_output }}

runs:
  using: "composite"
  steps:
    # Step 1: Load and process prompt
    - name: Load prompt
      id: prompt
      shell: bash
      env:
        PROMPT: ${{ inputs.prompt }}
        PROMPT_FILE: ${{ inputs.prompt_file }}
        PROMPT_DIR: ${{ inputs.prompt_dir }}
        PROMPT_REPLACEMENTS: ${{ inputs.prompt_replacements }}
      run: |
        prompt=""
        output_schema=""

        # Use direct prompt if provided
        if [[ -n "$PROMPT" ]]; then
          prompt="$PROMPT"
        # Use prompt directory (new style: .github/prompts/{name}/)
        elif [[ -n "$PROMPT_DIR" ]]; then
          prompt_path=".github/prompts/$PROMPT_DIR/prompt.txt"
          schema_path=".github/prompts/$PROMPT_DIR/outputs.json"

          if [[ ! -f "$prompt_path" ]]; then
            echo "Error: Prompt file not found: $prompt_path"
            exit 1
          fi
          prompt=$(cat "$prompt_path")

          # Check for outputs.json schema
          if [[ -f "$schema_path" ]]; then
            echo "Found output schema: $schema_path"
            output_schema=$(cat "$schema_path" | jq -c .)
          fi
        # Use prompt file (legacy style)
        elif [[ -n "$PROMPT_FILE" ]]; then
          if [[ ! -f "$PROMPT_FILE" ]]; then
            echo "Error: Prompt file not found: $PROMPT_FILE"
            exit 1
          fi
          prompt=$(cat "$PROMPT_FILE")
        else
          echo "Error: One of prompt, prompt_file, or prompt_dir must be provided"
          exit 1
        fi

        # Apply template replacements from JSON
        if [[ "$PROMPT_REPLACEMENTS" != "{}" ]]; then
          while IFS='=' read -r key value; do
            # Remove quotes from value if present
            value="${value%\"}"
            value="${value#\"}"
            # Replace {{KEY}} with value
            prompt="${prompt//\{\{$key\}\}/$value}"
          done < <(echo "$PROMPT_REPLACEMENTS" | jq -r 'to_entries[] | "\(.key)=\(.value)"')
        fi

        # Save prompt to file (avoids shell escaping issues)
        echo "$prompt" > /tmp/claude-prompt.txt
        echo "prompt_file=/tmp/claude-prompt.txt" >> "$GITHUB_OUTPUT"

        # Save schema if found
        if [[ -n "$output_schema" ]]; then
          echo "$output_schema" > /tmp/claude-schema.json
          echo "has_schema=true" >> "$GITHUB_OUTPUT"
        fi

    # Step 2: Install Claude CLI first (avoids npm output mixing with JSON)
    - name: Install Claude CLI
      shell: bash
      run: npm install -g @anthropic-ai/claude-code

    # Step 3: Run Claude
    - name: Run Claude
      id: claude
      shell: bash
      env:
        CLAUDE_CODE_OAUTH_TOKEN: ${{ inputs.claude_code_oauth_token }}
        GITHUB_TOKEN: ${{ inputs.github_token }}
      run: |
        # Read prompt from file
        PROMPT=$(cat "${{ steps.prompt.outputs.prompt_file }}")

        # Build command array (avoids quoting issues)
        CMD=(claude
          --print
          --dangerously-skip-permissions
          --output-format json
          --model "${{ inputs.model }}"
          --max-turns "${{ inputs.max_turns }}"
        )

        # Add MCP config if file exists
        if [[ -n "${{ inputs.mcp_config }}" && -f "${{ inputs.mcp_config }}" ]]; then
          CMD+=(--mcp-config "${{ inputs.mcp_config }}")
        fi

        # Add JSON schema if present
        if [[ "${{ steps.prompt.outputs.has_schema }}" == "true" ]]; then
          SCHEMA=$(cat /tmp/claude-schema.json)
          CMD+=(--json-schema "$SCHEMA")
        fi

        echo "Running Claude CLI..."
        OUTPUT_FILE="claude-output.json"

        # Run Claude and capture output
        if "${CMD[@]}" "$PROMPT" > "$OUTPUT_FILE" 2>&1; then
          echo "::group::Raw Output"
          cat "$OUTPUT_FILE"
          echo "::endgroup::"

          # Extract structured_output if present
          if [[ "${{ steps.prompt.outputs.has_schema }}" == "true" ]]; then
            if jq -e '.structured_output' "$OUTPUT_FILE" > /dev/null 2>&1; then
              jq '.structured_output' "$OUTPUT_FILE" > claude-structured-output.json
              echo "::group::Structured Output"
              jq . claude-structured-output.json
              echo "::endgroup::"

              # Set structured output
              {
                echo "structured_output<<EOF_STRUCTURED"
                cat claude-structured-output.json
                echo "EOF_STRUCTURED"
              } >> "$GITHUB_OUTPUT"
            else
              echo "::warning::Expected structured_output but not found in response"
              echo "File contents:"
              head -c 500 "$OUTPUT_FILE"
            fi
          fi

          echo "success=true" >> "$GITHUB_OUTPUT"
        else
          echo "::error::Claude CLI failed"
          echo "::group::Error Output"
          cat "$OUTPUT_FILE"
          echo "::endgroup::"
          echo "success=false" >> "$GITHUB_OUTPUT"
          exit 1
        fi

    # Step 4: Set result output
    - name: Set result
      id: result
      if: always()
      shell: bash
      run: |
        if [[ "${{ steps.claude.outcome }}" == "success" ]]; then
          echo "success=true" >> "$GITHUB_OUTPUT"
        else
          echo "success=false" >> "$GITHUB_OUTPUT"
        fi
